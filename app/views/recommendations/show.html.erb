<% content_for :title, @contextual_title %>

<% content_for :header do %>
  <header class="app-header">
    <%= link_to home_path, class: "app-header__back" do %>
      <i class="bi bi-chevron-left"></i>
    <% end %>
    <h1 class="app-header__title"><%= t('views.recommendations.back', default: 'Volver') %></h1>
    <div></div>
  </header>
<% end %>

<%
  slug_key = @recommendation.slug.underscore
  inf = current_user.influencer || Influencer.default_influencer
  video_url = case @recommendation.slug
    when "better-bank-account" then inf&.video_compte
    when "emergency-deposit" then inf&.video_cdiposit
    when "ac-diposit" then inf&.video_diposit
    when "debt-optimization" then inf&.video_deute
    when "saving-advice" then inf&.video_saving
    when "ac-llarg" then inf&.video_llarg
    when "ac-curt" then inf&.video_curt
    when "ac-jubil" then inf&.video_jubil
    when "tax-advisory" then inf&.video_fiscal
    when "portfolio-optimization" then inf&.video_portfolio
    when "mortgage-optimization" then inf&.video_mortgage
    else @recommendation.video_url
  end
%>

<div class="app-container">

  <!-- ===== ABOVE THE FOLD ===== -->

  <!-- 1. TITLE -->
  <h2 class="rec-title">
    <%= t("views.recommendations.heroes.#{slug_key}.title", default: @contextual_title) %>
  </h2>

  <!-- Objective context (if coming from an objective) -->
  <% if @simulator_data[:has_objective] %>
    <div class="rec-objective-context">
      <i class="bi bi-bullseye"></i>
      <span>
        <strong><%= @simulator_data[:objective_name] %></strong>
        &middot; <%= number_to_currency(@simulator_data[:target_amount], locale: I18n.locale) %>
        &middot; <%= @simulator_data[:years] %> <%= t('views.recommendations.years') %>
        &middot; <%= number_to_currency(@simulator_data[:monthly_contribution], locale: I18n.locale) %><%= t('home.objectives.per_month', default: '/mes') %>
      </span>
    </div>
  <% end %>

  <!-- 3. VIDEO -->
  <% if video_url.present? %>
    <div class="rec-video mb-3">
      <div class="ratio ratio-16x9">
        <iframe src="<%= video_url %>" allowfullscreen></iframe>
      </div>
    </div>
  <% end %>

  <!-- 4. CTA PRIMARY -->
  <% if @affiliate_link.present? %>
    <a href="<%= @affiliate_link %>" target="_blank"
       style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 1rem 1.5rem; font-size: 1.0625rem; font-weight: 700; color: #fff; background: linear-gradient(135deg, #1d7a8c, #165668); border-radius: 12px; text-decoration: none; box-shadow: 0 4px 16px rgba(22,86,104,0.4); letter-spacing: 0.02em;">
      <i class="bi bi-box-arrow-up-right"></i>
      <%= t("views.recommendations.ctas.#{slug_key}", default: t('views.recommendations.ctas.default')) %>
    </a>
  <% else %>
    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 1rem 1.5rem; font-size: 1.0625rem; font-weight: 700; color: #9ca3af; background: #f3f4f6; border-radius: 12px;">
      <i class="bi bi-clock"></i>
      <%= t('views.recommendations.coming_soon_button') %>
    </div>
  <% end %>
  <p style="text-align: center; font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;"><%= t('views.recommendations.process_secure') %></p>

  <div class="rec-divider"></div>

  <!-- ===== BELOW THE FOLD ===== -->

  <!-- 5. CONTENT SECTION (simulator or educational) -->
  <% if @recommendation.slug == "ac-llarg" || @recommendation.slug == "ac-curt" || @recommendation.slug == "ac-jubil" %>
    <!-- ========== MOTIVATIONAL TEXT ========== -->
    <% simulator_key = @recommendation.slug.underscore %>
    <p class="rec-body-text">
      <%= t("views.recommendations.pages.#{simulator_key}.motivational_text") %>
    </p>

    <!-- ========== INVESTMENT SIMULATOR ========== -->
    <div class="rec-simulator">
      <div class="rec-simulator__title">
        <i class="bi bi-calculator"></i>
        <%= t("views.recommendations.simulator.title.#{simulator_key}") %>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulator.labels.initial_contribution') %></div>
      <div class="rec-simulator__row" style="gap: 0;">
        <div style="position: relative; flex: 1;">
          <input type="number" id="initialContribution"
                 min="0" step="500" value="<%= @simulator_data[:initial_contribution] %>"
                 class="form-control" style="font-size: 0.875rem; padding-right: 2rem; height: 2.25rem;">
          <span style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); font-size: 0.875rem; color: #6b7280; pointer-events: none;">&euro;</span>
        </div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulator.labels.monthly_contribution') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="monthlyContribution"
               min="50" max="1000" step="50" value="<%= @simulator_data[:monthly_contribution] %>">
        <div class="rec-simulator__value"><span id="monthlyValue"><%= @simulator_data[:monthly_contribution] %></span>&euro;</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulator.labels.years_investing') %></div>
      <div class="rec-simulator__row">
        <% if @recommendation.slug == "ac-curt" %>
          <input type="range" class="app-slider__input rec-simulator__slider" id="years"
                 min="1" max="5" step="1" value="<%= @simulator_data[:years] %>">
        <% elsif @recommendation.slug == "ac-jubil" %>
          <input type="range" class="app-slider__input rec-simulator__slider" id="years"
                 min="10" max="40" step="1" value="<%= @simulator_data[:years] %>">
        <% else %>
          <input type="range" class="app-slider__input rec-simulator__slider" id="years"
                 min="5" max="40" step="1" value="<%= @simulator_data[:years] %>">
        <% end %>
        <div class="rec-simulator__value"><span id="yearsValue"><%= @simulator_data[:years] %></span> <%= t('views.recommendations.simulator.labels.years') %></div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulator.labels.expected_return') %></div>
      <div class="rec-simulator__row">
        <% if @recommendation.slug == "ac-curt" %>
          <input type="range" class="app-slider__input rec-simulator__slider" id="returnRate"
                 min="0.5" max="5" step="0.5" value="<%= @simulator_data[:annual_return] %>">
        <% else %>
          <input type="range" class="app-slider__input rec-simulator__slider" id="returnRate"
                 min="4" max="12" step="0.5" value="<%= @simulator_data[:annual_return] %>">
        <% end %>
        <div class="rec-simulator__value"><span id="returnValue"><%= @simulator_data[:annual_return] %></span>%</div>
      </div>

      <!-- Chart -->
      <div class="bg-white rounded p-2 mt-3" style="min-height: 280px;">
        <canvas id="retirementChart"></canvas>
      </div>
      <p class="text-center mt-1 mb-0" style="font-size: 0.7rem; color: #9ca3af;">
        <span style="color: #0d6efd;">&#9632;</span> <%= t('views.recommendations.simulator.chart.savings_label') %>
        <span class="ms-2" style="color: #198754;">&#9632;</span> <%= t('views.recommendations.simulator.chart.investment_label') %>
        <span class="ms-2" style="color: rgba(25,135,84,0.25);">&#9632;</span> <%= t('views.recommendations.simulator.chart.volatility_range_label') %>
      </p>

      <!-- Risk warning (shown/hidden by JS) -->
      <div id="riskWarning" style="display: none; margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; font-size: 0.8125rem; color: #dc2626; text-align: center;">
        <i class="bi bi-exclamation-triangle me-1"></i>
        <span id="riskWarningText"></span>
      </div>

      <!-- Results -->
      <div class="rec-simulator__results-grid rec-simulator__results-grid--trio">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulator.results.final_capital') %></div>
          <div class="rec-simulator__highlight"><span id="finalCapital">0</span>&euro;</div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulator.results.total_contributed') %></div>
          <div class="rec-simulator__highlight" style="color: #0d6efd;"><span id="totalContributed">0</span>&euro;</div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulator.results.profit') %></div>
          <div class="rec-simulator__highlight" style="color: #f59e0b;"><span id="profit">0</span>&euro;</div>
        </div>
      </div>

      <p class="app-disclaimer mt-3 mb-0" style="font-size: 0.7rem;"><i class="bi bi-info-circle me-1"></i><%= t('views.recommendations.simulator.disclaimer_html').html_safe %></p>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <div id="simulator-i18n"
         data-savings-label="<%= t('views.recommendations.simulator.chart.savings_label') %>"
         data-investment-label="<%= t('views.recommendations.simulator.chart.investment_label') %>"
         data-volatility-range-label="<%= t('views.recommendations.simulator.chart.volatility_range_label') %>"
         data-risk-warning="<%= t('views.recommendations.simulator.chart.risk_warning_short_term') %>"
         data-slug="<%= @recommendation.slug %>"
         style="display: none;"></div>

    <script>
      if (window._retirementChart) {
        window._retirementChart.destroy();
        window._retirementChart = null;
      }
      var retirementChart = null;

      var VOLATILITY = {
        'ac-curt': 0.04,
        'ac-llarg': 0.16,
        'ac-jubil': 0.16
      };

      function formatNumber(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      function createOrUpdateChart(labels, savingsData, investmentData, lowerBandData, upperBandData) {
        var ctx = document.getElementById('retirementChart');
        if (!ctx) return;

        if (retirementChart) {
          retirementChart.data.labels = labels;
          retirementChart.data.datasets[0].data = savingsData;
          retirementChart.data.datasets[1].data = lowerBandData;
          retirementChart.data.datasets[2].data = investmentData;
          retirementChart.data.datasets[3].data = upperBandData;
          retirementChart.update();
        } else {
          var i18nData = document.getElementById('simulator-i18n');
          var savingsLabel = i18nData ? i18nData.dataset.savingsLabel : 'Savings';
          var investmentLabel = i18nData ? i18nData.dataset.investmentLabel : 'Investment';
          var rangeLabel = i18nData ? i18nData.dataset.volatilityRangeLabel : 'Probable range';

          retirementChart = window._retirementChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: savingsLabel,
                  data: savingsData,
                  borderColor: '#0d6efd',
                  backgroundColor: 'rgba(13, 110, 253, 0.1)',
                  tension: 0.1,
                  fill: 'origin',
                  borderWidth: 2,
                  pointRadius: 0
                },
                {
                  label: rangeLabel + ' (min)',
                  data: lowerBandData,
                  borderColor: 'rgba(25, 135, 84, 0.25)',
                  backgroundColor: 'transparent',
                  tension: 0.1,
                  fill: false,
                  borderWidth: 1,
                  borderDash: [4, 4],
                  pointRadius: 0
                },
                {
                  label: investmentLabel,
                  data: investmentData,
                  borderColor: '#198754',
                  backgroundColor: 'transparent',
                  tension: 0.1,
                  fill: false,
                  borderWidth: 2,
                  pointRadius: 0
                },
                {
                  label: rangeLabel + ' (max)',
                  data: upperBandData,
                  borderColor: 'rgba(25, 135, 84, 0.25)',
                  backgroundColor: 'rgba(25, 135, 84, 0.08)',
                  tension: 0.1,
                  fill: 1,
                  borderWidth: 1,
                  borderDash: [4, 4],
                  pointRadius: 0
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  filter: function(tooltipItem) {
                    return tooltipItem.datasetIndex === 0 || tooltipItem.datasetIndex === 2;
                  },
                  callbacks: {
                    label: function(context) {
                      return context.dataset.label + ': ' + formatNumber(context.parsed.y) + '\u20AC';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return formatNumber(value) + '\u20AC';
                    }
                  }
                },
                x: {
                  ticks: { maxTicksLimit: 10 }
                }
              }
            }
          });
        }
      }

      function calculateRetirement() {
        var monthly = parseFloat(document.getElementById('monthlyContribution').value);
        var years = parseFloat(document.getElementById('years').value);
        var annualReturn = parseFloat(document.getElementById('returnRate').value) / 100;
        var monthlyReturn = annualReturn / 12;
        var totalMonths = years * 12;
        var initialInput = document.getElementById('initialContribution');
        var initial = initialInput ? parseFloat(initialInput.value) : 0;

        var i18nData = document.getElementById('simulator-i18n');
        var slug = i18nData ? i18nData.dataset.slug : 'ac-llarg';
        var sigma = VOLATILITY[slug] || 0.16;

        var futureValue = 0;
        if (initial > 0) {
          futureValue += initial * Math.pow(1 + monthlyReturn, totalMonths);
        }
        if (monthlyReturn === 0) {
          futureValue += monthly * totalMonths;
        } else {
          futureValue += monthly * (Math.pow(1 + monthlyReturn, totalMonths) - 1) / monthlyReturn;
        }

        var totalContributed = initial + (monthly * totalMonths);
        var profit = futureValue - totalContributed;

        var labels = [];
        var savingsData = [];
        var investmentData = [];
        var upperBandData = [];
        var lowerBandData = [];

        for (var year = 0; year <= years; year++) {
          labels.push(year === 0 ? 'Inicio' : 'A\u00F1o ' + year);
          savingsData.push(initial + (monthly * 12 * year));
          if (year === 0) {
            investmentData.push(initial);
            upperBandData.push(initial);
            lowerBandData.push(initial);
          } else {
            var monthsElapsed = year * 12;
            var initialGrown = initial * Math.pow(1 + monthlyReturn, monthsElapsed);
            var monthlyGrown = 0;
            if (monthlyReturn === 0) {
              monthlyGrown = monthly * monthsElapsed;
            } else {
              monthlyGrown = monthly * (Math.pow(1 + monthlyReturn, monthsElapsed) - 1) / monthlyReturn;
            }
            var expected = Math.round(initialGrown + monthlyGrown);
            investmentData.push(expected);

            var volFactor = sigma * Math.sqrt(year);
            upperBandData.push(Math.round(expected * Math.exp(volFactor)));
            lowerBandData.push(Math.max(0, Math.round(expected * Math.exp(-volFactor))));
          }
        }

        document.getElementById('monthlyValue').textContent = monthly;
        document.getElementById('yearsValue').textContent = years;
        document.getElementById('returnValue').textContent = (annualReturn * 100).toFixed(1).replace('.', ',');
        document.getElementById('finalCapital').textContent = formatNumber(futureValue);
        document.getElementById('totalContributed').textContent = formatNumber(totalContributed);
        document.getElementById('profit').textContent = formatNumber(profit);

        // Risk warning: only show when years >= 5 AND lower band < total contributed
        var riskWarningEl = document.getElementById('riskWarning');
        if (riskWarningEl && lowerBandData.length > 0) {
          var finalLower = lowerBandData[lowerBandData.length - 1];
          if (years >= 5 && finalLower < totalContributed) {
            riskWarningEl.style.display = 'block';
            var warningText = i18nData ? i18nData.dataset.riskWarning : '';
            document.getElementById('riskWarningText').textContent = warningText;
          } else {
            riskWarningEl.style.display = 'none';
          }
        }

        createOrUpdateChart(labels, savingsData, investmentData, lowerBandData, upperBandData);
      }

      function initRetirementSimulator() {
        var monthlyInput = document.getElementById('monthlyContribution');
        var yearsInput = document.getElementById('years');
        var rateInput = document.getElementById('returnRate');
        var initialInput = document.getElementById('initialContribution');

        if (monthlyInput && yearsInput && rateInput) {
          if (!monthlyInput.dataset.bound) {
            monthlyInput.dataset.bound = '1';
            monthlyInput.addEventListener('input', calculateRetirement);
            yearsInput.addEventListener('input', calculateRetirement);
            rateInput.addEventListener('input', calculateRetirement);
            if (initialInput) initialInput.addEventListener('input', calculateRetirement);
          }
          calculateRetirement();
        }
      }

      document.addEventListener('turbo:load', initRetirementSimulator);
      document.addEventListener('turbo:frame-load', initRetirementSimulator);
      document.addEventListener('DOMContentLoaded', initRetirementSimulator);
    </script>

  <% elsif @recommendation.slug == "emergency-deposit" %>
    <!-- ========== EMERGENCY FUND: Motivational text ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.emergency_deposit.motivational_text') %>
    </p>

    <!-- ========== EMERGENCY FUND SIMULATOR (new) ========== -->
    <%
      monthly_expenses = current_user.monthly_expenses || 0
      current_savings = current_user.liquid_assets || 0
      emergency_target = monthly_expenses * 4
      cash_flow = current_user.monthly_cash_flow || 0
      remaining = [emergency_target - current_savings, 0].max
      progress_pct = emergency_target > 0 ? [(current_savings.to_f / emergency_target * 100).round(0), 100].min : 0
      months_needed = (cash_flow > 0 && remaining > 0) ? (remaining.to_f / cash_flow).ceil : 0
    %>
    <div class="rec-simulator">
      <div class="rec-simulator__title">
        <i class="bi bi-shield-check"></i>
        <%= t('views.recommendations.simulators.emergency.title') %>
      </div>

      <div class="rec-simulator__result" style="margin-top: 0;">
        <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.emergency.target') %></div>
        <div class="rec-simulator__highlight"><%= number_to_currency(emergency_target, unit: "\u20AC", precision: 0) %></div>
      </div>

      <div class="rec-simulator__results-grid rec-simulator__results-grid--trio" style="margin-top: 0.75rem;">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.emergency.current') %></div>
          <div style="font-size: 1.125rem; font-weight: 700; color: #3b82f6;"><%= number_to_currency(current_savings, unit: "\u20AC", precision: 0) %></div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.emergency.remaining') %></div>
          <div style="font-size: 1.125rem; font-weight: 700; color: #ef4444;"><%= number_to_currency(remaining, unit: "\u20AC", precision: 0) %></div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.emergency.time_estimate') %></div>
          <div style="font-size: 1.125rem; font-weight: 700; color: #165668;">
            <% if remaining <= 0 %>
              <i class="bi bi-check-circle text-success"></i>
            <% elsif months_needed > 0 %>
              <%= months_needed %> <%= t('views.recommendations.simulators.emergency.months') %>
            <% else %>
              &mdash;
            <% end %>
          </div>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="rec-simulator__progress-wrap">
        <div class="rec-simulator__label"><%= t('views.recommendations.simulators.emergency.progress') %>: <%= progress_pct %>%</div>
        <div class="progress" style="height: 8px;">
          <div class="progress-bar bg-success" style="width: <%= progress_pct %>%"></div>
        </div>
      </div>

      <div style="margin-top: 0.75rem; font-size: 0.8125rem; color: #6b7280;">
        <i class="bi bi-arrow-repeat me-1"></i>
        <%= t('views.recommendations.simulators.emergency.cash_flow_label') %>:
        <strong class="<%= cash_flow > 0 ? 'text-success' : 'text-danger' %>"><%= number_to_currency(cash_flow, unit: "\u20AC", precision: 0) %></strong>
        <% if remaining <= 0 %>
          &mdash; <span class="text-success"><%= t('views.recommendations.simulators.emergency.complete') %></span>
        <% elsif cash_flow <= 0 %>
          &mdash; <span class="text-danger"><%= t('views.recommendations.simulators.emergency.no_savings') %></span>
        <% end %>
      </div>
    </div>

  <% elsif @recommendation.slug == "mortgage-optimization" %>
    <!-- ========== MORTGAGE OPTIMIZATION: Motivational text ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.mortgage_optimization.motivational_text') %>
    </p>

    <!-- ========== MORTGAGE OPTIMIZATION SIMULATOR (new) ========== -->
    <div class="rec-simulator" id="mortgageSimulator">
      <div class="rec-simulator__title">
        <i class="bi bi-house-door"></i>
        <%= t('views.recommendations.simulators.mortgage.title') %>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulators.mortgage.current_payment') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="mortCurrentPayment"
               min="300" max="2000" step="50" value="850">
        <div class="rec-simulator__value"><span id="mortCurrentPaymentVal">850</span>&euro;</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulators.mortgage.current_rate') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="mortCurrentRate"
               min="1" max="6" step="0.1" value="3.5">
        <div class="rec-simulator__value"><span id="mortCurrentRateVal">3.5</span>%</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulators.mortgage.years_remaining') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="mortYears"
               min="5" max="30" step="1" value="20">
        <div class="rec-simulator__value"><span id="mortYearsVal">20</span></div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulators.mortgage.new_rate') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="mortNewRate"
               min="0.5" max="5" step="0.1" value="2.5">
        <div class="rec-simulator__value"><span id="mortNewRateVal">2.5</span>%</div>
      </div>

      <div class="rec-simulator__results-grid rec-simulator__results-grid--trio">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.mortgage.new_payment') %></div>
          <div class="rec-simulator__highlight"><span id="mortNewPayment">0</span>&euro;</div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.mortgage.monthly_savings') %></div>
          <div class="rec-simulator__highlight" style="color: #10b981;"><span id="mortMonthlySavings">0</span>&euro;</div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.mortgage.total_savings') %></div>
          <div class="rec-simulator__highlight" style="color: #10b981;"><span id="mortTotalSavings">0</span>&euro;</div>
        </div>
      </div>
    </div>

    <script>
      function initMortgageSimulator() {
        var paymentEl = document.getElementById('mortCurrentPayment');
        var rateEl = document.getElementById('mortCurrentRate');
        var yearsEl = document.getElementById('mortYears');
        var newRateEl = document.getElementById('mortNewRate');

        if (!paymentEl || !rateEl || !yearsEl || !newRateEl) return;

        function formatNum(num) {
          return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function calculateMortgage() {
          var currentPayment = parseFloat(paymentEl.value);
          var currentRate = parseFloat(rateEl.value) / 100;
          var years = parseInt(yearsEl.value);
          var newRate = parseFloat(newRateEl.value) / 100;
          var totalMonths = years * 12;

          // Calculate outstanding principal from current payment & rate
          var monthlyCurrentRate = currentRate / 12;
          var principal = 0;
          if (monthlyCurrentRate > 0 && totalMonths > 0) {
            principal = currentPayment * (1 - Math.pow(1 + monthlyCurrentRate, -totalMonths)) / monthlyCurrentRate;
          } else if (totalMonths > 0) {
            principal = currentPayment * totalMonths;
          }

          // Calculate new payment
          var monthlyNewRate = newRate / 12;
          var newPayment = 0;
          if (monthlyNewRate > 0 && totalMonths > 0) {
            newPayment = principal * monthlyNewRate * Math.pow(1 + monthlyNewRate, totalMonths) / (Math.pow(1 + monthlyNewRate, totalMonths) - 1);
          } else if (totalMonths > 0) {
            newPayment = principal / totalMonths;
          }

          if (!isFinite(newPayment) || isNaN(newPayment)) newPayment = 0;

          var monthlySavings = currentPayment - newPayment;
          var totalSavings = monthlySavings * totalMonths;

          document.getElementById('mortCurrentPaymentVal').textContent = currentPayment;
          document.getElementById('mortCurrentRateVal').textContent = (currentRate * 100).toFixed(1).replace('.', ',');
          document.getElementById('mortYearsVal').textContent = years;
          document.getElementById('mortNewRateVal').textContent = (newRate * 100).toFixed(1).replace('.', ',');
          document.getElementById('mortNewPayment').textContent = formatNum(newPayment);
          document.getElementById('mortMonthlySavings').textContent = formatNum(Math.max(monthlySavings, 0));
          document.getElementById('mortTotalSavings').textContent = formatNum(Math.max(totalSavings, 0));
        }

        paymentEl.addEventListener('input', calculateMortgage);
        rateEl.addEventListener('input', calculateMortgage);
        yearsEl.addEventListener('input', calculateMortgage);
        newRateEl.addEventListener('input', calculateMortgage);
        calculateMortgage();
      }

      document.addEventListener('turbo:load', initMortgageSimulator);
      document.addEventListener('turbo:frame-load', initMortgageSimulator);
      document.addEventListener('DOMContentLoaded', initMortgageSimulator);
    </script>

  <% elsif @recommendation.slug == "better-bank-account" %>
    <!-- ========== BANK ACCOUNT: Motivational text ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.better_bank_account.motivational_text') %>
    </p>

    <!-- ========== BANK ACCOUNT SIMULATOR (new) ========== -->
    <div class="rec-simulator" id="bankSimulator">
      <div class="rec-simulator__title">
        <i class="bi bi-bank"></i>
        <%= t('views.recommendations.simulators.bank_account.title') %>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulators.bank_account.average_balance') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="bankBalance"
               min="1000" max="50000" step="1000" value="5000">
        <div class="rec-simulator__value"><span id="bankBalanceVal">5.000</span>&euro;</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.simulators.bank_account.remuneration_rate') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="bankRate"
               min="0.5" max="5" step="0.25" value="2.5">
        <div class="rec-simulator__value"><span id="bankRateVal">2,5</span>%</div>
      </div>

      <p class="rec-simulator__note"><%= t('views.recommendations.simulators.bank_account.rate_note') %></p>

      <div class="rec-comparison" style="margin-top: 1rem;">
        <div class="rec-comparison__row">
          <div class="rec-comparison__label"><%= t('views.recommendations.simulators.bank_account.current_return') %></div>
          <div class="rec-comparison__bar" style="background: #e5e7eb; color: #6b7280; width: 10%;">0&euro;</div>
        </div>
        <div class="rec-comparison__row">
          <div class="rec-comparison__label"><%= t('views.recommendations.simulators.bank_account.optimized_return') %></div>
          <div class="rec-comparison__bar" id="bankOptimizedBar" style="background: #10b981; width: 30%;"><span id="bankAnnualGain">125</span>&euro;/<%= t('views.recommendations.year') %></div>
        </div>
      </div>

      <div class="rec-simulator__results-grid">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.bank_account.annual_loss') %></div>
          <div class="rec-simulator__highlight" style="color: #ef4444;"><span id="bankAnnualLoss">125</span>&euro;</div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.simulators.bank_account.in_5_years') %></div>
          <div class="rec-simulator__highlight" style="color: #ef4444;"><span id="bank5YearLoss">625</span>&euro;</div>
        </div>
      </div>
    </div>

    <script>
      function initBankSimulator() {
        var balanceEl = document.getElementById('bankBalance');
        var rateEl = document.getElementById('bankRate');
        if (!balanceEl || !rateEl) return;

        function formatNum(num) {
          return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function calculateBank() {
          var balance = parseFloat(balanceEl.value);
          var rate = parseFloat(rateEl.value) / 100;
          var annualGain = balance * rate;
          var loss5y = annualGain * 5;

          document.getElementById('bankBalanceVal').textContent = formatNum(balance);
          document.getElementById('bankRateVal').textContent = rateEl.value.replace('.', ',');
          document.getElementById('bankAnnualGain').textContent = formatNum(annualGain);
          document.getElementById('bankAnnualLoss').textContent = formatNum(annualGain);
          document.getElementById('bank5YearLoss').textContent = formatNum(loss5y);

          var pct = Math.min(Math.max((balance / 50000) * 100, 15), 100);
          document.getElementById('bankOptimizedBar').style.width = pct + '%';
        }

        balanceEl.addEventListener('input', calculateBank);
        rateEl.addEventListener('input', calculateBank);
        calculateBank();
      }

      document.addEventListener('turbo:load', initBankSimulator);
      document.addEventListener('turbo:frame-load', initBankSimulator);
      document.addEventListener('DOMContentLoaded', initBankSimulator);
    </script>

  <% elsif @recommendation.slug == "debt-optimization" %>
    <!-- ========== DEBT OPTIMIZATION ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.debt_optimization.motivational_text') %>
    </p>

    <p class="rec-body-text">
      <%= t('views.recommendations.pages.debt_optimization.debt_types_explanation') %>
    </p>

    <!-- Debt cost simulator -->
    <%
      user_debt = current_user.expensive_debt rescue 0
      default_debt = user_debt > 0 ? [user_debt.round(-2), 50000].min : 5000
    %>
    <div class="rec-simulator" id="debtSimulator">
      <div class="rec-simulator__title">
        <i class="bi bi-calculator"></i>
        <%= t('views.recommendations.pages.debt_optimization.simulator.title') %>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.debt_optimization.simulator.debt_amount') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="debtAmount"
               min="500" max="50000" step="500" value="<%= default_debt %>">
        <div class="rec-simulator__value"><span id="debtAmountVal"><%= default_debt.to_i.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1.').reverse %></span>&euro;</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.debt_optimization.simulator.interest_rate') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="debtRate"
               min="6" max="20" step="0.5" value="18">
        <div class="rec-simulator__value"><span id="debtRateVal">18,0</span>%</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.debt_optimization.simulator.time_period') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="debtYears"
               min="1" max="10" step="1" value="3">
        <div class="rec-simulator__value"><span id="debtYearsVal">3</span> <%= t('views.recommendations.simulator.labels.years') %></div>
      </div>

      <div class="rec-simulator__results-grid">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.debt_optimization.simulator.total_interest') %></div>
          <div class="rec-simulator__highlight" style="color: #ef4444;"><span id="debtTotalInterest">0</span>&euro;</div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.debt_optimization.simulator.total_payback') %></div>
          <div class="rec-simulator__highlight"><span id="debtTotalPayback">0</span>&euro;</div>
        </div>
      </div>

      <p class="rec-simulator__note"><%= t('views.recommendations.pages.debt_optimization.simulator.note') %></p>
    </div>

    <script>
      function initDebtSimulator() {
        var amountEl = document.getElementById('debtAmount');
        var rateEl = document.getElementById('debtRate');
        var yearsEl = document.getElementById('debtYears');
        if (!amountEl || !rateEl || !yearsEl) return;

        function formatNum(num) {
          return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function calculateDebt() {
          var principal = parseFloat(amountEl.value);
          var annualRate = parseFloat(rateEl.value) / 100;
          var years = parseInt(yearsEl.value);

          // Compound interest: what the debt grows to
          var totalOwed = principal * Math.pow(1 + annualRate, years);
          var totalInterest = totalOwed - principal;

          document.getElementById('debtAmountVal').textContent = formatNum(principal);
          document.getElementById('debtRateVal').textContent = rateEl.value.replace('.', ',');
          document.getElementById('debtYearsVal').textContent = years;
          document.getElementById('debtTotalInterest').textContent = formatNum(totalInterest);
          document.getElementById('debtTotalPayback').textContent = formatNum(totalOwed);
        }

        amountEl.addEventListener('input', calculateDebt);
        rateEl.addEventListener('input', calculateDebt);
        yearsEl.addEventListener('input', calculateDebt);
        calculateDebt();
      }

      document.addEventListener('turbo:load', initDebtSimulator);
      document.addEventListener('turbo:frame-load', initDebtSimulator);
      document.addEventListener('DOMContentLoaded', initDebtSimulator);
    </script>

  <% elsif @recommendation.slug == "saving-advice" %>
    <!-- ========== SAVING ADVICE: Motivational text ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.saving_advice.motivational_text') %>
    </p>

    <!-- ========== SAVING ADVICE: User situation + tips ========== -->
    <div class="rec-simulator">
      <div class="rec-simulator__title">
        <i class="bi bi-wallet2"></i>
        <%= t('views.recommendations.pages.saving_advice.why_important.current_situation') %>
      </div>

      <div class="rec-simulator__results-grid rec-simulator__results-grid--trio">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.saving_advice.why_important.monthly_income') %></div>
          <div style="font-size: 1.125rem; font-weight: 700; color: #10b981;"><%= number_to_currency(current_user.monthly_income, unit: "\u20AC", precision: 0) %></div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.saving_advice.why_important.monthly_expenses') %></div>
          <div style="font-size: 1.125rem; font-weight: 700; color: #ef4444;"><%= number_to_currency(current_user.monthly_expenses, unit: "\u20AC", precision: 0) %></div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.saving_advice.why_important.cash_flow') %></div>
          <div style="font-size: 1.125rem; font-weight: 700;" class="<%= current_user.monthly_cash_flow > 0 ? 'text-success' : 'text-danger' %>">
            <%= number_to_currency(current_user.monthly_cash_flow, unit: "\u20AC", precision: 0) %>
          </div>
        </div>
      </div>
    </div>

    <div class="rec-edu-cards">
      <div class="rec-edu-card">
        <div class="rec-edu-card__title">
          <i class="bi bi-credit-card text-danger"></i>
          <%= t('views.recommendations.pages.saving_advice.why_important.subscriptions_title') %>
        </div>
        <p class="rec-edu-card__text">
          <%= t('views.recommendations.pages.saving_advice.why_important.subscriptions_desc') %>
          <br><strong><%= t('views.recommendations.pages.saving_advice.why_important.subscriptions_savings') %></strong>
        </p>
      </div>
      <div class="rec-edu-card">
        <div class="rec-edu-card__title">
          <i class="bi bi-cup-straw text-danger"></i>
          <%= t('views.recommendations.pages.saving_advice.why_important.dining_title') %>
        </div>
        <p class="rec-edu-card__text">
          <%= t('views.recommendations.pages.saving_advice.why_important.dining_desc') %>
          <br><strong><%= t('views.recommendations.pages.saving_advice.why_important.dining_savings') %></strong>
        </p>
      </div>
      <div class="rec-edu-card">
        <div class="rec-edu-card__title">
          <i class="bi bi-piggy-bank text-danger"></i>
          <%= t('views.recommendations.pages.saving_advice.why_important.impulse_title') %>
        </div>
        <p class="rec-edu-card__text">
          <%= t('views.recommendations.pages.saving_advice.why_important.impulse_desc') %>
          <br><strong><%= t('views.recommendations.pages.saving_advice.why_important.impulse_savings') %></strong>
        </p>
      </div>
    </div>

  <% elsif @recommendation.slug == "tax-advisory" %>
    <!-- ========== TAX ADVISORY ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.tax_advisory.motivational_text') %>
    </p>

    <!-- Tax savings simulator -->
    <div class="rec-simulator" id="taxSimulator">
      <div class="rec-simulator__title">
        <i class="bi bi-calculator"></i>
        <%= t('views.recommendations.pages.tax_advisory.simulator.title') %>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.tax_advisory.simulator.annual_income') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="taxIncome"
               min="30000" max="300000" step="5000" value="80000">
        <div class="rec-simulator__value"><span id="taxIncomeVal">80.000</span>&euro;</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.tax_advisory.simulator.current_rate') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="taxCurrentRate"
               min="20" max="50" step="1" value="37">
        <div class="rec-simulator__value"><span id="taxCurrentRateVal">37</span>%</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.tax_advisory.simulator.optimized_rate') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="taxOptimizedRate"
               min="15" max="45" step="1" value="30">
        <div class="rec-simulator__value"><span id="taxOptimizedRateVal">30</span>%</div>
      </div>

      <div class="rec-simulator__results-grid rec-simulator__results-grid--trio">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.tax_advisory.simulator.annual_savings') %></div>
          <div class="rec-simulator__highlight" style="color: #10b981;"><span id="taxAnnualSavings">0</span>&euro;/<%= t('views.recommendations.year') %></div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.tax_advisory.simulator.net_increase') %></div>
          <div class="rec-simulator__highlight" style="color: #10b981;"><span id="taxNetIncrease">0</span>%</div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.tax_advisory.simulator.in_5_years') %></div>
          <div class="rec-simulator__highlight" style="color: #10b981;"><span id="tax5YearSavings">0</span>&euro;</div>
        </div>
      </div>

      <p class="rec-simulator__note"><%= t('views.recommendations.pages.tax_advisory.simulator.note') %></p>
    </div>

    <script>
      function initTaxSimulator() {
        var incomeEl = document.getElementById('taxIncome');
        var currentRateEl = document.getElementById('taxCurrentRate');
        var optimizedRateEl = document.getElementById('taxOptimizedRate');
        if (!incomeEl || !currentRateEl || !optimizedRateEl) return;

        function formatNum(num) {
          return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function calculateTax() {
          var income = parseFloat(incomeEl.value);
          var currentRate = parseFloat(currentRateEl.value) / 100;
          var optimizedRate = parseFloat(optimizedRateEl.value) / 100;

          var currentTax = income * currentRate;
          var optimizedTax = income * optimizedRate;
          var annualSavings = Math.max(currentTax - optimizedTax, 0);
          var currentNet = income - currentTax;
          var optimizedNet = income - optimizedTax;
          var netIncrease = currentNet > 0 ? ((optimizedNet - currentNet) / currentNet * 100) : 0;

          document.getElementById('taxIncomeVal').textContent = formatNum(income);
          document.getElementById('taxCurrentRateVal').textContent = Math.round(currentRate * 100);
          document.getElementById('taxOptimizedRateVal').textContent = Math.round(optimizedRate * 100);
          document.getElementById('taxAnnualSavings').textContent = formatNum(annualSavings);
          document.getElementById('taxNetIncrease').textContent = netIncrease.toFixed(1).replace('.', ',');
          document.getElementById('tax5YearSavings').textContent = formatNum(annualSavings * 5);
        }

        incomeEl.addEventListener('input', calculateTax);
        currentRateEl.addEventListener('input', calculateTax);
        optimizedRateEl.addEventListener('input', calculateTax);
        calculateTax();
      }

      document.addEventListener('turbo:load', initTaxSimulator);
      document.addEventListener('turbo:frame-load', initTaxSimulator);
      document.addEventListener('DOMContentLoaded', initTaxSimulator);
    </script>

  <% elsif @recommendation.slug == "portfolio-optimization" %>
    <!-- ========== PORTFOLIO OPTIMIZATION ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.portfolio_optimization.motivational_text') %>
    </p>

    <div class="rec-section">
      <h4 class="rec-section__title"><%= t('views.recommendations.pages.portfolio_optimization.why_important.warnings_title') %></h4>
      <p class="rec-body-text">
        &bull; <strong><%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_complex_title') %></strong>: <%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_complex_problem') %><br>
        &bull; <strong><%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_fees_title') %></strong>: <%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_fees_problem') %><br>
        &bull; <strong><%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_concentration_title') %></strong>: <%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_concentration_problem') %><br>
        &bull; <strong><%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_performance_title') %></strong>: <%= t('views.recommendations.pages.portfolio_optimization.why_important.warning_performance_problem') %>
      </p>
    </div>

    <div class="rec-section">
      <h4 class="rec-section__title"><%= t('views.recommendations.pages.portfolio_optimization.why_important.second_opinion_title', default: 'Lo que te aporta una segunda opinion independiente') %></h4>
      <p class="rec-body-text">
        <% (t('views.recommendations.pages.portfolio_optimization.why_important.advisor_benefits', default: []) || []).first(4).each do |benefit| %>
          &bull; <strong><%= benefit[:title] %></strong> <%= benefit[:text] %><br>
        <% end %>
      </p>
    </div>

    <!-- Commission cost simulator -->
    <div class="rec-simulator" id="portfolioSimulator">
      <div class="rec-simulator__title">
        <i class="bi bi-calculator"></i>
        <%= t('views.recommendations.pages.portfolio_optimization.simulator.title') %>
      </div>

      <p class="rec-simulator__note" style="font-style: normal; color: #6b7280; margin-bottom: 0.75rem;">
        <%= t('views.recommendations.pages.portfolio_optimization.simulator.intro') %>
      </p>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.portfolio_optimization.simulator.invested_amount') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="portfolioAmount"
               min="10000" max="500000" step="5000" value="100000">
        <div class="rec-simulator__value"><span id="portfolioAmountVal">100.000</span>&euro;</div>
      </div>

      <div class="rec-simulator__label"><%= t('views.recommendations.pages.portfolio_optimization.simulator.commission_rate') %></div>
      <div class="rec-simulator__row">
        <input type="range" class="app-slider__input rec-simulator__slider" id="portfolioCommission"
               min="0.5" max="3" step="0.1" value="1.5">
        <div class="rec-simulator__value"><span id="portfolioCommissionVal">1,5</span>%</div>
      </div>

      <div class="rec-simulator__results-grid">
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.portfolio_optimization.simulator.annual_cost') %></div>
          <div class="rec-simulator__highlight" style="color: #ef4444;"><span id="portfolioAnnualCost">0</span>&euro;/<%= t('views.recommendations.year') %></div>
        </div>
        <div class="rec-simulator__result">
          <div class="rec-simulator__result-label"><%= t('views.recommendations.pages.portfolio_optimization.simulator.cost_10_years') %></div>
          <div class="rec-simulator__highlight" style="color: #ef4444;"><span id="portfolio10YearCost">0</span>&euro;</div>
        </div>
      </div>

      <p class="rec-simulator__note"><%= t('views.recommendations.pages.portfolio_optimization.simulator.note') %></p>
    </div>

    <script>
      function initPortfolioSimulator() {
        var amountEl = document.getElementById('portfolioAmount');
        var commissionEl = document.getElementById('portfolioCommission');
        if (!amountEl || !commissionEl) return;

        function formatNum(num) {
          return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function calculatePortfolio() {
          var amount = parseFloat(amountEl.value);
          var commission = parseFloat(commissionEl.value) / 100;
          var annualCost = amount * commission;
          var cost10y = annualCost * 10;

          document.getElementById('portfolioAmountVal').textContent = formatNum(amount);
          document.getElementById('portfolioCommissionVal').textContent = commissionEl.value.replace('.', ',');
          document.getElementById('portfolioAnnualCost').textContent = formatNum(annualCost);
          document.getElementById('portfolio10YearCost').textContent = formatNum(cost10y);
        }

        amountEl.addEventListener('input', calculatePortfolio);
        commissionEl.addEventListener('input', calculatePortfolio);
        calculatePortfolio();
      }

      document.addEventListener('turbo:load', initPortfolioSimulator);
      document.addEventListener('turbo:frame-load', initPortfolioSimulator);
      document.addEventListener('DOMContentLoaded', initPortfolioSimulator);
    </script>

  <% elsif @recommendation.slug == "ac-diposit" %>
    <!-- ========== SHORT-TERM DEPOSIT ========== -->
    <p class="rec-body-text">
      <%= t('views.recommendations.pages.ac_diposit.motivational_text') %>
    </p>

    <div class="rec-simulator">
      <div class="rec-simulator__title">
        <i class="bi bi-safe"></i>
        <%= t('views.recommendations.pages.ac_diposit.key_points.title') %>
      </div>

      <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.75rem;">
        <div>
          <div style="font-weight: 700; font-size: 0.9375rem; margin-bottom: 0.25rem;">
            <i class="bi bi-lock" style="color: #165668; margin-right: 0.25rem;"></i>
            <%= t('views.recommendations.pages.ac_diposit.key_points.discipline.title') %>
          </div>
          <p class="rec-body-text" style="margin-bottom: 0;"><%= t('views.recommendations.pages.ac_diposit.key_points.discipline.text') %></p>
        </div>

        <div>
          <div style="font-weight: 700; font-size: 0.9375rem; margin-bottom: 0.25rem;">
            <i class="bi bi-eye" style="color: #165668; margin-right: 0.25rem;"></i>
            <%= t('views.recommendations.pages.ac_diposit.key_points.clarity.title') %>
          </div>
          <p class="rec-body-text" style="margin-bottom: 0;"><%= t('views.recommendations.pages.ac_diposit.key_points.clarity.text') %></p>
        </div>

        <div>
          <div style="font-weight: 700; font-size: 0.9375rem; margin-bottom: 0.25rem;">
            <i class="bi bi-graph-up-arrow" style="color: #165668; margin-right: 0.25rem;"></i>
            <%= t('views.recommendations.pages.ac_diposit.key_points.small_return.title') %>
          </div>
          <p class="rec-body-text" style="margin-bottom: 0;"><%= t('views.recommendations.pages.ac_diposit.key_points.small_return.text') %></p>
        </div>

        <div>
          <div style="font-weight: 700; font-size: 0.9375rem; margin-bottom: 0.25rem;">
            <i class="bi bi-shield-check" style="color: #165668; margin-right: 0.25rem;"></i>
            <%= t('views.recommendations.pages.ac_diposit.key_points.protection.title') %>
          </div>
          <p class="rec-body-text" style="margin-bottom: 0;"><%= t('views.recommendations.pages.ac_diposit.key_points.protection.text') %></p>
        </div>
      </div>
    </div>

  <% else %>
    <!-- ========== GENERIC CONTENT ========== -->
    <% if @recommendation.content.present? %>
      <div class="rec-edu-cards">
        <div class="rec-edu-card">
          <p class="rec-edu-card__text"><%= simple_format(@recommendation.content) %></p>
        </div>
      </div>
    <% end %>
  <% end %>

  <div class="rec-divider"></div>

  <!-- 6. FAQ (Accordion, collapsed) -->
  <div class="rec-faq">
    <div class="rec-faq__title">
      <i class="bi bi-question-circle"></i>
      <%= t('views.recommendations.faq_title') %>
    </div>

    <%
      faq_items = begin
        t("views.recommendations.pages.#{slug_key}.faq.items", default: nil)
      rescue
        nil
      end
    %>

    <% if faq_items.present? %>
      <div class="accordion" id="recFaqAccordion">
        <% faq_items.each_with_index do |faq, index| %>
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#recFaq<%= index %>">
                <%= faq[:question] %>
              </button>
            </h2>
            <div id="recFaq<%= index %>" class="accordion-collapse collapse" data-bs-parent="#recFaqAccordion">
              <div class="accordion-body">
                <%= (faq[:answer_html] || faq[:answer]).html_safe %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- 7. COMPLETED -->
  <label class="rec-completed" for="markCompleted">
    <input class="form-check-input rec-completed__checkbox" type="checkbox" id="markCompleted"
           data-recommendation="<%= @recommendation.slug.underscore.gsub('-', '_') %>">
    <div>
      <div class="rec-completed__label"><%= t('views.recommendations.completed_action') %></div>
      <div class="rec-completed__sublabel"><%= t('views.recommendations.completed_action_description') %></div>
    </div>
  </label>

  <!-- 8. CTA FINAL (bottom of page) -->
  <div style="margin-top: 1.5rem; margin-bottom: 1rem;">
    <p style="text-align: center; margin-bottom: 0.75rem; font-size: 0.9375rem; font-weight: 600; color: #1a1a1a;">
      <%= t("views.recommendations.cta2_titles.#{slug_key}", default: t('views.recommendations.cta2_titles.default')) %>
    </p>
    <% if @affiliate_link.present? %>
      <a href="<%= @affiliate_link %>" target="_blank"
         style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 1rem 1.5rem; font-size: 1.0625rem; font-weight: 700; color: #fff; background: linear-gradient(135deg, #1d7a8c, #165668); border-radius: 12px; text-decoration: none; box-shadow: 0 4px 16px rgba(22,86,104,0.4); letter-spacing: 0.02em;">
        <i class="bi bi-box-arrow-up-right"></i>
        <%= t("views.recommendations.ctas.#{slug_key}", default: t('views.recommendations.ctas.default')) %>
      </a>
    <% else %>
      <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 1rem 1.5rem; font-size: 1.0625rem; font-weight: 700; color: #9ca3af; background: #f3f4f6; border-radius: 12px;">
        <i class="bi bi-clock"></i>
        <%= t('views.recommendations.coming_soon_button') %>
      </div>
    <% end %>
    <p style="text-align: center; font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;"><%= t('views.recommendations.process_secure') %></p>
  </div>

  <!-- 9. LEGAL (bottom, fine print) -->
  <div class="rec-legal">
    <p class="mb-2"><%= t('views.recommendations.legal_affiliate_disclosure') %></p>
    <p class="mb-0"><strong><%= t('views.recommendations.important') %>:</strong> <%= t('views.recommendations.legal_disclaimer') %></p>
  </div>

</div>

<script>
(function() {
  function initCompletedCheckbox() {
    var checkbox = document.getElementById('markCompleted');
    if (!checkbox) return;

    var recKey = checkbox.dataset.recommendation;

    // Check if already completed
    fetch('/api/user_actions/check?recommendation=' + recKey)
      .then(function(r) { return r.json(); })
      .then(function(data) { if (data.completed) checkbox.checked = true; })
      .catch(function() {});

    checkbox.addEventListener('change', function() {
      var url = this.checked ? '/api/user_actions/complete' : '/api/user_actions/uncomplete';
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({ recommendation: recKey })
      }).catch(function(err) {
        console.error('Error:', err);
        checkbox.checked = !checkbox.checked;
      });
    });
  }

  document.addEventListener('turbo:load', initCompletedCheckbox);
  document.addEventListener('DOMContentLoaded', initCompletedCheckbox);
})();
</script>
