<% content_for :title, t('profile.nav_title', default: 'Perfil') %>
<div class="app-container">
  <%# User header %>
  <% user_name = @user.email.split('@').first.capitalize %>
  <% initials = user_name[0..1].upcase %>
  <div class="profile-header">
    <div class="profile-header__avatar">
      <span><%= initials %></span>
    </div>
    <div class="profile-header__info">
      <h2 class="profile-header__name"><%= user_name %></h2>
      <p class="profile-header__email"><%= @user.email %></p>
      <span class="profile-header__meta">
        <%= t("financial.levels.#{@financial_level_key}.short_name") %>
        &middot;
        <%= t('profile.since', default: 'Desde') %> <%= @member_since.strftime('%b %Y') %>
      </span>
    </div>
  </div>

  <% if @profile_complete %>
    <%# Financial Summary %>
    <div class="profile-summary">
      <h3 class="profile-summary__title"><%= t('profile.your_summary', default: 'Tu resumen') %></h3>

      <div class="profile-summary__row">
        <span class="profile-summary__row-label"><%= t('profile.summary.earn', default: 'Ganas') %></span>
        <span class="profile-summary__row-value"><%= format_currency(@income) %><%= t('profile.summary.per_month', default: '/mes') %></span>
      </div>
      <div class="profile-summary__row">
        <span class="profile-summary__row-label"><%= t('profile.summary.spend', default: 'Gastas') %></span>
        <span class="profile-summary__row-value"><%= format_currency(@expenses) %><%= t('profile.summary.per_month', default: '/mes') %></span>
      </div>
      <div class="profile-summary__divider"></div>
      <div class="profile-summary__row">
        <span class="profile-summary__row-label"><%= t('profile.summary.left_over', default: 'Te sobra') %></span>
        <span class="profile-summary__row-value <%= @cash_flow >= 0 ? 'profile-summary__row-value--positive' : 'profile-summary__row-value--negative' %>">
          <%= format_currency(@cash_flow) %><%= t('profile.summary.per_month', default: '/mes') %>
        </span>
      </div>

      <div class="profile-summary__divider" style="margin: 0.5rem 0;"></div>

      <div class="profile-summary__row">
        <span class="profile-summary__row-label"><%= t('profile.summary.what_you_have', default: 'Lo que tienes') %></span>
        <span class="profile-summary__row-value"><%= format_currency(@total_assets) %></span>
      </div>
      <div class="profile-summary__row">
        <span class="profile-summary__row-label"><%= t('profile.summary.what_you_owe', default: 'Lo que debes') %></span>
        <span class="profile-summary__row-value"><%= format_currency(@total_debts) %></span>
      </div>
    </div>

    <%# Update data button %>
    <%= link_to onboarding_step_path(step_name: 'ingresos', from: 'profile'),
        class: 'btn-app btn-app--primary btn-app--block mb-4' do %>
      <i class="bi bi-arrow-repeat me-1"></i>
      <%= t('profile.update_data', default: 'Actualizar mis datos') %>
    <% end %>

    <%# Charts %>
    <% if @max_income_expense > 0 %>
      <div class="profile-chart">
        <h4 class="profile-chart__title"><%= t('profile.chart.income_vs_expenses', default: 'Ingresos vs Gastos') %></h4>
        <div class="profile-chart__bar-row">
          <span class="profile-chart__bar-label"><%= t('profile.chart.income', default: 'Ingresos') %></span>
          <div class="profile-chart__bar-track">
            <div class="profile-chart__bar-fill" style="width: <%= (@income.to_f / @max_income_expense * 100).round %>%; background: #10b981;"></div>
          </div>
          <span class="profile-chart__bar-amount"><%= format_currency(@income) %></span>
        </div>
        <div class="profile-chart__bar-row">
          <span class="profile-chart__bar-label"><%= t('profile.chart.expenses', default: 'Gastos') %></span>
          <div class="profile-chart__bar-track">
            <div class="profile-chart__bar-fill" style="width: <%= (@expenses.to_f / @max_income_expense * 100).round %>%; background: #ef4444;"></div>
          </div>
          <span class="profile-chart__bar-amount"><%= format_currency(@expenses) %></span>
        </div>
      </div>
    <% end %>

    <% if @max_asset_debt > 0 %>
      <div class="profile-chart">
        <h4 class="profile-chart__title"><%= t('profile.chart.assets_vs_debts', default: 'Lo que tienes vs lo que debes') %></h4>
        <div class="profile-chart__bar-row">
          <span class="profile-chart__bar-label"><%= t('profile.chart.assets', default: 'Tienes') %></span>
          <div class="profile-chart__bar-track">
            <div class="profile-chart__bar-fill" style="width: <%= (@total_assets.to_f / @max_asset_debt * 100).round %>%; background: #10b981;"></div>
          </div>
          <span class="profile-chart__bar-amount"><%= format_currency(@total_assets) %></span>
        </div>
        <div class="profile-chart__bar-row">
          <span class="profile-chart__bar-label"><%= t('profile.chart.debts', default: 'Debes') %></span>
          <div class="profile-chart__bar-track">
            <div class="profile-chart__bar-fill" style="width: <%= (@total_debts.to_f / @max_asset_debt * 100).round %>%; background: #ef4444;"></div>
          </div>
          <span class="profile-chart__bar-amount"><%= format_currency(@total_debts) %></span>
        </div>
      </div>
    <% end %>
  <% else %>
    <%# Incomplete profile %>
    <div class="profile-incomplete-cta">
      <i class="bi bi-graph-up-arrow"></i>
      <p><%= t('profile.incomplete_message', default: 'Completa tus datos para ver tu resumen financiero.') %></p>
      <%= link_to onboarding_step_path(step_name: 'ingresos', from: 'profile'),
          class: 'btn-app btn-app--primary btn-app--block' do %>
        <%= t('profile.update_data', default: 'Actualizar mis datos') %>
      <% end %>
    </div>
  <% end %>

  <%# Account section %>
  <div class="app-section mt-4">
    <h3 class="app-section__title"><%= t('profile.account', default: 'Cuenta') %></h3>

    <%= link_to profile_settings_path, class: 'profile-menu-item' do %>
      <div class="profile-menu-item__icon-wrap">
        <i class="bi bi-gear text-brand"></i>
      </div>
      <div class="profile-menu-item__content">
        <h4 class="profile-menu-item__title"><%= t('profile.settings', default: 'Configuracion') %></h4>
        <p class="profile-menu-item__subtitle mb-0"><%= t('profile.language_notifications', default: 'Idioma, notificaciones') %></p>
      </div>
      <i class="bi bi-chevron-right profile-menu-item__arrow"></i>
    <% end %>
  </div>

  <%# Logout %>
  <div class="mt-4">
    <%= button_to destroy_user_session_path,
        method: :delete,
        class: 'btn-app btn-app--secondary btn-app--block',
        data: { turbo: false } do %>
      <i class="bi bi-box-arrow-right"></i>
      <%= t('profile.logout', default: 'Cerrar sesion') %>
    <% end %>
  </div>

  <p class="text-center text-muted small mt-4">
    Finex v2.0.0
  </p>
</div>
