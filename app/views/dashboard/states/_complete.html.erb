<!-- ESTADO 3: DASHBOARD COMPLETO -->

<!-- TU ESCALADA FINANCIERA (arriba del todo, sin fondo) -->
<div class="text-center py-4 mt-4">
  <h3 class="mb-4">
    <i class="bi bi-map text-info me-2"></i>
    Tu Escalada Financiera
  </h3>
  
  <div class="mountain-progress-bar">
    <% @mountain_progress.each_with_index do |state, index| %>
      <div class="progress-step <%= state[:status] %>">
        <div class="step-icon">
          <i class="<%= state[:bootstrap_icon] %> step-bootstrap-icon"></i>
        </div>
        <div class="step-content">
          <div class="step-name"><%= state[:name] %></div>
          <% if state[:status] == "current" %>
            <div class="step-badge current-badge">Actual</div>
          <% elsif state[:status] == "completed" %>
            <div class="step-badge completed-badge"><i class="bi bi-check"></i></div>
          <% end %>
        </div>
        <% unless index == @mountain_progress.length - 1 %>
          <div class="step-connector <%= state[:status] == 'completed' ? 'completed' : '' %>"></div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- 1. ESTADO + EXPLICACIÓN -->
<div class="dashboard-card mb-4">
  <div class="card-body p-4">
    <div class="row align-items-center">
      <div class="col-md-3 text-center">
        <div style="font-size: 4rem;">
          <i class="<%= @mountain_state[:bootstrap_icon] %> text-primary"></i>
        </div>
      </div>
      <div class="col-md-9">
        <h2 class="mb-3 text-primary">
          <strong><%= @mountain_state[:name] %></strong>
        </h2>
        <p class="mb-4" style="line-height: 1.6;">
          <%= @mountain_state[:description] %>
        </p>
        
        <div class="mt-4 p-4 rounded" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.08) 0%, rgba(13, 110, 253, 0.12) 100%); border-left: 4px solid #0d6efd;">
          <h5 class="text-primary mb-3">
            <i class="bi bi-arrow-right-circle me-2"></i>
            Próximo Paso
          </h5>
          <p class="mb-0" style="line-height: 1.6;">
            <%= @mountain_state[:next_step] %>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Formulario crear objetivo (solo para estados que pueden invertir) -->
<% if current_user.can_invest_in_objectives? %>
  <div class="text-center py-4 mt-4">
    <div class="bg-light p-4 rounded mx-auto" style="max-width: 800px;">
      <h4 class="mb-3 text-center">
        <i class="bi bi-plus-circle text-success me-2"></i>
        Crear Nuevo Objetivo
      </h4>
      <p class="text-muted text-center mb-4">
        Define un objetivo financiero y obtén inmediatamente la recomendación específica para alcanzarlo.
      </p>
      
      <%= form_with model: @new_objective, local: true, class: "row g-3 justify-content-center" do |f| %>
        <%= f.hidden_field :user_id, value: current_user.id %>
        <div class="col-md-4">
          <label for="objective_title" class="form-label">¿Qué quieres lograr?</label>
          <%= f.text_field :title, class: "form-control", placeholder: "Ej: Comprar coche, Casa vacaciones..." %>
        </div>
        <div class="col-md-4">
          <label for="objective_target_amount" class="form-label">¿Cuánto necesitas? (€)</label>
          <%= f.number_field :target_amount, class: "form-control", placeholder: "Ej: 25000" %>
        </div>
        <div class="col-md-4">
          <label class="form-label">¿Para cuándo?</label>
          <div class="row g-2">
            <div class="col-7">
              <%= f.select :target_date_month, 
                  options_for_select([
                    ['Enero', 1], ['Febrero', 2], ['Marzo', 3], ['Abril', 4],
                    ['Mayo', 5], ['Junio', 6], ['Julio', 7], ['Agosto', 8],
                    ['Septiembre', 9], ['Octubre', 10], ['Noviembre', 11], ['Diciembre', 12]
                  ], Date.current.month), 
                  { prompt: 'Mes' }, 
                  { class: "form-select form-select-sm" } %>
            </div>
            <div class="col-5">
              <%= f.select :target_date_year,
                  options_for_select((Date.current.year..(Date.current.year + 45)).map { |y| [y, y] }, Date.current.year + 1),
                  { prompt: 'Año' },
                  { class: "form-select form-select-sm" } %>
            </div>
          </div>
          <small class="text-muted">Selecciona el mes y año objetivo</small>
        </div>
        <div class="col-12 text-center mt-4">
          <button type="submit" class="btn btn-success btn-lg">
            <i class="bi bi-target me-2"></i>
            Crear Objetivo y Ver Recomendación
          </button>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Flecha indicadora hacia las recomendaciones -->
<div class="current-state-arrow">
  <i class="bi bi-arrow-down text-primary"></i>
</div>

<!-- 3. RECOMENDACIONES Y OBJETIVOS UNIFICADOS -->
<div class="text-center py-4 mt-4">
  <h2 class="mb-2">
    <i class="bi bi-arrow-up-right-circle text-success me-2"></i>
    Próximos Pasos
  </h2>
  <p class="text-muted mb-4">
    Acciones específicas para mejorar tu situación financiera actual
  </p>
  
  <div class="row justify-content-center">
    <!-- Recomendaciones base según estado financiero -->
    <% @all_recommendations.each_with_index do |rec, index| %>
      <div class="col-md-6 mb-3">
        <div class="border rounded p-3 h-100 d-flex flex-column bg-white">
          <div class="d-flex align-items-start mb-3">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                 style="width: 40px; height: 40px; flex-shrink: 0;">
              <i class="<%= rec[:icon] %>" style="font-size: 1.1rem;"></i>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-2 fw-bold"><%= rec[:title] %></h6>
              <p class="text-muted small mb-0 lh-sm"><%= rec[:description] %></p>
            </div>
          </div>
          <div class="mt-auto">
            <!-- Generar slug simple para recomendaciones base -->
            <% rec_slug = rec[:product].parameterize %>
            <%= link_to recommendation_path(rec_slug), class: "btn btn-success btn-sm w-100" do %>
              <i class="bi bi-arrow-right me-1"></i>
              <%= rec[:cta] %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- Recomendaciones de objetivos (con nombres de objetivos) -->
    <% @objectives_with_recommendations.each_with_index do |obj_rec, index| %>
      <div class="col-md-6 mb-3">
        <div class="border rounded p-3 h-100 d-flex flex-column position-relative bg-white" style="border-color: #198754 !important;">
          <!-- Etiqueta "Según tu objetivo" -->
          <div class="position-absolute" style="top: -8px; left: 16px;">
            <span class="badge bg-success px-3 py-1 small">Según tu objetivo</span>
          </div>
          
          <!-- Botón eliminar en esquina superior derecha -->
          <%= link_to obj_rec[:objective], 
                      class: "btn btn-outline-danger btn-sm position-absolute", 
                      style: "top: 8px; right: 8px; width: 30px; height: 30px; padding: 0; border-radius: 50%; line-height: 1;",
                      data: { 
                        turbo_method: :delete,
                        turbo_confirm: "¿Estás seguro de que quieres eliminar el objetivo '#{obj_rec[:objective].title}'?"
                      },
                      title: "Eliminar objetivo" do %>
            <i class="bi bi-x" style="font-size: 1rem;"></i>
          <% end %>
          
          <div class="d-flex align-items-start mb-3 mt-3">
            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                 style="width: 40px; height: 40px; flex-shrink: 0;">
              <i class="bi bi-bullseye" style="font-size: 1.1rem;"></i>
            </div>
            <div class="flex-grow-1" style="padding-right: 40px;">
              <h6 class="mb-2 text-success fw-bold"><%= obj_rec[:objective].title %></h6>
              <p class="text-muted small mb-1 lh-sm">
                Meta: <strong>€<%= number_with_delimiter(obj_rec[:objective].target_amount, delimiter: ".") %></strong>
                en <%= distance_of_time_in_words(Date.current, obj_rec[:objective].target_date) %>
              </p>
              <p class="text-info small mb-0 lh-sm">
                Ahorro mensual: €<%= number_with_delimiter(obj_rec[:monthly_needed], delimiter: ".") %>
              </p>
            </div>
          </div>
          <div class="mt-auto">
            <%= link_to recommendation_path(obj_rec[:recommendation_type], objetivo_id: obj_rec[:objective].id), 
                class: "btn btn-success btn-sm w-100" do %>
              <i class="bi bi-arrow-right me-1"></i>
              Ver Inversión
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- 4. GRÁFICOS PyG + BALANCE -->
<div class="text-center py-4 mt-4">
  <h3 class="mb-3">
    <i class="bi bi-graph-up text-success me-2"></i>
    Análisis Detallado
  </h3>
  <p class="text-muted mb-4">
    Visualiza tu situación financiera actual con gráficos interactivos de tus ingresos, gastos y patrimonio neto.
  </p>
</div>

<div class="row mb-4">
  <!-- Gráfico PyG -->
  <div class="col-lg-6 mb-4">
    <div class="dashboard-card">
      <div class="card-body p-4">
        <h4 class="card-title mb-3">
          <i class="bi bi-graph-up me-2 text-primary"></i>
          Análisis PyG
        </h4>
        <div class="chart-container" style="height: 300px;">
          <canvas id="pygChart"></canvas>
        </div>
        <div class="row text-center mt-3">
          <div class="col-4">
            <div class="text-success">
              <strong>Ingresos</strong><br>
              <span class="h6">€<%= number_with_delimiter(@pyg_chart_data[:income] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="text-danger">
              <strong>Gastos</strong><br>
              <span class="h6">€<%= number_with_delimiter(@pyg_chart_data[:expenses] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="<%= @pyg_chart_data[:cash_flow] > 0 ? 'text-success' : 'text-danger' %>">
              <strong>Capacidad</strong><br>
              <span class="h6">€<%= number_with_delimiter(@pyg_chart_data[:cash_flow] || 0, delimiter: ".") %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Gráfico Balance -->
  <div class="col-lg-6 mb-4">
    <div class="dashboard-card">
      <div class="card-body p-4">
        <h4 class="card-title mb-3">
          <i class="bi bi-pie-chart me-2 text-success"></i>
          Balance Patrimonial
        </h4>
        <div class="chart-container" style="height: 300px;">
          <canvas id="balanceChart"></canvas>
        </div>
        <div class="row text-center mt-3">
          <div class="col-4">
            <div class="text-success">
              <strong>Activos</strong><br>
              <span class="h6">€<%= number_with_delimiter(@balance_chart_data[:assets] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="text-danger">
              <strong>Deudas</strong><br>
              <span class="h6">€<%= number_with_delimiter(@balance_chart_data[:debt] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="<%= @balance_chart_data[:net_worth] > 0 ? 'text-success' : 'text-danger' %>">
              <strong>Patrimonio</strong><br>
              <span class="h6">€<%= number_with_delimiter(@balance_chart_data[:net_worth] || 0, delimiter: ".") %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enlaces de Edición -->
<div class="row mb-4">
  <div class="col-md-6 mb-2">
    <%= link_to edit_pyg_path, class: "btn btn-outline-primary w-100" do %>
      <i class="bi bi-pencil me-2"></i>
      Editar Ingresos y Gastos
    <% end %>
  </div>
  <div class="col-md-6 mb-2">
    <%= link_to edit_balance_path, class: "btn btn-outline-primary w-100" do %>
      <i class="bi bi-pencil me-2"></i>
      Editar Activos y Deudas
    <% end %>
  </div>
</div>

<!-- Scripts para los gráficos simplificados -->
<script>
function initSimplifiedCharts() {
  // Gráfico PyG simple
  const pygElement = document.getElementById('pygChart');
  if (pygElement) {
    const pygCtx = pygElement.getContext('2d');
    const pygData = <%= raw @pyg_chart_data.to_json %>;
    
    new Chart(pygCtx, {
      type: 'bar',
      data: {
        labels: ['Ingresos', 'Gastos', 'Capacidad'],
        datasets: [{
          data: [pygData.income || 0, pygData.expenses || 0, Math.max(pygData.cash_flow || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', pygData.cash_flow > 0 ? '#17a2b8' : '#6c757d'],
          borderColor: ['#28a745', '#dc3545', pygData.cash_flow > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString('es-ES');
              }
            }
          }
        }
      }
    });
  }
  
  // Gráfico Balance simple
  const balanceElement = document.getElementById('balanceChart');
  if (balanceElement) {
    const balanceCtx = balanceElement.getContext('2d');
    const balanceData = <%= raw @balance_chart_data.to_json %>;
    
    new Chart(balanceCtx, {
      type: 'bar',
      data: {
        labels: ['Activos', 'Deudas', 'Patrimonio'],
        datasets: [{
          data: [balanceData.assets || 0, balanceData.debt || 0, Math.max(balanceData.net_worth || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', balanceData.net_worth > 0 ? '#17a2b8' : '#6c757d'],
          borderColor: ['#28a745', '#dc3545', balanceData.net_worth > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString('es-ES');
              }
            }
          }
        }
      }
    });
  }
}

// Inicializar gráficos
document.addEventListener('DOMContentLoaded', initSimplifiedCharts);
document.addEventListener('turbo:load', initSimplifiedCharts);
</script>

<!-- Estilos para los iconos de Bootstrap en la escalada -->
<style>
.step-bootstrap-icon {
  font-size: 1.5rem;
  color: #6c757d;
}

.progress-step.current .step-bootstrap-icon {
  color: #ffffff;
}

.progress-step.completed .step-bootstrap-icon {
  color: #198754;
}

.current-state-arrow {
  text-align: center;
  margin-top: 1rem;
  font-size: 1.5rem;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}
</style>