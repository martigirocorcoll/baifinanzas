<!-- DASHBOARD HIGH LEVEL: SituaciÃ³n Estable, Crecimiento Patrimonial, Libertad Financiera -->
<!-- ENFOQUE "CURRENT TASK" - Centrado en la siguiente acciÃ³n a tomar -->

<!-- MARGEN SUPERIOR -->
<div class="mt-4"></div>

<!-- 0. CARD NIVEL ACTUAL (COMPACTA) -->
<div class="dashboard-card mb-3" style="background: linear-gradient(135deg, rgba(255, 198, 90, 0.08) 0%, rgba(253, 16, 21, 0.03) 100%); border: 2px solid #FFC65A;">
  <div class="card-body p-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
      <div class="d-flex align-items-center">
        <i class="<%= @mountain_state[:bootstrap_icon] %> me-2" style="color: #FFC65A; font-size: 2rem;"></i>
        <div>
          <h4 class="mb-0">
            <strong><%= @mountain_state[:name] %></strong>
            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.85rem;">
              Nivel <%= current_user.financial_health_level_number %>/6
            </span>
          </h4>
          <p class="text-muted small mb-0"><%= @mountain_state[:description].truncate(120) %></p>
        </div>
      </div>
      <button type="button" class="btn btn-sm btn-outline-primary mt-2 mt-md-0" data-bs-toggle="modal" data-bs-target="#levelGuideModal">
        <i class="bi bi-info-circle me-1"></i>
        GuÃ­a de niveles
      </button>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- 1. CURRENT TASK HERO CARD (70% ATENCIÃ“N) -->
<!-- ========================================= -->
<% if @current_task.present? %>
  <div class="current-task-hero mb-4">
    <div class="card border-success shadow-lg" style="border-width: 3px;">
      <div class="card-body p-4">

        <!-- Badge de posiciÃ³n -->
        <div class="mb-3">
          <span class="badge bg-success" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
            Paso <%= @current_task[:position] %> de <%= @total_count %>
          </span>
        </div>

        <!-- TÃ­tulo de la tarea -->
        <h1 class="display-5 fw-bold mb-3">
          <%= @current_task[:icon] %> <%= @current_task[:title] %>
        </h1>

        <!-- Beneficio cualitativo -->
        <div class="task-benefit mb-3 p-3 bg-light rounded">
          <div class="d-flex align-items-center">
            <i class="bi bi-check-circle-fill text-success me-3" style="font-size: 1.5rem;"></i>
            <p class="mb-0">
              <strong style="font-size: 1.1rem; color: #198754;"><%= @current_task[:benefit_text] %></strong>
            </p>
          </div>
        </div>

        <!-- Tiempo estimado -->
        <% if @current_task[:type] == 'recommendation' %>
          <div class="task-time mb-4">
            <i class="bi bi-clock text-primary me-2"></i>
            <span class="text-muted">Solo <strong><%= @current_task[:time_minutes] %> minutos</strong> de tu tiempo</span>
          </div>
        <% elsif @current_task[:type] == 'objective' %>
          <div class="task-time mb-4">
            <i class="bi bi-calendar-check text-primary me-2"></i>
            <span class="text-muted">Plazo: <strong><%= @current_task[:time_months] %> meses</strong></span>
          </div>
        <% end %>

        <!-- CTA principal -->
        <% if @current_task[:type] == 'recommendation' && @current_task[:recommendation].present? %>
          <%= link_to recommendation_path(@current_task[:slug]), class: "btn btn-success btn-lg w-100 fw-bold" do %>
            <i class="bi bi-arrow-right-circle me-2"></i>
            Ver cÃ³mo hacerlo
          <% end %>
        <% elsif @current_task[:type] == 'create_objective' %>
          <a href="#create-objective-section" class="btn btn-success btn-lg w-100 fw-bold">
            <i class="bi bi-plus-circle me-2"></i>
            Crear tu primer objetivo
          </a>
        <% elsif @current_task[:type] == 'objective' %>
          <%= link_to recommendation_path(@current_task[:objective].investment_recommendation, objetivo_id: @current_task[:objective].id), class: "btn btn-success btn-lg w-100 fw-bold" do %>
            <i class="bi bi-arrow-right-circle me-2"></i>
            Ver plan de inversiÃ³n
          <% end %>
        <% end %>

      </div>
    </div>
  </div>
<% else %>
  <!-- Mensaje si no hay tareas pendientes -->
  <div class="alert alert-success mb-4 p-4" style="border: 3px solid #1EDD88;">
    <div class="d-flex align-items-start">
      <i class="bi bi-trophy-fill me-3" style="font-size: 3rem; color: #1EDD88;"></i>
      <div class="flex-grow-1">
        <h3 class="alert-heading mb-2">
          <strong>Â¡Enhorabuena! Has completado todo tu plan ðŸŽ‰</strong>
        </h3>
        <p class="mb-3">
          Es momento de actualizar tus datos financieros para ver si has progresado de nivel
          y recibir nuevas recomendaciones personalizadas.
        </p>
        <div class="d-flex gap-2 flex-wrap">
          <%= link_to edit_pyg_path, class: "btn btn-success btn-lg" do %>
            <i class="bi bi-graph-up me-1"></i>
            Actualizar Ingresos y Gastos
          <% end %>
          <%= link_to edit_balance_path, class: "btn btn-success btn-lg" do %>
            <i class="bi bi-pie-chart me-1"></i>
            Actualizar Activos y Deudas
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- ========================================= -->
<!-- 2. SECCIÃ“N DE PROGRESO -->
<!-- ========================================= -->
<div class="progress-section mb-4">
  <div class="card">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
          <i class="bi bi-graph-up-arrow me-2 text-success"></i>
          Tu Progreso
        </h5>
        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
          <%= @completed_count %>/<%= @total_count %> completadas
        </span>
      </div>

      <div class="progress mb-2" style="height: 20px;">
        <div class="progress-bar bg-success" role="progressbar"
             style="width: <%= @progress_percentage %>%;"
             aria-valuenow="<%= @progress_percentage %>"
             aria-valuemin="0"
             aria-valuemax="100">
          <strong><%= @progress_percentage %>%</strong>
        </div>
      </div>

      <% if @completed_count > 0 && @completed_count < @total_count %>
        <div class="text-center mt-3">
          <small class="text-muted">
            <i class="bi bi-people-fill me-1"></i>
            Â¡Buen trabajo! Sigue asÃ­ para completar tu plan financiero
          </small>
        </div>
      <% elsif @completed_count == @total_count %>
        <div class="text-center mt-3">
          <small class="text-success fw-bold">
            <i class="bi bi-trophy-fill me-1"></i>
            Â¡Plan completado! Actualiza tus datos para ver tu progreso
          </small>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- 3. PLAN COMPLETO (COLAPSABLE) -->
<!-- ========================================= -->
<div class="accordion mb-4" id="fullPlanAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="fullPlanHeading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fullPlanCollapse" aria-expanded="false">
        <i class="bi bi-list-ul me-2"></i>
        <strong>Ver plan completo (<%= @total_count %> acciones)</strong>
      </button>
    </h2>
    <div id="fullPlanCollapse" class="accordion-collapse collapse" aria-labelledby="fullPlanHeading" data-bs-parent="#fullPlanAccordion">
      <div class="accordion-body p-0">
        <div class="list-group list-group-flush">
          <% @action_plan.each_with_index do |action, index| %>
            <div class="list-group-item <%= action[:completed] ? 'bg-light' : '' %>">
              <div class="d-flex align-items-center">
                <!-- Checkbox -->
                <div class="me-3">
                  <% if action[:completed] %>
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                  <% else %>
                    <i class="bi bi-circle text-muted" style="font-size: 1.5rem;"></i>
                  <% end %>
                </div>

                <!-- Icon -->
                <div class="me-3" style="font-size: 1.8rem;">
                  <%= action[:icon] %>
                </div>

                <!-- Content -->
                <div class="flex-grow-1 <%= action[:completed] ? 'text-decoration-line-through opacity-50' : '' %>">
                  <h6 class="mb-1 fw-bold"><%= action[:title] %></h6>
                  <small class="text-muted"><%= action[:benefit_text] %></small>
                  <% if action[:type] == 'recommendation' %>
                    <small class="text-primary ms-2">
                      <i class="bi bi-clock"></i> <%= action[:time_minutes] %> min
                    </small>
                  <% end %>
                </div>

                <!-- Action button -->
                <% if !action[:completed] %>
                  <div class="ms-3">
                    <% if action[:type] == 'recommendation' && action[:recommendation].present? %>
                      <%= link_to recommendation_path(action[:slug]), class: "btn btn-sm btn-outline-success" do %>
                        <i class="bi bi-arrow-right"></i>
                      <% end %>
                    <% elsif action[:type] == 'objective' && action[:objective].present? %>
                      <%= link_to recommendation_path(action[:objective].investment_recommendation, objetivo_id: action[:objective].id), class: "btn btn-sm btn-outline-success" do %>
                        <i class="bi bi-arrow-right"></i>
                      <% end %>
                    <% elsif action[:type] == 'create_objective' %>
                      <a href="#create-objective-section" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-plus-circle"></i>
                      </a>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- 4. WIDGET CAPACIDAD DE AHORRO (si aplica) -->
<!-- ========================================= -->
<% if @active_objectives.any? || current_user.can_invest_in_objectives? %>
  <%
    theoretical_capacity = @monthly_cash_flow
    committed_capacity = @active_objectives.sum { |obj| obj.monthly_savings_needed }
    available_capacity = theoretical_capacity - committed_capacity
    utilization_rate = theoretical_capacity > 0 ? (committed_capacity.to_f / theoretical_capacity * 100).round(0) : 0
  %>

  <div class="dashboard-card mb-4">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">
          <i class="bi bi-wallet2 me-2"></i>
          Tu Capacidad de Ahorro
        </h5>
        <% if utilization_rate < 70 %>
          <span class="badge bg-success">Saludable</span>
        <% elsif utilization_rate < 90 %>
          <span class="badge bg-warning text-dark">Alto uso</span>
        <% else %>
          <span class="badge bg-danger">Excedida</span>
        <% end %>
      </div>

      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-muted">Uso de capacidad</span>
          <span class="small fw-bold"><%= utilization_rate %>% utilizado</span>
        </div>
        <div class="progress" style="height: 16px;">
          <% bar_color = utilization_rate < 70 ? 'bg-success' : (utilization_rate < 90 ? 'bg-warning' : 'bg-danger') %>
          <div class="progress-bar <%= bar_color %>"
               role="progressbar"
               style="width: <%= [utilization_rate, 100].min %>%"
               aria-valuenow="<%= utilization_rate %>"
               aria-valuemin="0"
               aria-valuemax="100">
          </div>
        </div>
      </div>

      <div class="row text-center g-2">
        <div class="col-4">
          <div class="text-primary">
            <small class="d-block text-muted">Flujo de caja</small>
            <strong class="h6">â‚¬<%= number_with_delimiter(theoretical_capacity, delimiter: ".") %></strong>
          </div>
        </div>
        <div class="col-4">
          <div class="<%= committed_capacity > 0 ? 'text-info' : 'text-muted' %>">
            <small class="d-block text-muted">Comprometido</small>
            <strong class="h6">â‚¬<%= number_with_delimiter(committed_capacity, delimiter: ".") %></strong>
          </div>
        </div>
        <div class="col-4">
          <div class="<%= available_capacity > 0 ? 'text-success' : 'text-danger' %>">
            <small class="d-block text-muted">Disponible</small>
            <strong class="h6">â‚¬<%= number_with_delimiter(available_capacity, delimiter: ".") %></strong>
          </div>
        </div>
      </div>

      <% if utilization_rate >= 100 %>
        <div class="alert alert-danger mt-2 mb-0 py-2">
          <small>
            <i class="bi bi-exclamation-triangle me-1"></i>
            Tus objetivos requieren â‚¬<%= number_with_delimiter(committed_capacity - theoretical_capacity, delimiter: ".") %>/mes mÃ¡s de lo disponible.
          </small>
        </div>
      <% elsif utilization_rate >= 70 %>
        <div class="alert alert-warning mt-2 mb-0 py-2">
          <small>
            <i class="bi bi-info-circle me-1"></i>
            Usando <%= utilization_rate %>% de tu capacidad. Deja margen para imprevistos.
          </small>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- ========================================= -->
<!-- 5. TUS OBJETIVOS (si aplica) -->
<!-- ========================================= -->
<% if current_user.can_invest_in_objectives? %>
  <div class="mt-4 mb-4" id="create-objective-section">
    <h3 class="mb-3">
      <i class="bi bi-bullseye text-success me-2"></i>
      Tus Objetivos Financieros
    </h3>

    <% if @objectives_with_recommendations.any? %>
      <div class="row mb-4">
        <% @objectives_with_recommendations.each_with_index do |obj_rec, index| %>
          <div class="col-md-6 mb-3">
            <div class="border rounded p-3 bg-white shadow-sm h-100 d-flex flex-column position-relative"
                 style="border-color: #198754 !important; border-width: 2px;">

              <%= button_to obj_rec[:objective], method: :delete,
                            data: { confirm: 'Â¿Eliminar este objetivo?' },
                            class: "btn btn-outline-danger btn-sm position-absolute",
                            style: "top: 8px; right: 8px; width: 28px; height: 28px; padding: 0; border-radius: 50%; line-height: 1;",
                            title: "Eliminar objetivo" do %>
                <i class="bi bi-x" style="font-size: 0.9rem;"></i>
              <% end %>

              <div class="d-flex align-items-start mb-3 mt-2">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                     style="width: 48px; height: 48px; flex-shrink: 0;">
                  <i class="bi bi-bullseye" style="font-size: 1.2rem;"></i>
                </div>
                <div class="flex-grow-1" style="padding-right: 35px;">
                  <h5 class="mb-1 text-success fw-bold"><%= obj_rec[:objective].title %></h5>
                  <p class="text-muted small mb-1 lh-sm">
                    Meta: <strong>â‚¬<%= number_with_delimiter(obj_rec[:objective].target_amount, delimiter: ".") %></strong>
                    en <%= distance_of_time_in_words(Date.current, obj_rec[:objective].target_date) %>
                  </p>
                  <p class="text-info small mb-0 lh-sm">
                    <i class="bi bi-piggy-bank me-1"></i>
                    <strong>â‚¬<%= number_with_delimiter(obj_rec[:monthly_needed], delimiter: ".") %>/mes</strong>
                  </p>
                </div>
              </div>

              <div class="mt-auto">
                <%= link_to recommendation_path(obj_rec[:recommendation_type], objetivo_id: obj_rec[:objective].id),
                    class: "btn btn-success w-100" do %>
                  <i class="bi bi-arrow-right-circle me-1"></i>
                  Ver Plan de InversiÃ³n
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Formulario crear nuevo objetivo -->
    <div class="bg-light p-4 rounded">
      <h4 class="mb-3">
        <i class="bi bi-plus-circle text-success me-2"></i>
        <%= @objectives_with_recommendations.any? ? "Crear Otro Objetivo" : "Crear Tu Primer Objetivo" %>
      </h4>
      <p class="text-muted mb-3">
        Define un objetivo financiero y obtÃ©n la recomendaciÃ³n especÃ­fica para alcanzarlo.
      </p>

      <%= form_with model: @new_objective, local: true, class: "row g-3", id: "create-objective-form" do |f| %>
        <%= f.hidden_field :user_id, value: current_user.id %>
        <div class="col-md-4">
          <label class="form-label small fw-bold">Â¿QuÃ© quieres lograr?</label>
          <%= f.text_field :title, class: "form-control", placeholder: "Ej: Comprar coche", required: true %>
        </div>
        <div class="col-md-4">
          <label class="form-label small fw-bold">Â¿CuÃ¡nto necesitas? (â‚¬)</label>
          <%= f.number_field :target_amount, class: "form-control", placeholder: "Ej: 25000", required: true %>
        </div>
        <div class="col-md-4">
          <label class="form-label small fw-bold">Â¿Para cuÃ¡ndo?</label>
          <div class="row g-2">
            <div class="col-7">
              <%= f.select :target_date_month,
                  options_for_select([
                    ['Enero', 1], ['Febrero', 2], ['Marzo', 3], ['Abril', 4],
                    ['Mayo', 5], ['Junio', 6], ['Julio', 7], ['Agosto', 8],
                    ['Septiembre', 9], ['Octubre', 10], ['Noviembre', 11], ['Diciembre', 12]
                  ], Date.current.month),
                  { prompt: 'Mes' },
                  { class: "form-select form-select-sm", required: true } %>
            </div>
            <div class="col-5">
              <%= f.select :target_date_year,
                  options_for_select((Date.current.year..(Date.current.year + 45)).map { |y| [y, y] }, Date.current.year + 1),
                  { prompt: 'AÃ±o' },
                  { class: "form-select form-select-sm", required: true } %>
            </div>
          </div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success" id="create-objective-btn">
            <i class="bi bi-target me-2"></i>
            Crear Objetivo
          </button>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- ========================================= -->
<!-- 6. PRÃ“XIMO NIVEL (Colapsable) -->
<!-- ========================================= -->
<% if @next_level_progress[:target].present? %>
  <div class="accordion mt-4 mb-4" id="nextLevelAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="nextLevelHeading">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nextLevelCollapse" aria-expanded="false">
          <i class="bi bi-flag-fill me-2 text-primary"></i>
          <strong>PrÃ³ximo Nivel: <%= @next_level_progress[:target] %></strong>
          <span class="badge bg-light text-dark ms-2">
            <%= @next_level_progress[:requirements].count { |r| r[:completed] } %>/<%= @next_level_progress[:requirements].count %> requisitos
          </span>
        </button>
      </h2>
      <div id="nextLevelCollapse" class="accordion-collapse collapse" aria-labelledby="nextLevelHeading" data-bs-parent="#nextLevelAccordion">
        <div class="accordion-body">
          <p class="text-muted mb-3">Para alcanzarlo necesitas cumplir:</p>

          <% @next_level_progress[:requirements].each do |req| %>
            <div class="d-flex align-items-start mb-2">
              <i class="<%= req[:completed] ? 'bi bi-check-circle-fill text-success' : 'bi bi-circle text-muted' %> me-2" style="font-size: 1.3rem;"></i>
              <div>
                <strong><%= req[:name] %></strong>
                <% if req[:completed] %>
                  <span class="badge bg-success ms-2">âœ“</span>
                <% else %>
                  <br>
                  <small class="text-muted">
                    Actual: â‚¬<%= number_with_delimiter(req[:current], delimiter: ".") %> /
                    Objetivo: â‚¬<%= number_with_delimiter(req[:target], delimiter: ".") %>
                    <% deficit = req[:target] - req[:current] %>
                    <% if deficit > 0 %>
                      <span class="text-danger">(Faltan â‚¬<%= number_with_delimiter(deficit, delimiter: ".") %>)</span>
                    <% end %>
                  </small>
                <% end %>
              </div>
            </div>
          <% end %>

          <% completed_count = @next_level_progress[:requirements].count { |r| r[:completed] } %>
          <% total_count = @next_level_progress[:requirements].count %>
          <div class="mt-3">
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-primary" style="width: <%= (completed_count.to_f / total_count * 100).round(0) %>%"></div>
            </div>
            <small class="text-muted"><%= completed_count %>/<%= total_count %> completados</small>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- ========================================= -->
<!-- 7. ANÃLISIS FINANCIERO (Colapsable) -->
<!-- ========================================= -->
<div class="mt-4 mb-4">
  <h3 class="mb-3">
    <i class="bi bi-graph-up text-success me-2"></i>
    Tu SituaciÃ³n Financiera
  </h3>
</div>

<div class="accordion mb-4" id="financialAnalysisAccordion">
  <!-- PyG Analysis -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="pygHeading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pygCollapse">
        <i class="bi bi-graph-up me-2 text-primary"></i>
        <strong>Ingresos y Gastos (PyG)</strong>
      </button>
    </h2>
    <div id="pygCollapse" class="accordion-collapse collapse" aria-labelledby="pygHeading">
      <div class="accordion-body">
        <div class="chart-container" style="height: 300px;">
          <canvas id="pygChart"></canvas>
        </div>
        <div class="row text-center mt-3">
          <div class="col-4">
            <div class="text-success">
              <strong>Ingresos</strong><br>
              <span class="h6">â‚¬<%= number_with_delimiter(@pyg_chart_data[:income] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="text-danger">
              <strong>Gastos</strong><br>
              <span class="h6">â‚¬<%= number_with_delimiter(@pyg_chart_data[:expenses] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="<%= @pyg_chart_data[:cash_flow] > 0 ? 'text-success' : 'text-danger' %>">
              <strong>Capacidad</strong><br>
              <span class="h6">â‚¬<%= number_with_delimiter(@pyg_chart_data[:cash_flow] || 0, delimiter: ".") %></span>
            </div>
          </div>
        </div>
        <div class="mt-3 text-center">
          <%= link_to edit_pyg_path, class: "btn btn-outline-primary" do %>
            <i class="bi bi-pencil me-2"></i>
            Editar Ingresos y Gastos
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Balance Analysis -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="balanceHeading">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#balanceCollapse">
        <i class="bi bi-pie-chart me-2 text-success"></i>
        <strong>Activos y Deudas (Balance)</strong>
      </button>
    </h2>
    <div id="balanceCollapse" class="accordion-collapse collapse" aria-labelledby="balanceHeading">
      <div class="accordion-body">
        <div class="chart-container" style="height: 300px;">
          <canvas id="balanceChart"></canvas>
        </div>
        <div class="row text-center mt-3">
          <div class="col-4">
            <div class="text-success">
              <strong>Activos</strong><br>
              <span class="h6">â‚¬<%= number_with_delimiter(@balance_chart_data[:assets] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="text-danger">
              <strong>Deudas</strong><br>
              <span class="h6">â‚¬<%= number_with_delimiter(@balance_chart_data[:debt] || 0, delimiter: ".") %></span>
            </div>
          </div>
          <div class="col-4">
            <div class="<%= @balance_chart_data[:net_worth] > 0 ? 'text-success' : 'text-danger' %>">
              <strong>Patrimonio</strong><br>
              <span class="h6">â‚¬<%= number_with_delimiter(@balance_chart_data[:net_worth] || 0, delimiter: ".") %></span>
            </div>
          </div>
        </div>
        <div class="mt-3 text-center">
          <%= link_to edit_balance_path, class: "btn btn-outline-primary" do %>
            <i class="bi bi-pencil me-2"></i>
            Editar Activos y Deudas
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SCRIPTS Y MODALES -->
<!-- ========================================= -->

<!-- Scripts -->
<script>
// GrÃ¡ficos
function initSimplifiedCharts() {
  const pygElement = document.getElementById('pygChart');
  if (pygElement) {
    const pygCtx = pygElement.getContext('2d');
    const pygData = <%= raw @pyg_chart_data.to_json %>;

    new Chart(pygCtx, {
      type: 'bar',
      data: {
        labels: ['Ingresos', 'Gastos', 'Capacidad'],
        datasets: [{
          data: [pygData.income || 0, pygData.expenses || 0, Math.max(pygData.cash_flow || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', pygData.cash_flow > 0 ? '#17a2b8' : '#6c757d'],
          borderColor: ['#28a745', '#dc3545', pygData.cash_flow > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'â‚¬' + value.toLocaleString('es-ES');
              }
            }
          }
        }
      }
    });
  }

  const balanceElement = document.getElementById('balanceChart');
  if (balanceElement) {
    const balanceCtx = balanceElement.getContext('2d');
    const balanceData = <%= raw @balance_chart_data.to_json %>;

    new Chart(balanceCtx, {
      type: 'bar',
      data: {
        labels: ['Activos', 'Deudas', 'Patrimonio'],
        datasets: [{
          data: [balanceData.assets || 0, balanceData.debt || 0, Math.max(balanceData.net_worth || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', balanceData.net_worth > 0 ? '#17a2b8' : '#6c757d'],
          borderColor: ['#28a745', '#dc3545', balanceData.net_worth > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'â‚¬' + value.toLocaleString('es-ES');
              }
            }
          }
        }
      }
    });
  }
}

document.addEventListener('turbo:load', initSimplifiedCharts);

// AnimaciÃ³n de carga al crear objetivo
document.addEventListener('turbo:load', function() {
  const createObjectiveForm = document.getElementById('create-objective-form');
  const createObjectiveBtn = document.getElementById('create-objective-btn');

  if (createObjectiveForm && createObjectiveBtn) {
    let isSubmitting = false;

    createObjectiveForm.addEventListener('submit', function(e) {
      if (!isSubmitting && createObjectiveForm.checkValidity()) {
        e.preventDefault();
        isSubmitting = true;

        const loadingModal = new bootstrap.Modal(document.getElementById('createObjectiveLoadingModal'));
        loadingModal.show();

        const steps = ['objective-step-1', 'objective-step-2', 'objective-step-3'];
        const progressBar = document.getElementById('objective-progress-bar');
        let currentStepIndex = 0;

        function activateStep(index) {
          if (index < steps.length) {
            const stepElement = document.getElementById(steps[index]);
            stepElement.classList.add('active');

            const progress = ((index + 1) / steps.length) * 100;
            progressBar.style.width = progress + '%';

            currentStepIndex++;
            if (currentStepIndex < steps.length) {
              setTimeout(() => activateStep(currentStepIndex), 650);
            } else {
              setTimeout(function() {
                loadingModal.hide();
                setTimeout(function() {
                  createObjectiveForm.submit();
                }, 300);
              }, 400);
            }
          }
        }

        setTimeout(() => activateStep(0), 300);
      }
    });
  }
});
</script>

<!-- Include Level Guide Modal -->
<%= render 'dashboard/level_guide_modal' %>

<!-- Modal de carga al crear objetivo -->
<div class="modal fade" id="createObjectiveLoadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center py-5">

        <!-- Animated Icon -->
        <div class="mb-4">
          <div class="processing-icon-container">
            <i class="bi bi-bullseye text-success processing-icon"></i>
            <div class="processing-ring"></div>
            <div class="processing-ring-2"></div>
          </div>
        </div>

        <!-- Processing Text -->
        <h3 class="fw-bold mb-3">
          Creando tu objetivo
        </h3>
        <p class="text-muted mb-4">
          Estamos generando tu plan personalizado...
        </p>

        <!-- Progress Steps -->
        <div class="processing-steps mb-4">
          <div class="processing-step" id="objective-step-1">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span>Analizando tu capacidad de ahorro</span>
          </div>
          <div class="processing-step" id="objective-step-2">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span>Calculando plazo y rentabilidad</span>
          </div>
          <div class="processing-step" id="objective-step-3">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span>Seleccionando mejor producto</span>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress mx-auto" style="max-width: 350px; height: 6px;">
          <div class="progress-bar progress-bar-animated bg-success" role="progressbar" style="width: 0%;" id="objective-progress-bar"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
/* ========================================= */
/* ESTILOS CURRENT TASK HERO */
/* ========================================= */
.current-task-hero .card {
  border-radius: 1rem;
  transition: all 0.3s ease;
}

.current-task-hero .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(25, 135, 84, 0.2);
}

.task-benefit {
  border-left: 4px solid #198754;
}

/* ========================================= */
/* ESTILOS PROGRESS SECTION */
/* ========================================= */
.progress-section .card {
  border-radius: 0.5rem;
  border: 1px solid #e9ecef;
}

/* ========================================= */
/* ESTILOS PLAN COMPLETO */
/* ========================================= */
.accordion-button:not(.collapsed) {
  background-color: #f8f9fa;
  color: #0D6EFD;
}

/* ========================================= */
/* ESTILOS MODAL DE CARGA */
/* ========================================= */
#createObjectiveLoadingModal .modal-content {
  border-radius: 1rem;
}

.processing-icon-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.processing-icon {
  font-size: 3.5rem;
  position: relative;
  z-index: 2;
  animation: pulse 2s ease-in-out infinite;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
}

.processing-ring,
.processing-ring-2 {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  border: 3px solid transparent;
  border-top-color: #22c55e;
  border-radius: 50%;
  animation: spin 1.5s linear infinite;
}

.processing-ring-2 {
  border-top-color: #10b981;
  animation: spin 2s linear infinite reverse;
  opacity: 0.5;
}

@keyframes spin {
  0% {
    transform: translate(-50%, -50%) rotate(0deg);
  }
  100% {
    transform: translate(-50%, -50%) rotate(360deg);
  }
}

.processing-steps {
  max-width: 400px;
  margin: 0 auto;
  text-align: left;
}

.processing-step {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin-bottom: 8px;
  background: #f8f9fa;
  border-radius: 8px;
  opacity: 0.3;
  transition: opacity 0.5s ease;
}

.processing-step i {
  font-size: 1.2rem;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.processing-step.active {
  opacity: 1;
}

.processing-step.active i {
  opacity: 1;
}

.processing-step span {
  font-weight: 500;
  color: #6c757d;
}
</style>
