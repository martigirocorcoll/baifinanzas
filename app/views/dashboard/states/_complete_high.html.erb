<!-- DASHBOARD HIGH LEVEL: Situación Estable, Crecimiento Patrimonial, Libertad Financiera -->
<!-- NUEVA ESTRUCTURA: 3 SECCIONES PRINCIPALES -->

<!-- I18n data for JavaScript -->
<div id="i18n-dashboard-data" class="d-none"
     data-locale="<%= I18n.locale %>"
     data-step="<%= t('views.dashboard.complete.financial_plan.step', number: '%{number}') %>"
     data-completed="<%= t('views.dashboard.complete.financial_plan.completed_button') %>"
     data-mark-completed="<%= t('views.dashboard.complete.financial_plan.mark_completed') %>"
     data-view-how-to="<%= t('views.dashboard.complete.financial_plan.view_how_to') %>"
     data-financial-impact="<%= t('views.dashboard.complete.financial_plan.financial_impact') %>"
     data-reached-level="<%= t('views.dashboard.complete.objectives.reached_level') %>"
     data-create-first="<%= t('views.dashboard.complete.objectives.create_first') %>"
     data-reach-goal="<%= t('views.dashboard.complete.objectives.reach_goal', title: '%{title}') %>"
     data-edit-goal="<%= t('views.dashboard.complete.objectives.edit_goal', title: '%{title}') %>"
     data-new-goal-amount="<%= t('views.dashboard.complete.objectives.new_goal_amount') %>"
     data-new-deadline="<%= t('views.dashboard.complete.objectives.new_deadline') %>"
     data-save="<%= t('views.dashboard.complete.objectives.save') %>"
     data-cancel="<%= t('views.dashboard.complete.objectives.cancel') %>"
     data-view-full-plan="<%= t('views.dashboard.complete.objectives.view_full_plan') %>"
     data-delete-confirm="<%= t('views.dashboard.complete.objectives.delete_confirm') %>"
     data-delete="<%= t('views.dashboard.complete.objectives.delete') %>"
     data-objective-description="<%= t('views.dashboard.complete.objectives.objective_description', title: '%{title}', months: '%{months}', product: '%{product}', monthly: '%{monthly}', target: '%{target}') %>"
     data-goal-summary="<%= t('views.dashboard.complete.objectives.goal_summary', amount: '%{amount}', months: '%{months}') %>"
     data-edit-goal-title="<%= t('views.dashboard.complete.objectives.edit_goal_title') %>"
     data-investment-deposit="<%= t('views.investment_types.ac_diposit') %>"
     data-investment-medium="<%= t('views.investment_types.ac_curt') %>"
     data-investment-long="<%= t('views.investment_types.ac_llarg') %>"
     data-investment-pension="<%= t('views.investment_types.ac_jubil') %>"
     data-months='<%= t('views.dashboard.months').to_json.html_safe %>'>
</div>

<!-- MARGEN SUPERIOR -->
<div class="mt-4"></div>

<!-- ========================================= -->
<!-- SECCIÓN 1: NIVEL FINANCIERO -->
<!-- ========================================= -->
<div class="dashboard-section mb-4">
  <h3 class="section-title mb-3">
    <i class="bi bi-trophy-fill text-warning me-2"></i>
    <%= t('views.dashboard.complete.financial_level.title') %>
  </h3>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">
      <!-- Nivel actual -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <i class="<%= @mountain_state[:bootstrap_icon] %> me-3 text-warning" style="font-size: 2.5rem;"></i>
          <div>
            <h4 class="mb-1 fw-bold"><%= @mountain_state[:name] %></h4>
            <span class="badge bg-warning text-dark"><%= t('views.dashboard.complete.financial_level.level_badge', current: current_user.financial_health_level_number) %></span>
          </div>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#levelGuideModal">
          <i class="bi bi-info-circle me-1"></i>
          <%= t('views.dashboard.complete.financial_level.level_guide') %>
        </button>
      </div>

      <p class="text-muted mb-3"><%= @mountain_state[:description] %></p>

      <!-- Próximo nivel (accordion) -->
      <% if @next_level_progress[:target].present? %>
        <div class="accordion accordion-flush" id="nextLevelAccordion">
          <div class="accordion-item border-0">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#nextLevelCollapse">
                <i class="bi bi-flag-fill me-2 text-primary"></i>
                <strong><%= t('views.dashboard.complete.financial_level.next_level', target: @next_level_progress[:target]) %></strong>
                <span class="badge bg-light text-dark ms-2">
                  <%= @next_level_progress[:requirements].count { |r| r[:completed] } %>/<%= @next_level_progress[:requirements].count %> <%= t('views.dashboard.complete.financial_level.requirements') %>
                </span>
              </button>
            </h2>
            <div id="nextLevelCollapse" class="accordion-collapse collapse">
              <div class="accordion-body">
                <p class="text-muted mb-3"><%= t('views.dashboard.complete.financial_level.requirements_to_reach') %></p>
                <% @next_level_progress[:requirements].each do |req| %>
                  <div class="d-flex align-items-start mb-2">
                    <i class="<%= req[:completed] ? 'bi bi-check-circle-fill text-success' : 'bi bi-circle text-muted' %> me-2" style="font-size: 1.2rem;"></i>
                    <div>
                      <strong><%= req[:name] %></strong>
                      <% unless req[:completed] %>
                        <br>
                        <small class="text-muted">
                          <%= t('views.dashboard.complete.financial_level.current') %>: €<%= number_with_delimiter(req[:current], delimiter: ".") %> /
                          <%= t('views.dashboard.complete.financial_level.target') %>: €<%= number_with_delimiter(req[:target], delimiter: ".") %>
                          <% deficit = req[:target] - req[:current] %>
                          <% if deficit > 0 %>
                            <span class="text-danger">(<%= t('views.dashboard.complete.financial_level.remaining') %> €<%= number_with_delimiter(deficit, delimiter: ".") %>)</span>
                          <% end %>
                        </small>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SECCIÓN 2: PLAN FINANCIERO (INTERACTIVO) -->
<!-- ========================================= -->
<div class="dashboard-section mb-4">
  <h3 class="section-title mb-3">
    <i class="bi bi-list-check text-success me-2"></i>
    <%= t('views.dashboard.complete.financial_plan.title') %>
  </h3>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">

      <!-- A. Barra de progreso -->
      <div class="progress-header mb-4 pb-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-bold"><%= t('views.dashboard.complete.financial_plan.progress') %></span>
          <span class="badge bg-primary" style="font-size: 0.9rem;">
            <%= @completed_count %>/<%= @total_count %> <%= t('views.dashboard.complete.financial_plan.completed') %>
          </span>
        </div>
        <div class="progress" style="height: 20px;">
          <div class="progress-bar bg-success" role="progressbar"
               style="width: <%= @progress_percentage %>%;">
            <strong><%= @progress_percentage %>%</strong>
          </div>
        </div>
      </div>

      <!-- Layout responsive: desktop vs mobile -->
      <div class="financial-plan-layout">
        <div class="row g-4">

          <!-- C. Lista de pasos (sidebar en desktop, abajo en mobile) -->
          <div class="col-lg-4 order-lg-1 order-2">
            <div class="steps-sidebar">
              <h6 class="text-muted text-uppercase small mb-3"><%= t('views.dashboard.complete.financial_plan.steps_title') %></h6>

              <div class="steps-list">
                <% @action_plan.each_with_index do |action, index| %>
                  <% is_create_objective = action[:type] == 'create_objective' %>
                  <% is_first_uncompleted = @current_task && action[:position] == @current_task[:position] %>

                  <% if is_create_objective %>
                    <!-- Botón especial para crear objetivo -->
                    <div class="create-objective-button"
                         data-step-id="<%= action[:position] %>"
                         data-step-type="<%= action[:type] %>"
                         onclick="selectStep(<%= action[:position] %>)">
                      <i class="<%= action[:icon] %> me-2"></i>
                      <%= action[:title] %>
                    </div>
                  <% else %>
                    <!-- Step item normal -->
                    <div class="step-item <%= 'completed' if action[:completed] %> <%= 'is-next' if is_first_uncompleted %>"
                         data-step-id="<%= action[:position] %>"
                         data-step-type="<%= action[:type] %>"
                         onclick="selectStep(<%= action[:position] %>)">

                      <!-- Content -->
                      <div class="step-content">
                        <div class="step-title">
                          <div class="d-flex align-items-center w-100">
                            <span class="step-number-small text-muted me-2 flex-shrink-0"><%= action[:position] %></span>
                            <div class="task-icon-circle flex-shrink-0 me-2">
                              <i class="<%= action[:icon] %>"></i>
                            </div>
                            <span class="flex-grow-1"><%= action[:title] %></span>
                          </div>
                        </div>
                      </div>

                      <!-- Icon con funcionalidad de click para completar/descompletar -->
                      <div class="step-icon"
                           <% if action[:type] == 'recommendation' %>
                             onclick="event.stopPropagation(); toggleAction('<%= action[:key] %>', 'recommendation', <%= action[:completed] ? 'true' : 'false' %>);"
                             style="cursor: pointer;"
                             title="<%= action[:completed] ? t('views.dashboard.complete.financial_plan.unmark') : t('views.dashboard.complete.financial_plan.mark_completed') %>"
                           <% end %>>
                        <% if action[:completed] %>
                          <i class="bi bi-check-circle-fill text-success"></i>
                        <% elsif is_first_uncompleted %>
                          <i class="bi bi-arrow-right-circle text-primary"></i>
                        <% else %>
                          <i class="bi bi-circle text-muted"></i>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>

          <!-- B. Zona display principal -->
          <div class="col-lg-8 order-lg-2 order-1" style="border-left: 1px solid #dee2e6;">
            <div id="step-display" class="step-display">

              <!-- Por defecto: siguiente paso o mensaje de completado -->
              <% if @current_task.present? %>
                <div class="step-display-content" id="step-content-<%= @current_task[:position] %>">

                  <!-- Header con título y link completar -->
                  <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                      <span class="badge bg-secondary mb-3"><%= t('views.dashboard.complete.financial_plan.step', number: @current_task[:position]) %></span>
                      <h2 class="fw-bold mb-0">
                        <i class="<%= @current_task[:icon] %> me-2 text-muted"></i>
                        <span class="ms-2">
                          <% if @current_task[:type] == 'recommendation' && @current_task[:recommendation] %>
                            <%= @current_task[:recommendation][:title] %>
                          <% else %>
                            <%= @current_task[:title] %>
                          <% end %>
                        </span>
                      </h2>
                    </div>
                    <% if @current_task[:type] == 'recommendation' %>
                      <%= form_with url: complete_action_path, method: :post, local: true, class: "d-inline" do |f| %>
                        <%= f.hidden_field :action_type, value: 'recommendation' %>
                        <%= f.hidden_field :action_key, value: @current_task[:key] %>
                        <% if @current_task[:completed] %>
                          <button type="submit" class="btn btn-sm btn-success">
                            <i class="bi bi-check-circle-fill me-1"></i>
                            <%= t('views.dashboard.complete.financial_plan.completed_button') %>
                          </button>
                        <% else %>
                          <button type="submit" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-check-circle me-1"></i>
                            <%= t('views.dashboard.complete.financial_plan.mark_completed') %>
                          </button>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>

                  <% if @current_task[:type] == 'recommendation' %>
                    <!-- Video del influencer -->
                    <% if @current_task[:video_url].present? %>
                      <div class="ratio ratio-16x9 mb-4">
                        <iframe src="<%= @current_task[:video_url] %>" allowfullscreen class="rounded"></iframe>
                      </div>
                    <% end %>

                    <!-- Descripción -->
                    <% if @current_task.dig(:recommendation, :description).present? %>
                      <div class="mb-4">
                        <p class="text-muted" style="font-size: 1.05rem; line-height: 1.6;">
                          <%= @current_task[:recommendation][:description] %>
                        </p>
                      </div>
                    <% end %>

                    <!-- Botón CTA principal (PROTAGONISTA) -->
                    <div class="d-grid mb-3">
                      <%= link_to recommendation_path(@current_task[:slug]), class: "btn btn-primary btn-lg", style: "padding: 1rem 2rem; font-size: 1.1rem;" do %>
                        <i class="bi bi-arrow-right-circle me-2"></i>
                        <%= t('views.dashboard.complete.financial_plan.view_how_to') %>
                      <% end %>
                    </div>

                    <!-- Badge de beneficio (discreto, abajo) -->
                    <div class="border border-success-subtle rounded p-2 bg-light-subtle">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-piggy-bank fs-5 me-3 text-success-emphasis"></i>
                        <div>
                          <strong class="d-block mb-0 text-success-emphasis" style="font-size: 0.95rem;"><%= @current_task[:benefit_text] %></strong>
                          <small class="text-muted" style="font-size: 0.85rem;"><%= t('views.dashboard.complete.financial_plan.financial_impact') %></small>
                        </div>
                      </div>
                    </div>

                  <% elsif @current_task[:type] == 'create_objective' %>
                    <div class="text-center mb-4">
                      <i class="bi bi-bullseye" style="font-size: 4rem; color: #6c757d;"></i>
                      <p class="text-muted mt-3">
                        <%= t('views.dashboard.complete.objectives.reached_level') %>
                      </p>
                    </div>
                    <div class="d-grid">
                      <button class="btn btn-primary btn-lg" onclick="showCreateObjectiveForm()">
                        <i class="bi bi-plus-circle me-2"></i>
                        <%= t('views.dashboard.complete.objectives.create_first') %>
                      </button>
                    </div>

                  <% elsif @current_task[:type] == 'objective' %>
                    <div class="mb-4">
                      <p class="text-muted">
                        <%= t('views.dashboard.complete.objectives.goal') %>: <strong>€<%= number_with_delimiter(@current_task[:objective].target_amount, delimiter: ".") %></strong>
                        <%= t('views.dashboard.complete.objectives.in_time', time: distance_of_time_in_words(Date.current, @current_task[:objective].target_date)) %>
                      </p>
                      <p class="text-info">
                        <i class="bi bi-piggy-bank me-2"></i>
                        <%= t('views.dashboard.complete.objectives.monthly_savings') %>: <strong>€<%= number_with_delimiter(@current_task[:objective].monthly_savings_needed, delimiter: ".") %></strong>
                      </p>
                    </div>
                    <div class="d-grid gap-2">
                      <%= link_to recommendation_path(@current_task[:objective].investment_recommendation, objetivo_id: @current_task[:objective].id),
                          class: "btn btn-primary btn-lg" do %>
                        <i class="bi bi-arrow-right-circle me-2"></i>
                        <%= t('views.dashboard.complete.objectives.view_investment_plan') %>
                      <% end %>
                      <%= button_to objective_path(@current_task[:objective]),
                          method: :delete,
                          class: "btn btn-outline-danger",
                          data: {
                            turbo_confirm: t('views.dashboard.complete.objectives.delete_confirm')
                          } do %>
                        <i class="bi bi-trash me-2"></i>
                        <%= t('views.dashboard.complete.objectives.delete') %>
                      <% end %>
                    </div>
                  <% end %>

                </div>
              <% else %>
                <!-- Todas las acciones completadas -->
                <div class="text-center py-5">
                  <i class="bi bi-trophy-fill text-success" style="font-size: 5rem;"></i>
                  <h3 class="mt-4 fw-bold"><%= t('views.dashboard.complete.financial_plan.all_completed_title') %></h3>
                  <p class="text-muted mb-4">
                    <%= t('views.dashboard.complete.financial_plan.all_completed_description') %>
                  </p>
                  <div class="d-flex gap-2 justify-content-center">
                    <%= link_to edit_pyg_path, class: "btn btn-success" do %>
                      <i class="bi bi-graph-up me-2"></i>
                      <%= t('views.dashboard.complete.financial_plan.update_pyg') %>
                    <% end %>
                    <%= link_to edit_balance_path, class: "btn btn-success" do %>
                      <i class="bi bi-pie-chart me-2"></i>
                      <%= t('views.dashboard.complete.financial_plan.update_balance') %>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <!-- Contenedor para formulario de crear objetivo (se muestra dinámicamente) -->
              <div id="create-objective-form-container" style="display: none;">
                <div class="step-display-content">
                  <!-- Header explicativo -->
                  <div class="mb-3">
                    <h4 class="fw-bold mb-3">
                      <i class="bi bi-bullseye me-2 text-primary"></i>
                      <%= t('views.dashboard.complete.objectives.create_title') %>
                    </h4>
                    <p class="text-muted mb-0" style="line-height: 1.6;">
                      <%= t('views.dashboard.complete.objectives.create_description') %>
                    </p>
                  </div>

                  <!-- Ejemplos de objetivos -->
                  <div class="mb-4">
                    <label class="form-label fw-bold small text-muted mb-2" style="opacity: 0.7;"><%= t('views.dashboard.complete.objectives.examples_title') %></label>
                    <div class="d-flex flex-wrap gap-2">
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillObjectiveExample('<%= t('views.dashboard.complete.objectives.example_car') %>', 25000, 12)">
                        <i class="bi bi-car-front me-1"></i> <%= t('views.dashboard.complete.objectives.example_car') %>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillObjectiveExample('<%= t('views.dashboard.complete.objectives.example_house') %>', 60000, 48)">
                        <i class="bi bi-house-door me-1"></i> <%= t('views.dashboard.complete.objectives.example_house') %>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillObjectiveExample('<%= t('views.dashboard.complete.objectives.example_wedding') %>', 15000, 18)">
                        <i class="bi bi-heart me-1"></i> <%= t('views.dashboard.complete.objectives.example_wedding') %>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillObjectiveExample('<%= t('views.dashboard.complete.objectives.example_travel') %>', 8000, 12)">
                        <i class="bi bi-airplane me-1"></i> <%= t('views.dashboard.complete.objectives.example_travel') %>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillObjectiveExample('<%= t('views.dashboard.complete.objectives.example_education') %>', 40000, 120)">
                        <i class="bi bi-mortarboard me-1"></i> <%= t('views.dashboard.complete.objectives.example_education') %>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="fillObjectiveExample('<%= t('views.dashboard.complete.objectives.example_retirement') %>', 500000, 240)">
                        <i class="bi bi-piggy-bank me-1"></i> <%= t('views.dashboard.complete.objectives.example_retirement') %>
                      </button>
                    </div>
                  </div>

                  <%= form_with model: @new_objective, local: true, id: "create-objective-form" do |f| %>
                    <%= f.hidden_field :user_id, value: current_user.id %>

                    <div class="mb-3">
                      <label class="form-label fw-bold"><%= t('views.dashboard.complete.objectives.field_title') %></label>
                      <%= f.text_field :title, class: "form-control form-control-lg", placeholder: t('views.objectives_form.title_placeholder'), required: true, id: "objective-title-input" %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-bold"><%= t('views.dashboard.complete.objectives.field_amount') %></label>
                      <%= f.number_field :target_amount, class: "form-control form-control-lg", placeholder: t('views.objectives_form.amount_placeholder'), required: true, id: "objective-amount-input" %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-bold"><%= t('views.dashboard.complete.objectives.field_date') %></label>
                      <div class="row g-2">
                        <div class="col-7">
                          <%= f.select :target_date_month,
                              options_for_select([
                                [t('views.dashboard.months.january'), 1], [t('views.dashboard.months.february'), 2], [t('views.dashboard.months.march'), 3], [t('views.dashboard.months.april'), 4],
                                [t('views.dashboard.months.may'), 5], [t('views.dashboard.months.june'), 6], [t('views.dashboard.months.july'), 7], [t('views.dashboard.months.august'), 8],
                                [t('views.dashboard.months.september'), 9], [t('views.dashboard.months.october'), 10], [t('views.dashboard.months.november'), 11], [t('views.dashboard.months.december'), 12]
                              ], Date.current.month),
                              { prompt: '' },
                              { class: "form-select", required: true, id: "objective-month-input" } %>
                        </div>
                        <div class="col-5">
                          <%= f.select :target_date_year,
                              options_for_select((Date.current.year..(Date.current.year + 45)).map { |y| [y, y] }, Date.current.year + 1),
                              { prompt: '' },
                              { class: "form-select", required: true, id: "objective-year-input" } %>
                        </div>
                      </div>
                    </div>

                    <div class="d-flex gap-2 mb-3">
                      <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-check-circle me-2"></i>
                        <%= t('views.dashboard.complete.objectives.create_button') %>
                      </button>
                      <button type="button" class="btn btn-outline-secondary" onclick="hideCreateObjectiveForm()">
                        <%= t('views.dashboard.complete.objectives.cancel') %>
                      </button>
                    </div>

                    <!-- Info box de qué pasará después -->
                    <div class="app-note mb-0">
                      <div class="d-flex">
                        <i class="bi bi-info-circle fs-5 me-3"></i>
                        <div>
                          <strong class="d-block mb-1"><%= t('views.dashboard.complete.objectives.info_title') %></strong>
                          <small>
                            <%= t('views.dashboard.complete.objectives.info_description') %>
                          </small>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SECCIÓN 3: SITUACIÓN FINANCIERA -->
<!-- ========================================= -->
<div class="dashboard-section mb-4">
  <h3 class="section-title mb-3">
    <i class="bi bi-graph-up text-primary me-2"></i>
    <%= t('views.dashboard.complete.financial_situation.title') %>
  </h3>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">

      <!-- Capacidad de ahorro (siempre visible) -->
      <div class="mb-4">
        <h6 class="text-muted text-uppercase small mb-3"><%= t('views.dashboard.complete.financial_situation.savings_capacity') %></h6>

        <%
          theoretical_capacity = @monthly_cash_flow
          committed_capacity = @active_objectives.sum { |obj| obj.monthly_savings_needed }
          available_capacity = theoretical_capacity - committed_capacity
          utilization_rate = theoretical_capacity > 0 ? (committed_capacity.to_f / theoretical_capacity * 100).round(0) : 0
        %>

        <div class="row g-3 mb-3">
          <div class="col-4">
            <div class="text-center">
              <small class="text-muted d-block"><%= t('views.dashboard.complete.financial_situation.cash_flow') %></small>
              <strong class="h5 <%= theoretical_capacity > 0 ? 'text-primary' : 'text-danger' %>">
                €<%= number_with_delimiter(theoretical_capacity, delimiter: ".") %>
              </strong>
            </div>
          </div>
          <div class="col-4">
            <div class="text-center">
              <small class="text-muted d-block"><%= t('views.dashboard.complete.financial_situation.committed') %></small>
              <strong class="h5 text-info">
                €<%= number_with_delimiter(committed_capacity, delimiter: ".") %>
              </strong>
            </div>
          </div>
          <div class="col-4">
            <div class="text-center">
              <small class="text-muted d-block"><%= t('views.dashboard.complete.financial_situation.available') %></small>
              <strong class="h5 <%= available_capacity >= 0 ? 'text-success' : 'text-danger' %>">
                €<%= number_with_delimiter(available_capacity, delimiter: ".") %>
              </strong>
            </div>
          </div>
        </div>

        <% if theoretical_capacity > 0 %>
          <div class="progress" style="height: 16px;">
            <% bar_color = utilization_rate < 70 ? 'bg-success' : (utilization_rate < 90 ? 'bg-warning' : 'bg-danger') %>
            <div class="progress-bar <%= bar_color %>" style="width: <%= [utilization_rate, 100].min %>%">
              <%= utilization_rate %>%
            </div>
          </div>

          <% if utilization_rate >= 100 %>
            <small class="text-danger">
              <i class="bi bi-exclamation-triangle me-1"></i>
              <%= t('views.dashboard.complete.financial_situation.exceeds_capacity') %>
            </small>
          <% elsif utilization_rate >= 70 %>
            <small class="text-warning">
              <i class="bi bi-info-circle me-1"></i>
              <%= t('views.dashboard.complete.financial_situation.high_utilization') %>
            </small>
          <% end %>
        <% else %>
          <div class="alert alert-danger mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong><%= t('views.dashboard.complete.financial_situation.negative_capacity') %></strong> <%= t('views.dashboard.complete.financial_situation.negative_capacity_description') %>
          </div>
        <% end %>
      </div>

      <!-- PyG y Balance (accordions) -->
      <div class="accordion" id="financialAnalysisAccordion">

        <!-- PyG -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pygCollapse">
              <i class="bi bi-graph-up me-2 text-primary"></i>
              <strong><%= t('views.dashboard.complete.financial_situation.pyg_title') %></strong>
            </button>
          </h2>
          <div id="pygCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="chart-container mb-3" style="height: 300px;">
                <canvas id="pygChart"></canvas>
              </div>
              <div class="row text-center">
                <div class="col-4">
                  <div class="text-success">
                    <strong><%= t('views.dashboard.complete.financial_situation.income') %></strong><br>
                    <span class="h6">€<%= number_with_delimiter(@pyg_chart_data[:income] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="text-danger">
                    <strong><%= t('views.dashboard.complete.financial_situation.expenses') %></strong><br>
                    <span class="h6">€<%= number_with_delimiter(@pyg_chart_data[:expenses] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="<%= @pyg_chart_data[:cash_flow] > 0 ? 'text-success' : 'text-danger' %>">
                    <strong><%= t('views.dashboard.complete.financial_situation.capacity') %></strong><br>
                    <span class="h6">€<%= number_with_delimiter(@pyg_chart_data[:cash_flow] || 0, delimiter: ".") %></span>
                  </div>
                </div>
              </div>
              <div class="mt-3 text-center">
                <%= link_to edit_pyg_path, class: "btn btn-outline-primary" do %>
                  <i class="bi bi-pencil me-2"></i>
                  <%= t('views.dashboard.complete.financial_situation.edit_pyg') %>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Balance -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#balanceCollapse">
              <i class="bi bi-pie-chart me-2 text-success"></i>
              <strong><%= t('views.dashboard.complete.financial_situation.balance_title') %></strong>
            </button>
          </h2>
          <div id="balanceCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="chart-container mb-3" style="height: 300px;">
                <canvas id="balanceChart"></canvas>
              </div>
              <div class="row text-center">
                <div class="col-4">
                  <div class="text-success">
                    <strong><%= t('views.dashboard.complete.financial_situation.assets') %></strong><br>
                    <span class="h6">€<%= number_with_delimiter(@balance_chart_data[:assets] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="text-danger">
                    <strong><%= t('views.dashboard.complete.financial_situation.debts') %></strong><br>
                    <span class="h6">€<%= number_with_delimiter(@balance_chart_data[:debt] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="<%= @balance_chart_data[:net_worth] > 0 ? 'text-success' : 'text-danger' %>">
                    <strong><%= t('views.dashboard.complete.financial_situation.net_worth') %></strong><br>
                    <span class="h6">€<%= number_with_delimiter(@balance_chart_data[:net_worth] || 0, delimiter: ".") %></span>
                  </div>
                </div>
              </div>
              <div class="mt-3 text-center">
                <%= link_to edit_balance_path, class: "btn btn-outline-primary" do %>
                  <i class="bi bi-pencil me-2"></i>
                  <%= t('views.dashboard.complete.financial_situation.edit_balance') %>
                <% end %>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SCRIPTS -->
<!-- ========================================= -->
<script>
// Variables globales para el plan de acción
let actionPlanData = <%= raw @action_plan.to_json %>;
let currentStepId = <%= @current_task ? @current_task[:position] : 'null' %>;

// Get i18n translations from data attributes
const i18nData = document.getElementById('i18n-dashboard-data').dataset;
const monthsData = JSON.parse(i18nData.months);

// Función para toggle (completar/descompletar) una acción
function toggleAction(actionKey, actionType, isCompleted) {
  const action = isCompleted ? 'uncomplete' : 'complete';
  const url = isCompleted ? '/dashboard/uncomplete_action' : '/dashboard/complete_action';

  console.log(`${action} action:`, actionKey, actionType);

  // Crear formulario y enviarlo
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = url;

  // CSRF token
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'authenticity_token';
  csrfInput.value = csrfToken;
  form.appendChild(csrfInput);

  // Action type
  const typeInput = document.createElement('input');
  typeInput.type = 'hidden';
  typeInput.name = 'action_type';
  typeInput.value = actionType;
  form.appendChild(typeInput);

  // Action key
  const keyInput = document.createElement('input');
  keyInput.type = 'hidden';
  keyInput.name = 'action_key';
  keyInput.value = actionKey;
  form.appendChild(keyInput);

  // Añadir al DOM y enviar
  document.body.appendChild(form);
  form.submit();
}

// Función para seleccionar un paso
function selectStep(stepId) {
  const step = actionPlanData.find(s => s.position === stepId);
  if (!step) {
    console.error('Step not found:', stepId);
    return;
  }

  console.log('Selecting step:', step);

  // Ocultar contenido inicial si existe
  const initialContent = document.querySelector('#step-display .step-display-content');
  if (initialContent && !initialContent.id.includes('js-generated')) {
    initialContent.style.display = 'none';
  }

  // Ocultar formulario de crear objetivo si está visible
  document.getElementById('create-objective-form-container').style.display = 'none';

  // Si es "crear objetivo", mostrar formulario
  if (step.type === 'create_objective') {
    showCreateObjectiveForm();
    return;
  }

  // Actualizar estados visuales
  document.querySelectorAll('.step-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelectorAll('.create-objective-button').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-step-id="${stepId}"]`)?.classList.add('active');

  // Actualizar contenido del display
  updateStepDisplay(step);
}

// Mostrar formulario de crear objetivo
function showCreateObjectiveForm() {
  console.log('Showing create objective form');

  // Ocultar contenido inicial si existe
  const initialContent = document.querySelector('#step-display .step-display-content');
  if (initialContent && !initialContent.id.includes('js-generated')) {
    initialContent.style.display = 'none';
  }

  // Ocultar contenido generado por JS si existe
  const jsGenerated = document.getElementById('js-generated-content');
  if (jsGenerated) {
    jsGenerated.remove();
  }

  // Mostrar formulario
  document.getElementById('create-objective-form-container').style.display = 'block';

  // Marcar como activo en lista
  document.querySelectorAll('.step-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelectorAll('.create-objective-button').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector('[data-step-type="create_objective"]')?.classList.add('active');

  // Scroll suave
  document.getElementById('create-objective-form-container').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Ocultar formulario de crear objetivo
function hideCreateObjectiveForm() {
  document.getElementById('create-objective-form-container').style.display = 'none';

  // Volver a mostrar el paso actual por defecto
  if (currentStepId) {
    selectStep(currentStepId);
  }
}

// Rellenar formulario con ejemplo de objetivo
function fillObjectiveExample(title, amount, months) {
  // Rellenar título y cantidad
  document.getElementById('objective-title-input').value = title;
  document.getElementById('objective-amount-input').value = amount;

  // Calcular fecha objetivo (mes y año)
  const today = new Date();
  const targetDate = new Date(today.getFullYear(), today.getMonth() + months, 1);

  // Rellenar mes y año
  document.getElementById('objective-month-input').value = targetDate.getMonth() + 1;
  document.getElementById('objective-year-input').value = targetDate.getFullYear();

  // Scroll suave al formulario
  document.getElementById('create-objective-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Actualizar contenido del display
function updateStepDisplay(step) {
  console.log('Updating display with step:', step);

  const displayContainer = document.getElementById('step-display');

  // Remover cualquier contenido generado previamente
  const oldGenerated = document.getElementById('js-generated-content');
  if (oldGenerated) {
    oldGenerated.remove();
  }

  // Ocultar contenido inicial
  const initialContent = displayContainer.querySelector('.step-display-content');
  if (initialContent && !initialContent.id) {
    initialContent.style.display = 'none';
  }

  let html = '<div class="step-display-content" id="js-generated-content">';

  // Header con título y botón completar/eliminar (NUEVO DISEÑO)
  html += `
    <div class="d-flex justify-content-between align-items-start mb-4">
      <div>
        <span class="badge bg-secondary mb-3">${i18nData.step.replace('%{number}', step.position)}</span>
        <h2 class="fw-bold mb-0">
          <i class="${step.icon} me-2 text-muted"></i>
          <span class="ms-2">${step.title}</span>
        </h2>
      </div>
  `;

  // Botón marcar/desmarcar completada (solo para recommendations)
  if (step.type === 'recommendation') {
    html += `
      <form action="/dashboard/complete_action" method="post" data-turbo="false" class="d-inline">
        <input type="hidden" name="authenticity_token" value="${document.querySelector('meta[name="csrf-token"]').content}">
        <input type="hidden" name="action_type" value="recommendation">
        <input type="hidden" name="action_key" value="${step.key}">
    `;

    if (step.completed) {
      html += `
        <button type="submit" class="btn btn-sm btn-success">
          <i class="bi bi-check-circle-fill me-1"></i>
          ${i18nData.completed}
        </button>
      `;
    } else {
      html += `
        <button type="submit" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-check-circle me-1"></i>
          ${i18nData.markCompleted}
        </button>
      `;
    }

    html += `
      </form>
    `;
  }

  // Botón eliminar (solo para objectives)
  if (step.type === 'objective' && step.objective) {
    html += `
      <form action="/objectives/${step.objective.id}" method="post" data-turbo="false"
            onsubmit="return confirm('${i18nData.deleteConfirm}');" class="d-inline">
        <input type="hidden" name="_method" value="delete">
        <input type="hidden" name="authenticity_token" value="${document.querySelector('meta[name="csrf-token"]').content}">
        <button type="submit" class="btn btn-sm btn-outline-danger">
          <i class="bi bi-trash me-1"></i>
          ${i18nData.delete}
        </button>
      </form>
    `;
  }

  html += `
    </div>
  `;

  // Contenido específico según el tipo
  if (step.type === 'recommendation') {
    // Video del influencer
    if (step.video_url) {
      html += `
        <div class="ratio ratio-16x9 mb-4">
          <iframe src="${step.video_url}" allowfullscreen class="rounded"></iframe>
        </div>
      `;
    }

    // Descripción si existe
    if (step.recommendation && step.recommendation.description) {
      html += `
        <div class="mb-4">
          <p class="text-muted" style="font-size: 1.05rem; line-height: 1.6;">
            ${step.recommendation.description}
          </p>
        </div>
      `;
    }

    // Botón CTA principal (PROTAGONISTA)
    html += `
      <div class="d-grid mb-3">
        <a href="/${i18nData.locale}/recommendations/${step.slug}" class="btn btn-primary btn-lg" style="padding: 1rem 2rem; font-size: 1.1rem;">
          <i class="bi bi-arrow-right-circle me-2"></i>
          ${i18nData.viewHowTo}
        </a>
      </div>
    `;

    // Badge de beneficio (discreto, abajo)
    html += `
      <div class="border border-success-subtle rounded p-2 bg-light-subtle">
        <div class="d-flex align-items-center">
          <i class="bi bi-piggy-bank fs-5 me-3 text-success-emphasis"></i>
          <div>
            <strong class="d-block mb-0 text-success-emphasis" style="font-size: 0.95rem;">${step.benefit_text}</strong>
            <small class="text-muted" style="font-size: 0.85rem;">${i18nData.financialImpact}</small>
          </div>
        </div>
      </div>
    `;

  } else if (step.type === 'objective' && step.objective) {
    // Descripción contextual del objetivo
    const investmentType = step.objective.investment_recommendation;
    let productName = '';

    // Determinar nombre del producto según recomendación
    switch(investmentType) {
      case 'ac-diposit':
        productName = i18nData.investmentDeposit;
        break;
      case 'ac-curt':
        productName = i18nData.investmentMedium;
        break;
      case 'ac-llarg':
        productName = i18nData.investmentLong;
        break;
      case 'ac-jubil':
        productName = i18nData.investmentPension;
        break;
      default:
        productName = i18nData.investmentMedium;
    }

    // Video del influencer (si existe)
    if (step.video_url) {
      html += `
        <div class="ratio ratio-16x9 mb-4">
          <iframe src="${step.video_url}" allowfullscreen class="rounded"></iframe>
        </div>
      `;
    }

    // Descripción personalizada (usando template traducido)
    const descriptionTemplate = i18nData.objectiveDescription
      .replace('%{title}', step.title)
      .replace('%{months}', step.time_months)
      .replace('%{product}', productName)
      .replace('%{monthly}', step.objective.monthly_savings_needed.toLocaleString(i18nData.locale === 'es' ? 'es-ES' : 'en-US'))
      .replace('%{target}', step.objective.target_amount.toLocaleString(i18nData.locale === 'es' ? 'es-ES' : 'en-US'));

    html += `
      <div class="mb-4">
        <p class="text-muted" style="font-size: 1.05rem; line-height: 1.6;">
          ${descriptionTemplate}
        </p>
      </div>
    `;

    // Botón CTA principal
    html += `
      <div class="d-grid mb-3">
        <a href="/${i18nData.locale}/recommendations/${step.objective.investment_recommendation}?objetivo_id=${step.objective.id}"
           class="btn btn-primary btn-lg" style="padding: 1rem 2rem; font-size: 1.1rem;">
          <i class="bi bi-arrow-right-circle me-2"></i>
          ${i18nData.viewFullPlan}
        </a>
      </div>
    `;

    // Badge de beneficio con edición inline
    html += `
      <div class="border border-success-subtle rounded p-2 bg-light-subtle" id="objective-badge-${step.objective.id}">
        <!-- Vista normal -->
        <div id="objective-view-${step.objective.id}">
          <div class="d-flex align-items-center">
            <i class="bi bi-bullseye fs-5 me-3 text-success-emphasis"></i>
            <div class="flex-grow-1">
              <strong class="d-block mb-0 text-success-emphasis" style="font-size: 0.95rem;">${i18nData.reachGoal.replace('%{title}', step.title)}</strong>
              <small class="text-muted" style="font-size: 0.85rem;">${i18nData.goalSummary.replace('%{amount}', step.objective.target_amount.toLocaleString(i18nData.locale === 'es' ? 'es-ES' : 'en-US')).replace('%{months}', step.time_months)}</small>
            </div>
            <button type="button" class="btn btn-sm btn-link text-muted p-0 ms-2"
                    onclick="toggleEditObjective(${step.objective.id})"
                    title="${i18nData.editGoalTitle}">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        </div>

        <!-- Formulario de edición (oculto por defecto) -->
        <div id="objective-edit-${step.objective.id}" style="display: none;">
          <form onsubmit="saveObjectiveEdit(event, ${step.objective.id})">
            <div class="d-flex align-items-center mb-3">
              <i class="bi bi-bullseye fs-5 me-3 text-success-emphasis"></i>
              <strong class="text-success-emphasis" style="font-size: 0.95rem;">${i18nData.editGoal.replace('%{title}', step.title)}</strong>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold small">${i18nData.newGoalAmount}</label>
              <input type="number"
                     class="form-control form-control-sm"
                     id="edit-amount-${step.objective.id}"
                     value="${step.objective.target_amount}"
                     required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold small">${i18nData.newDeadline}</label>
              <div class="row g-2">
                <div class="col-7">
                  <select class="form-select form-select-sm" id="edit-month-${step.objective.id}" required>
                    ${generateMonthOptions(new Date(step.objective.target_date).getMonth() + 1)}
                  </select>
                </div>
                <div class="col-5">
                  <select class="form-select form-select-sm" id="edit-year-${step.objective.id}" required>
                    ${generateYearOptions(new Date(step.objective.target_date).getFullYear())}
                  </select>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-sm btn-success flex-grow-1">
                <i class="bi bi-check-circle me-1"></i>
                ${i18nData.save}
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary"
                      onclick="cancelEditObjective(${step.objective.id})">
                ${i18nData.cancel}
              </button>
            </div>
          </form>
        </div>
      </div>
    `;
  } else if (step.type === 'create_objective') {
    // Caso especial: mostrar mensaje y botón para crear
    html += `
      <div class="text-center mb-4">
        <i class="bi bi-bullseye" style="font-size: 4rem; color: #6c757d;"></i>
        <p class="text-muted mt-3">
          ${i18nData.reachedLevel}
        </p>
      </div>
      <div class="d-grid">
        <button class="btn btn-primary btn-lg" onclick="showCreateObjectiveForm()">
          <i class="bi bi-plus-circle me-2"></i>
          ${i18nData.createFirst}
        </button>
      </div>
    `;
  }

  html += '</div>';

  // Insertar el nuevo contenido
  displayContainer.insertAdjacentHTML('beforeend', html);
}

// Helper: Generar opciones de meses
function generateMonthOptions(selectedMonth) {
  const monthKeys = ['january', 'february', 'march', 'april', 'may', 'june',
                     'july', 'august', 'september', 'october', 'november', 'december'];

  return monthKeys.map((key, index) => {
    const value = index + 1;
    const selected = value === selectedMonth ? 'selected' : '';
    return `<option value="${value}" ${selected}>${monthsData[key]}</option>`;
  }).join('');
}

// Helper: Generar opciones de años
function generateYearOptions(selectedYear) {
  const currentYear = new Date().getFullYear();
  const years = [];

  for (let year = currentYear; year <= currentYear + 45; year++) {
    const selected = year === selectedYear ? 'selected' : '';
    years.push(`<option value="${year}" ${selected}>${year}</option>`);
  }

  return years.join('');
}

// Toggle edición de objetivo
function toggleEditObjective(objectiveId) {
  const viewDiv = document.getElementById(`objective-view-${objectiveId}`);
  const editDiv = document.getElementById(`objective-edit-${objectiveId}`);

  viewDiv.style.display = 'none';
  editDiv.style.display = 'block';
}

// Cancelar edición de objetivo
function cancelEditObjective(objectiveId) {
  const viewDiv = document.getElementById(`objective-view-${objectiveId}`);
  const editDiv = document.getElementById(`objective-edit-${objectiveId}`);

  viewDiv.style.display = 'block';
  editDiv.style.display = 'none';
}

// Guardar edición de objetivo
function saveObjectiveEdit(event, objectiveId) {
  event.preventDefault();

  // Obtener valores del formulario
  const amount = document.getElementById(`edit-amount-${objectiveId}`).value;
  const month = document.getElementById(`edit-month-${objectiveId}`).value;
  const year = document.getElementById(`edit-year-${objectiveId}`).value;

  // Mostrar modal de carga
  const loadingModal = new bootstrap.Modal(document.getElementById('createObjectiveLoadingModal'));
  loadingModal.show();

  const steps = ['objective-step-1', 'objective-step-2', 'objective-step-3'];
  const progressBar = document.getElementById('objective-progress-bar');
  let currentStepIndex = 0;

  function activateStep(index) {
    if (index < steps.length) {
      const stepElement = document.getElementById(steps[index]);
      stepElement.classList.add('active');

      const progress = ((index + 1) / steps.length) * 100;
      progressBar.style.width = progress + '%';

      currentStepIndex++;
      if (currentStepIndex < steps.length) {
        setTimeout(() => activateStep(currentStepIndex), 650);
      } else {
        setTimeout(function() {
          loadingModal.hide();
          setTimeout(function() {
            // Crear formulario y enviarlo
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/objectives/${objectiveId}`;

            // Token CSRF
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'authenticity_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            // Método PATCH
            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'patch';
            form.appendChild(methodInput);

            // Amount
            const amountInput = document.createElement('input');
            amountInput.type = 'hidden';
            amountInput.name = 'objective[target_amount]';
            amountInput.value = amount;
            form.appendChild(amountInput);

            // Month
            const monthInput = document.createElement('input');
            monthInput.type = 'hidden';
            monthInput.name = 'objective[target_date_month]';
            monthInput.value = month;
            form.appendChild(monthInput);

            // Year
            const yearInput = document.createElement('input');
            yearInput.type = 'hidden';
            yearInput.name = 'objective[target_date_year]';
            yearInput.value = year;
            form.appendChild(yearInput);

            // Agregar al body y enviar
            document.body.appendChild(form);
            form.submit();
          }, 300);
        }, 400);
      }
    }
  }

  setTimeout(() => activateStep(0), 300);
}

// Marcar el primer paso como activo al cargar
document.addEventListener('turbo:load', function() {
  console.log('=== PLAN FINANCIERO DEBUG ===');
  console.log('Action plan data:', actionPlanData);
  console.log('Current step ID:', currentStepId);
  console.log('Total steps:', actionPlanData.length);

  // Verificar si hay un objetivo recién creado que mostrar
  const urlParams = new URLSearchParams(window.location.search);
  const showObjectiveId = urlParams.get('show_objective');

  if (showObjectiveId) {
    console.log('Showing newly created objective:', showObjectiveId);
    // Buscar el objetivo en el action plan
    const objectiveStep = actionPlanData.find(step =>
      step.type === 'objective' &&
      step.objective &&
      step.objective.id.toString() === showObjectiveId
    );

    if (objectiveStep) {
      console.log('Found objective step:', objectiveStep);
      // Seleccionar automáticamente este paso
      setTimeout(() => {
        selectStep(objectiveStep.position);
        // Scroll suave hacia la sección del plan financiero
        const planSection = document.querySelector('#step-display');
        if (planSection) {
          planSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 300);
    }
  } else if (currentStepId) {
    document.querySelector(`[data-step-id="${currentStepId}"]`)?.classList.add('active');
  }
});

// También ejecutar al cargar directamente (no solo con turbo)
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== DOM LOADED ===');

  // Verificar si hay un objetivo recién creado que mostrar
  const urlParams = new URLSearchParams(window.location.search);
  const showObjectiveId = urlParams.get('show_objective');

  if (showObjectiveId) {
    console.log('Showing newly created objective:', showObjectiveId);
    // Buscar el objetivo en el action plan
    const objectiveStep = actionPlanData.find(step =>
      step.type === 'objective' &&
      step.objective &&
      step.objective.id.toString() === showObjectiveId
    );

    if (objectiveStep) {
      console.log('Found objective step:', objectiveStep);
      // Seleccionar automáticamente este paso
      setTimeout(() => {
        selectStep(objectiveStep.position);
        // Scroll suave hacia la sección del plan financiero
        const planSection = document.querySelector('#step-display');
        if (planSection) {
          planSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 300);
    }
  } else if (currentStepId) {
    document.querySelector(`[data-step-id="${currentStepId}"]`)?.classList.add('active');
  }
});

// Gráficos (Chart.js)
function initSimplifiedCharts() {
  const pygElement = document.getElementById('pygChart');
  if (pygElement) {
    const pygCtx = pygElement.getContext('2d');
    const pygData = <%= raw @pyg_chart_data.to_json %>;
    const chartLabelsIncome = '<%= t('views.dashboard.complete.financial_situation.income') %>';
    const chartLabelsExpenses = '<%= t('views.dashboard.complete.financial_situation.expenses') %>';
    const chartLabelsCapacity = '<%= t('views.dashboard.complete.financial_situation.capacity') %>';

    new Chart(pygCtx, {
      type: 'bar',
      data: {
        labels: [chartLabelsIncome, chartLabelsExpenses, chartLabelsCapacity],
        datasets: [{
          data: [pygData.income || 0, pygData.expenses || 0, Math.max(pygData.cash_flow || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', pygData.cash_flow > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString(i18nData.locale === 'es' ? 'es-ES' : 'en-US');
              }
            }
          }
        }
      }
    });
  }

  const balanceElement = document.getElementById('balanceChart');
  if (balanceElement) {
    const balanceCtx = balanceElement.getContext('2d');
    const balanceData = <%= raw @balance_chart_data.to_json %>;
    const chartLabelsAssets = '<%= t('views.dashboard.complete.financial_situation.assets') %>';
    const chartLabelsDebts = '<%= t('views.dashboard.complete.financial_situation.debts') %>';
    const chartLabelsNetWorth = '<%= t('views.dashboard.complete.financial_situation.net_worth') %>';

    new Chart(balanceCtx, {
      type: 'bar',
      data: {
        labels: [chartLabelsAssets, chartLabelsDebts, chartLabelsNetWorth],
        datasets: [{
          data: [balanceData.assets || 0, balanceData.debt || 0, Math.max(balanceData.net_worth || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', balanceData.net_worth > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString(i18nData.locale === 'es' ? 'es-ES' : 'en-US');
              }
            }
          }
        }
      }
    });
  }
}

document.addEventListener('turbo:load', initSimplifiedCharts);

// Animación modal crear objetivo
document.addEventListener('turbo:load', function() {
  const createObjectiveForm = document.getElementById('create-objective-form');

  if (createObjectiveForm) {
    let isSubmitting = false;

    createObjectiveForm.addEventListener('submit', function(e) {
      if (!isSubmitting && createObjectiveForm.checkValidity()) {
        e.preventDefault();
        isSubmitting = true;

        const loadingModal = new bootstrap.Modal(document.getElementById('createObjectiveLoadingModal'));
        loadingModal.show();

        const steps = ['objective-step-1', 'objective-step-2', 'objective-step-3'];
        const progressBar = document.getElementById('objective-progress-bar');
        let currentStepIndex = 0;

        function activateStep(index) {
          if (index < steps.length) {
            const stepElement = document.getElementById(steps[index]);
            stepElement.classList.add('active');

            const progress = ((index + 1) / steps.length) * 100;
            progressBar.style.width = progress + '%';

            currentStepIndex++;
            if (currentStepIndex < steps.length) {
              setTimeout(() => activateStep(currentStepIndex), 650);
            } else {
              setTimeout(function() {
                loadingModal.hide();
                setTimeout(function() {
                  createObjectiveForm.submit();
                }, 300);
              }, 400);
            }
          }
        }

        setTimeout(() => activateStep(0), 300);
      }
    });
  }
});
</script>

<!-- Modal de carga objetivo -->
<div class="modal fade" id="createObjectiveLoadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center py-5">
        <div class="mb-4">
          <div class="processing-icon-container">
            <i class="bi bi-bullseye text-success processing-icon"></i>
            <div class="processing-ring"></div>
            <div class="processing-ring-2"></div>
          </div>
        </div>
        <h3 class="fw-bold mb-3"><%= t('views.dashboard.complete.loading_modal.title') %></h3>
        <p class="text-muted mb-4"><%= t('views.dashboard.complete.loading_modal.description') %></p>
        <div class="processing-steps mb-4">
          <div class="processing-step" id="objective-step-1">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span><%= t('views.dashboard.complete.loading_modal.step1') %></span>
          </div>
          <div class="processing-step" id="objective-step-2">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span><%= t('views.dashboard.complete.loading_modal.step2') %></span>
          </div>
          <div class="processing-step" id="objective-step-3">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span><%= t('views.dashboard.complete.loading_modal.step3') %></span>
          </div>
        </div>
        <div class="progress mx-auto" style="max-width: 350px; height: 6px;">
          <div class="progress-bar progress-bar-animated bg-success" id="objective-progress-bar"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Level Guide Modal -->
<%= render 'dashboard/level_guide_modal' %>

<style>
/* ========================================= */
/* ESTILOS GENERALES */
/* ========================================= */
.section-title {
  font-size: 1.25rem;
  font-weight: 700;
}

/* ========================================= */
/* PLAN FINANCIERO - LISTA DE PASOS */
/* ========================================= */
.steps-sidebar {
  position: sticky;
  top: 100px;
}

.steps-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  max-height: 600px;
  overflow-y: auto;
  padding-right: 0.5rem;
}

/* Scrollbar styling */
.steps-list::-webkit-scrollbar {
  width: 6px;
}

.steps-list::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.steps-list::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

.steps-list::-webkit-scrollbar-thumb:hover {
  background: #555;
}

.step-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  padding: 0.75rem 0.875rem;
  border-radius: 0.5rem;
  border: 2px solid #e9ecef;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
  margin-bottom: 0.5rem;
}

.step-item:hover {
  background: #f8f9fa;
  border-color: #ced4da;
  transform: translateX(2px);
}

.step-item.active {
  border-color: #0d6efd;
  background: #e7f1ff;
  box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}

.step-item.completed {
  opacity: 0.65;
  background: #f8f9fa;
}

/* Botón especial para crear objetivo */
.create-objective-button {
  padding: 1rem;
  border-radius: 0.5rem;
  border: 2px dashed #6c757d;
  cursor: pointer;
  transition: all 0.2s;
  background: #f8f9fa;
  text-align: center;
  font-weight: 600;
  font-size: 0.95rem;
  color: #6c757d;
}

.create-objective-button:hover {
  background: #e9ecef;
  border-color: #495057;
  color: #495057;
  transform: translateY(-2px);
}

.create-objective-button.active {
  border-color: #0d6efd;
  background: #e7f1ff;
  color: #0d6efd;
  border-style: solid;
}

.step-item.is-next {
  border-color: #0dcaf0;
  background: #cff4fc;
  box-shadow: 0 2px 8px rgba(13, 202, 240, 0.15);
}

.step-icon {
  flex-shrink: 0;
  font-size: 1.2rem;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
  position: relative;
  margin-left: auto;
}

/* Círculos clickables tienen hover effect */
.step-icon[onclick] {
  cursor: pointer;
  padding: 2px;
}

.step-icon[onclick]:hover {
  background: rgba(13, 110, 253, 0.1);
  transform: scale(1.2);
}

.step-icon[onclick]:active {
  transform: scale(1.1);
}

/* Tooltip más visible */
.step-icon[title] {
  position: relative;
}

.step-content {
  flex: 1;
  min-width: 0;
}

.step-title {
  font-weight: 600;
  font-size: 0.9rem;
  line-height: 1.4;
  color: #212529;
}

.step-number-small {
  font-size: 0.8rem;
  font-weight: 500;
  opacity: 0.7;
}

.task-icon-circle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(13, 110, 253, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.task-icon-circle i {
  font-size: 1.1rem;
  color: #0d6efd;
}

.step-item:hover .task-icon-circle {
  background: rgba(13, 110, 253, 0.15);
  transform: scale(1.05);
}

.step-item.completed .task-icon-circle {
  background: rgba(25, 135, 84, 0.1);
}

.step-item.completed .task-icon-circle i {
  color: #198754;
}

.step-item.is-next .task-icon-circle {
  background: rgba(13, 110, 253, 0.15);
  box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
}

.step-meta {
  font-size: 0.75rem;
  color: #6c757d;
}

/* ========================================= */
/* PLAN FINANCIERO - DISPLAY */
/* ========================================= */
.step-display {
  min-height: 500px;
  padding-left: 2rem;
}

.step-display-content {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========================================= */
/* RESPONSIVE */
/* ========================================= */
@media (max-width: 991px) {
  .col-lg-8[style*="border-left"] {
    border-left: none !important;
    border-top: 1px solid #dee2e6 !important;
    padding-top: 2rem;
    margin-top: 2rem;
  }

  .step-display {
    padding-left: 0;
  }

  .steps-sidebar {
    position: static;
  }

  .steps-list {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .step-item {
    padding: 0.65rem 0.75rem;
    gap: 0.5rem;
  }

  .step-title {
    font-size: 0.85rem;
  }

  .step-icon {
    font-size: 1.1rem;
    width: 28px;
    height: 28px;
  }

  .task-icon-circle {
    width: 32px;
    height: 32px;
  }

  .task-icon-circle i {
    font-size: 1rem;
  }

  .step-number-small {
    font-size: 0.75rem;
  }
}

/* ========================================= */
/* MODAL LOADING */
/* ========================================= */
.processing-icon-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.processing-icon {
  font-size: 3.5rem;
  position: relative;
  z-index: 2;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

.processing-ring,
.processing-ring-2 {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  border: 3px solid transparent;
  border-top-color: #22c55e;
  border-radius: 50%;
  animation: spin 1.5s linear infinite;
}

.processing-ring-2 {
  border-top-color: #10b981;
  animation: spin 2s linear infinite reverse;
  opacity: 0.5;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.processing-steps {
  max-width: 400px;
  margin: 0 auto;
  text-align: left;
}

.processing-step {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin-bottom: 8px;
  background: #f8f9fa;
  border-radius: 8px;
  opacity: 0.3;
  transition: opacity 0.5s ease;
}

.processing-step i {
  font-size: 1.2rem;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.processing-step.active {
  opacity: 1;
}

.processing-step.active i {
  opacity: 1;
}

.processing-step span {
  font-weight: 500;
  color: #6c757d;
}
</style>
