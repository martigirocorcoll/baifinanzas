<!-- DASHBOARD HIGH LEVEL: Situaci√≥n Estable, Crecimiento Patrimonial, Libertad Financiera -->
<!-- NUEVA ESTRUCTURA: 3 SECCIONES PRINCIPALES -->

<!-- MARGEN SUPERIOR -->
<div class="mt-4"></div>

<!-- ========================================= -->
<!-- SECCI√ìN 1: NIVEL FINANCIERO -->
<!-- ========================================= -->
<div class="dashboard-section mb-4">
  <h3 class="section-title mb-3">
    <i class="bi bi-trophy-fill text-warning me-2"></i>
    Tu Nivel Financiero
  </h3>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">
      <!-- Nivel actual -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <i class="<%= @mountain_state[:bootstrap_icon] %> me-3 text-warning" style="font-size: 2.5rem;"></i>
          <div>
            <h4 class="mb-1 fw-bold"><%= @mountain_state[:name] %></h4>
            <span class="badge bg-warning text-dark">Nivel <%= current_user.financial_health_level_number %>/6</span>
          </div>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#levelGuideModal">
          <i class="bi bi-info-circle me-1"></i>
          Gu√≠a de niveles
        </button>
      </div>

      <p class="text-muted mb-3"><%= @mountain_state[:description] %></p>

      <!-- Pr√≥ximo nivel (accordion) -->
      <% if @next_level_progress[:target].present? %>
        <div class="accordion accordion-flush" id="nextLevelAccordion">
          <div class="accordion-item border-0">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#nextLevelCollapse">
                <i class="bi bi-flag-fill me-2 text-primary"></i>
                <strong>Pr√≥ximo nivel: <%= @next_level_progress[:target] %></strong>
                <span class="badge bg-light text-dark ms-2">
                  <%= @next_level_progress[:requirements].count { |r| r[:completed] } %>/<%= @next_level_progress[:requirements].count %> requisitos
                </span>
              </button>
            </h2>
            <div id="nextLevelCollapse" class="accordion-collapse collapse">
              <div class="accordion-body">
                <p class="text-muted mb-3">Para alcanzarlo necesitas:</p>
                <% @next_level_progress[:requirements].each do |req| %>
                  <div class="d-flex align-items-start mb-2">
                    <i class="<%= req[:completed] ? 'bi bi-check-circle-fill text-success' : 'bi bi-circle text-muted' %> me-2" style="font-size: 1.2rem;"></i>
                    <div>
                      <strong><%= req[:name] %></strong>
                      <% unless req[:completed] %>
                        <br>
                        <small class="text-muted">
                          Actual: ‚Ç¨<%= number_with_delimiter(req[:current], delimiter: ".") %> /
                          Objetivo: ‚Ç¨<%= number_with_delimiter(req[:target], delimiter: ".") %>
                          <% deficit = req[:target] - req[:current] %>
                          <% if deficit > 0 %>
                            <span class="text-danger">(Faltan ‚Ç¨<%= number_with_delimiter(deficit, delimiter: ".") %>)</span>
                          <% end %>
                        </small>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SECCI√ìN 2: PLAN FINANCIERO (INTERACTIVO) -->
<!-- ========================================= -->
<div class="dashboard-section mb-4">
  <h3 class="section-title mb-3">
    <i class="bi bi-list-check text-success me-2"></i>
    Tu Plan Financiero
  </h3>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">

      <!-- A. Barra de progreso -->
      <div class="progress-header mb-4 pb-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-bold">Progreso general</span>
          <span class="badge bg-primary" style="font-size: 0.9rem;">
            <%= @completed_count %>/<%= @total_count %> completadas
          </span>
        </div>
        <div class="progress" style="height: 20px;">
          <div class="progress-bar bg-success" role="progressbar"
               style="width: <%= @progress_percentage %>%;">
            <strong><%= @progress_percentage %>%</strong>
          </div>
        </div>
      </div>

      <!-- Layout responsive: desktop vs mobile -->
      <div class="financial-plan-layout">
        <div class="row g-4">

          <!-- C. Lista de pasos (sidebar en desktop, abajo en mobile) -->
          <div class="col-lg-4 order-lg-1 order-2">
            <div class="steps-sidebar">
              <h6 class="text-muted text-uppercase small mb-3">Pasos del plan</h6>

              <div class="steps-list">
                <% @action_plan.each_with_index do |action, index| %>
                  <% is_objective = action[:type] == 'objective' || action[:type] == 'create_objective' %>
                  <% is_first_uncompleted = @current_task && action[:position] == @current_task[:position] %>

                  <div class="step-item <%= 'completed' if action[:completed] %> <%= 'is-objective' if is_objective %> <%= 'is-next' if is_first_uncompleted %>"
                       data-step-id="<%= action[:position] %>"
                       data-step-type="<%= action[:type] %>"
                       onclick="selectStep(<%= action[:position] %>)">

                    <!-- Icon -->
                    <!-- Icon con funcionalidad de click para completar -->
                    <div class="step-icon"
                         <% if action[:type] == 'recommendation' && !action[:completed] %>
                           onclick="event.stopPropagation(); completeAction('<%= action[:key] %>', 'recommendation');"
                           style="cursor: pointer;"
                           title="Marcar como completada"
                         <% end %>>
                      <% if action[:completed] %>
                        <i class="bi bi-check-circle-fill text-success"></i>
                      <% elsif is_first_uncompleted %>
                        <i class="bi bi-arrow-right-circle text-primary"></i>
                      <% else %>
                        <i class="bi bi-circle text-muted"></i>
                      <% end %>
                    </div>

                    <!-- Content -->
                    <div class="step-content">
                      <div class="step-title <%= 'text-muted' if is_objective %>">
                        <%= action[:title] %>
                      </div>
                      <small class="step-meta text-muted">
                        <% if action[:type] == 'recommendation' %>
                          <i class="bi bi-clock"></i> <%= action[:time_minutes] %> min
                        <% elsif action[:type] == 'objective' && action[:objective] %>
                          <i class="bi bi-calendar"></i> <%= action[:time_months] %> meses
                        <% end %>
                      </small>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- B. Zona display principal -->
          <div class="col-lg-8 order-lg-2 order-1" style="border-left: 1px solid #dee2e6;">
            <div id="step-display" class="step-display">

              <!-- Por defecto: siguiente paso o mensaje de completado -->
              <% if @current_task.present? %>
                <div class="step-display-content" id="step-content-<%= @current_task[:position] %>">

                  <div class="text-center mb-4">
                    <span class="badge bg-success mb-2">Siguiente paso</span>
                    <h2 class="fw-bold mb-3">
                      <% if @current_task[:type] == 'recommendation' && @current_task[:recommendation] %>
                        <%= @current_task[:recommendation].title %>
                      <% else %>
                        <%= @current_task[:title] %>
                      <% end %>
                    </h2>
                  </div>

                  <div class="alert alert-success mb-4">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong><%= @current_task[:benefit_text] %></strong>
                  </div>

                  <% if @current_task[:type] == 'recommendation' %>
                    <!-- Descripci√≥n si existe -->
                    <% if @current_task[:recommendation]&.description.present? %>
                      <div class="mb-4">
                        <p class="text-muted"><%= @current_task[:recommendation].description %></p>
                      </div>
                    <% end %>

                    <!-- Tiempo estimado -->
                    <div class="mb-4 text-center">
                      <p class="text-muted mb-3">
                        <i class="bi bi-clock text-primary"></i>
                        Tiempo estimado: <strong><%= @current_task[:time_minutes] %> minutos</strong>
                      </p>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="d-grid gap-2">
                      <%= link_to recommendation_path(@current_task[:slug]), class: "btn btn-primary btn-lg" do %>
                        <i class="bi bi-arrow-right-circle me-2"></i>
                        Ver c√≥mo hacerlo
                      <% end %>

                      <%= form_with url: complete_action_path, method: :post, local: true do |f| %>
                        <%= f.hidden_field :action_type, value: 'recommendation' %>
                        <%= f.hidden_field :action_key, value: @current_task[:key] %>
                        <button type="submit" class="btn btn-outline-success btn-lg">
                          <i class="bi bi-check-circle me-2"></i>
                          Marcar como completada
                        </button>
                      <% end %>
                    </div>

                  <% elsif @current_task[:type] == 'create_objective' %>
                    <div class="text-center mb-4">
                      <i class="bi bi-bullseye" style="font-size: 4rem; color: #6c757d;"></i>
                      <p class="text-muted mt-3">
                        Has alcanzado un nivel donde puedes crear objetivos personalizados
                        para hacer crecer tu patrimonio.
                      </p>
                    </div>
                    <div class="d-grid">
                      <button class="btn btn-primary btn-lg" onclick="showCreateObjectiveForm()">
                        <i class="bi bi-plus-circle me-2"></i>
                        Crear mi primer objetivo
                      </button>
                    </div>

                  <% elsif @current_task[:type] == 'objective' %>
                    <div class="mb-4">
                      <p class="text-muted">
                        Meta: <strong>‚Ç¨<%= number_with_delimiter(@current_task[:objective].target_amount, delimiter: ".") %></strong>
                        en <%= distance_of_time_in_words(Date.current, @current_task[:objective].target_date) %>
                      </p>
                      <p class="text-info">
                        <i class="bi bi-piggy-bank me-2"></i>
                        Ahorro mensual necesario: <strong>‚Ç¨<%= number_with_delimiter(@current_task[:objective].monthly_savings_needed, delimiter: ".") %></strong>
                      </p>
                    </div>
                    <div class="d-grid">
                      <%= link_to recommendation_path(@current_task[:objective].investment_recommendation, objetivo_id: @current_task[:objective].id),
                          class: "btn btn-primary btn-lg" do %>
                        <i class="bi bi-arrow-right-circle me-2"></i>
                        Ver plan de inversi√≥n
                      <% end %>
                    </div>
                  <% end %>

                </div>
              <% else %>
                <!-- Todas las acciones completadas -->
                <div class="text-center py-5">
                  <i class="bi bi-trophy-fill text-success" style="font-size: 5rem;"></i>
                  <h3 class="mt-4 fw-bold">¬°Felicidades! Plan completado üéâ</h3>
                  <p class="text-muted mb-4">
                    Has completado todas las acciones de tu plan financiero.
                    Actualiza tus datos para ver si has progresado de nivel.
                  </p>
                  <div class="d-flex gap-2 justify-content-center">
                    <%= link_to edit_pyg_path, class: "btn btn-success" do %>
                      <i class="bi bi-graph-up me-2"></i>
                      Actualizar PyG
                    <% end %>
                    <%= link_to edit_balance_path, class: "btn btn-success" do %>
                      <i class="bi bi-pie-chart me-2"></i>
                      Actualizar Balance
                    <% end %>
                  </div>
                </div>
              <% end %>

              <!-- Contenedor para formulario de crear objetivo (se muestra din√°micamente) -->
              <div id="create-objective-form-container" style="display: none;">
                <div class="step-display-content">
                  <h4 class="mb-4">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crear Nuevo Objetivo
                  </h4>

                  <%= form_with model: @new_objective, local: true, id: "create-objective-form" do |f| %>
                    <%= f.hidden_field :user_id, value: current_user.id %>

                    <div class="mb-3">
                      <label class="form-label fw-bold">¬øQu√© quieres lograr?</label>
                      <%= f.text_field :title, class: "form-control", placeholder: "Ej: Comprar coche", required: true %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-bold">¬øCu√°nto necesitas? (‚Ç¨)</label>
                      <%= f.number_field :target_amount, class: "form-control", placeholder: "Ej: 25000", required: true %>
                    </div>

                    <div class="mb-3">
                      <label class="form-label fw-bold">¬øPara cu√°ndo?</label>
                      <div class="row g-2">
                        <div class="col-7">
                          <%= f.select :target_date_month,
                              options_for_select([
                                ['Enero', 1], ['Febrero', 2], ['Marzo', 3], ['Abril', 4],
                                ['Mayo', 5], ['Junio', 6], ['Julio', 7], ['Agosto', 8],
                                ['Septiembre', 9], ['Octubre', 10], ['Noviembre', 11], ['Diciembre', 12]
                              ], Date.current.month),
                              { prompt: 'Mes' },
                              { class: "form-select", required: true } %>
                        </div>
                        <div class="col-5">
                          <%= f.select :target_date_year,
                              options_for_select((Date.current.year..(Date.current.year + 45)).map { |y| [y, y] }, Date.current.year + 1),
                              { prompt: 'A√±o' },
                              { class: "form-select", required: true } %>
                        </div>
                      </div>
                    </div>

                    <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-check-circle me-2"></i>
                        Crear Objetivo
                      </button>
                      <button type="button" class="btn btn-outline-secondary" onclick="hideCreateObjectiveForm()">
                        Cancelar
                      </button>
                    </div>
                  <% end %>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SECCI√ìN 3: SITUACI√ìN FINANCIERA -->
<!-- ========================================= -->
<div class="dashboard-section mb-4">
  <h3 class="section-title mb-3">
    <i class="bi bi-graph-up text-primary me-2"></i>
    Tu Situaci√≥n Financiera
  </h3>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">

      <!-- Capacidad de ahorro (siempre visible) -->
      <div class="mb-4">
        <h6 class="text-muted text-uppercase small mb-3">Capacidad de Ahorro</h6>

        <%
          theoretical_capacity = @monthly_cash_flow
          committed_capacity = @active_objectives.sum { |obj| obj.monthly_savings_needed }
          available_capacity = theoretical_capacity - committed_capacity
          utilization_rate = theoretical_capacity > 0 ? (committed_capacity.to_f / theoretical_capacity * 100).round(0) : 0
        %>

        <div class="row g-3 mb-3">
          <div class="col-4">
            <div class="text-center">
              <small class="text-muted d-block">Flujo de caja</small>
              <strong class="h5 <%= theoretical_capacity > 0 ? 'text-primary' : 'text-danger' %>">
                ‚Ç¨<%= number_with_delimiter(theoretical_capacity, delimiter: ".") %>
              </strong>
            </div>
          </div>
          <div class="col-4">
            <div class="text-center">
              <small class="text-muted d-block">Comprometido</small>
              <strong class="h5 text-info">
                ‚Ç¨<%= number_with_delimiter(committed_capacity, delimiter: ".") %>
              </strong>
            </div>
          </div>
          <div class="col-4">
            <div class="text-center">
              <small class="text-muted d-block">Disponible</small>
              <strong class="h5 <%= available_capacity >= 0 ? 'text-success' : 'text-danger' %>">
                ‚Ç¨<%= number_with_delimiter(available_capacity, delimiter: ".") %>
              </strong>
            </div>
          </div>
        </div>

        <% if theoretical_capacity > 0 %>
          <div class="progress" style="height: 16px;">
            <% bar_color = utilization_rate < 70 ? 'bg-success' : (utilization_rate < 90 ? 'bg-warning' : 'bg-danger') %>
            <div class="progress-bar <%= bar_color %>" style="width: <%= [utilization_rate, 100].min %>%">
              <%= utilization_rate %>%
            </div>
          </div>

          <% if utilization_rate >= 100 %>
            <small class="text-danger">
              <i class="bi bi-exclamation-triangle me-1"></i>
              Tus objetivos exceden tu capacidad de ahorro
            </small>
          <% elsif utilization_rate >= 70 %>
            <small class="text-warning">
              <i class="bi bi-info-circle me-1"></i>
              Alto uso de capacidad. Deja margen para imprevistos.
            </small>
          <% end %>
        <% else %>
          <div class="alert alert-danger mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Capacidad negativa:</strong> Tus gastos superan tus ingresos.
            Es importante revisar tu situaci√≥n financiera.
          </div>
        <% end %>
      </div>

      <!-- PyG y Balance (accordions) -->
      <div class="accordion" id="financialAnalysisAccordion">

        <!-- PyG -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pygCollapse">
              <i class="bi bi-graph-up me-2 text-primary"></i>
              <strong>Ingresos y Gastos (PyG)</strong>
            </button>
          </h2>
          <div id="pygCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="chart-container mb-3" style="height: 300px;">
                <canvas id="pygChart"></canvas>
              </div>
              <div class="row text-center">
                <div class="col-4">
                  <div class="text-success">
                    <strong>Ingresos</strong><br>
                    <span class="h6">‚Ç¨<%= number_with_delimiter(@pyg_chart_data[:income] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="text-danger">
                    <strong>Gastos</strong><br>
                    <span class="h6">‚Ç¨<%= number_with_delimiter(@pyg_chart_data[:expenses] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="<%= @pyg_chart_data[:cash_flow] > 0 ? 'text-success' : 'text-danger' %>">
                    <strong>Capacidad</strong><br>
                    <span class="h6">‚Ç¨<%= number_with_delimiter(@pyg_chart_data[:cash_flow] || 0, delimiter: ".") %></span>
                  </div>
                </div>
              </div>
              <div class="mt-3 text-center">
                <%= link_to edit_pyg_path, class: "btn btn-outline-primary" do %>
                  <i class="bi bi-pencil me-2"></i>
                  Editar Ingresos y Gastos
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Balance -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#balanceCollapse">
              <i class="bi bi-pie-chart me-2 text-success"></i>
              <strong>Activos y Deudas (Balance)</strong>
            </button>
          </h2>
          <div id="balanceCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="chart-container mb-3" style="height: 300px;">
                <canvas id="balanceChart"></canvas>
              </div>
              <div class="row text-center">
                <div class="col-4">
                  <div class="text-success">
                    <strong>Activos</strong><br>
                    <span class="h6">‚Ç¨<%= number_with_delimiter(@balance_chart_data[:assets] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="text-danger">
                    <strong>Deudas</strong><br>
                    <span class="h6">‚Ç¨<%= number_with_delimiter(@balance_chart_data[:debt] || 0, delimiter: ".") %></span>
                  </div>
                </div>
                <div class="col-4">
                  <div class="<%= @balance_chart_data[:net_worth] > 0 ? 'text-success' : 'text-danger' %>">
                    <strong>Patrimonio</strong><br>
                    <span class="h6">‚Ç¨<%= number_with_delimiter(@balance_chart_data[:net_worth] || 0, delimiter: ".") %></span>
                  </div>
                </div>
              </div>
              <div class="mt-3 text-center">
                <%= link_to edit_balance_path, class: "btn btn-outline-primary" do %>
                  <i class="bi bi-pencil me-2"></i>
                  Editar Activos y Deudas
                <% end %>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SCRIPTS -->
<!-- ========================================= -->
<script>
// Variables globales para el plan de acci√≥n
let actionPlanData = <%= raw @action_plan.to_json %>;
let currentStepId = <%= @current_task ? @current_task[:position] : 'null' %>;

// Funci√≥n para completar una acci√≥n (desde el c√≠rculo)
function completeAction(actionKey, actionType) {
  console.log('Completing action:', actionKey, actionType);

  // Crear formulario y enviarlo
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/dashboard/complete_action';

  // CSRF token
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'authenticity_token';
  csrfInput.value = csrfToken;
  form.appendChild(csrfInput);

  // Action type
  const typeInput = document.createElement('input');
  typeInput.type = 'hidden';
  typeInput.name = 'action_type';
  typeInput.value = actionType;
  form.appendChild(typeInput);

  // Action key
  const keyInput = document.createElement('input');
  keyInput.type = 'hidden';
  keyInput.name = 'action_key';
  keyInput.value = actionKey;
  form.appendChild(keyInput);

  // A√±adir al DOM y enviar
  document.body.appendChild(form);
  form.submit();
}

// Funci√≥n para seleccionar un paso
function selectStep(stepId) {
  const step = actionPlanData.find(s => s.position === stepId);
  if (!step) {
    console.error('Step not found:', stepId);
    return;
  }

  console.log('Selecting step:', step);

  // Ocultar contenido inicial si existe
  const initialContent = document.querySelector('#step-display .step-display-content');
  if (initialContent && !initialContent.id.includes('js-generated')) {
    initialContent.style.display = 'none';
  }

  // Ocultar formulario de crear objetivo si est√° visible
  document.getElementById('create-objective-form-container').style.display = 'none';

  // Si es "crear objetivo", mostrar formulario
  if (step.type === 'create_objective') {
    showCreateObjectiveForm();
    return;
  }

  // Actualizar estados visuales
  document.querySelectorAll('.step-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-step-id="${stepId}"]`)?.classList.add('active');

  // Actualizar contenido del display
  updateStepDisplay(step);
}

// Mostrar formulario de crear objetivo
function showCreateObjectiveForm() {
  console.log('Showing create objective form');

  // Ocultar contenido inicial si existe
  const initialContent = document.querySelector('#step-display .step-display-content');
  if (initialContent && !initialContent.id.includes('js-generated')) {
    initialContent.style.display = 'none';
  }

  // Ocultar contenido generado por JS si existe
  const jsGenerated = document.getElementById('js-generated-content');
  if (jsGenerated) {
    jsGenerated.remove();
  }

  // Mostrar formulario
  document.getElementById('create-objective-form-container').style.display = 'block';

  // Marcar como activo en lista
  document.querySelectorAll('.step-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector('[data-step-type="create_objective"]')?.classList.add('active');

  // Scroll suave
  document.getElementById('create-objective-form-container').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Ocultar formulario de crear objetivo
function hideCreateObjectiveForm() {
  document.getElementById('create-objective-form-container').style.display = 'none';

  // Volver a mostrar el paso actual por defecto
  if (currentStepId) {
    selectStep(currentStepId);
  }
}

// Actualizar contenido del display
function updateStepDisplay(step) {
  console.log('Updating display with step:', step);

  const displayContainer = document.getElementById('step-display');

  // Remover cualquier contenido generado previamente
  const oldGenerated = document.getElementById('js-generated-content');
  if (oldGenerated) {
    oldGenerated.remove();
  }

  // Ocultar contenido inicial
  const initialContent = displayContainer.querySelector('.step-display-content');
  if (initialContent && !initialContent.id) {
    initialContent.style.display = 'none';
  }

  let html = '<div class="step-display-content" id="js-generated-content">';

  // Header con badge
  html += `
    <div class="text-center mb-4">
      <span class="badge bg-primary mb-2">Paso ${step.position}</span>
      <h2 class="fw-bold mb-3">${step.title}</h2>
    </div>
  `;

  // Alert con beneficio
  html += `
    <div class="alert alert-success mb-4">
      <i class="bi bi-check-circle-fill me-2"></i>
      <strong>${step.benefit_text}</strong>
    </div>
  `;

  // Contenido espec√≠fico seg√∫n el tipo
  if (step.type === 'recommendation') {
    // Descripci√≥n si existe
    if (step.recommendation && step.recommendation.description) {
      html += `
        <div class="mb-4">
          <p class="text-muted">${step.recommendation.description}</p>
        </div>
      `;
    }

    // Tiempo estimado
    html += `
      <div class="mb-4 text-center">
        <p class="text-muted mb-3">
          <i class="bi bi-clock text-primary"></i>
          Tiempo estimado: <strong>${step.time_minutes} minutos</strong>
        </p>
      </div>
    `;

    // Botones de acci√≥n
    html += '<div class="d-grid gap-2">';
    html += `
      <a href="/recommendations/${step.slug}" class="btn btn-primary btn-lg">
        <i class="bi bi-arrow-right-circle me-2"></i>
        Ver c√≥mo hacerlo
      </a>
    `;

    if (!step.completed) {
      html += `
        <form action="/dashboard/complete_action" method="post" data-turbo="false">
          <input type="hidden" name="authenticity_token" value="${document.querySelector('meta[name="csrf-token"]').content}">
          <input type="hidden" name="action_type" value="recommendation">
          <input type="hidden" name="action_key" value="${step.key}">
          <button type="submit" class="btn btn-outline-success btn-lg w-100">
            <i class="bi bi-check-circle me-2"></i>
            Marcar como completada
          </button>
        </form>
      `;
    } else {
      html += `
        <div class="alert alert-success mb-0">
          <i class="bi bi-check-circle-fill me-2"></i>
          ¬°Ya completaste esta acci√≥n!
        </div>
      `;
    }

    html += '</div>';

  } else if (step.type === 'objective' && step.objective) {
    // Informaci√≥n del objetivo
    html += `
      <div class="mb-4">
        <p class="text-muted">
          Meta: <strong>‚Ç¨${step.objective.target_amount.toLocaleString('es-ES')}</strong>
        </p>
        <p class="text-info">
          <i class="bi bi-piggy-bank me-2"></i>
          Ahorro mensual necesario: <strong>‚Ç¨${step.objective.monthly_savings_needed.toLocaleString('es-ES')}</strong>
        </p>
      </div>
    `;

    // Bot√≥n ver plan
    html += `
      <div class="d-grid">
        <a href="/recommendations/${step.objective.investment_recommendation}?objetivo_id=${step.objective.id}"
           class="btn btn-primary btn-lg">
          <i class="bi bi-arrow-right-circle me-2"></i>
          Ver plan de inversi√≥n
        </a>
      </div>
    `;
  } else if (step.type === 'create_objective') {
    // Caso especial: mostrar mensaje y bot√≥n para crear
    html += `
      <div class="text-center mb-4">
        <i class="bi bi-bullseye" style="font-size: 4rem; color: #6c757d;"></i>
        <p class="text-muted mt-3">
          Has alcanzado un nivel donde puedes crear objetivos personalizados
          para hacer crecer tu patrimonio.
        </p>
      </div>
      <div class="d-grid">
        <button class="btn btn-primary btn-lg" onclick="showCreateObjectiveForm()">
          <i class="bi bi-plus-circle me-2"></i>
          Crear mi primer objetivo
        </button>
      </div>
    `;
  }

  html += '</div>';

  // Insertar el nuevo contenido
  displayContainer.insertAdjacentHTML('beforeend', html);
}

// Marcar el primer paso como activo al cargar
document.addEventListener('turbo:load', function() {
  console.log('=== PLAN FINANCIERO DEBUG ===');
  console.log('Action plan data:', actionPlanData);
  console.log('Current step ID:', currentStepId);
  console.log('Total steps:', actionPlanData.length);

  if (currentStepId) {
    document.querySelector(`[data-step-id="${currentStepId}"]`)?.classList.add('active');
  }
});

// Tambi√©n ejecutar al cargar directamente (no solo con turbo)
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== DOM LOADED ===');
  if (currentStepId) {
    document.querySelector(`[data-step-id="${currentStepId}"]`)?.classList.add('active');
  }
});

// Gr√°ficos (Chart.js)
function initSimplifiedCharts() {
  const pygElement = document.getElementById('pygChart');
  if (pygElement) {
    const pygCtx = pygElement.getContext('2d');
    const pygData = <%= raw @pyg_chart_data.to_json %>;

    new Chart(pygCtx, {
      type: 'bar',
      data: {
        labels: ['Ingresos', 'Gastos', 'Capacidad'],
        datasets: [{
          data: [pygData.income || 0, pygData.expenses || 0, Math.max(pygData.cash_flow || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', pygData.cash_flow > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '‚Ç¨' + value.toLocaleString('es-ES');
              }
            }
          }
        }
      }
    });
  }

  const balanceElement = document.getElementById('balanceChart');
  if (balanceElement) {
    const balanceCtx = balanceElement.getContext('2d');
    const balanceData = <%= raw @balance_chart_data.to_json %>;

    new Chart(balanceCtx, {
      type: 'bar',
      data: {
        labels: ['Activos', 'Deudas', 'Patrimonio'],
        datasets: [{
          data: [balanceData.assets || 0, balanceData.debt || 0, Math.max(balanceData.net_worth || 0, 0)],
          backgroundColor: ['#28a745', '#dc3545', balanceData.net_worth > 0 ? '#17a2b8' : '#6c757d'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '‚Ç¨' + value.toLocaleString('es-ES');
              }
            }
          }
        }
      }
    });
  }
}

document.addEventListener('turbo:load', initSimplifiedCharts);

// Animaci√≥n modal crear objetivo
document.addEventListener('turbo:load', function() {
  const createObjectiveForm = document.getElementById('create-objective-form');

  if (createObjectiveForm) {
    let isSubmitting = false;

    createObjectiveForm.addEventListener('submit', function(e) {
      if (!isSubmitting && createObjectiveForm.checkValidity()) {
        e.preventDefault();
        isSubmitting = true;

        const loadingModal = new bootstrap.Modal(document.getElementById('createObjectiveLoadingModal'));
        loadingModal.show();

        const steps = ['objective-step-1', 'objective-step-2', 'objective-step-3'];
        const progressBar = document.getElementById('objective-progress-bar');
        let currentStepIndex = 0;

        function activateStep(index) {
          if (index < steps.length) {
            const stepElement = document.getElementById(steps[index]);
            stepElement.classList.add('active');

            const progress = ((index + 1) / steps.length) * 100;
            progressBar.style.width = progress + '%';

            currentStepIndex++;
            if (currentStepIndex < steps.length) {
              setTimeout(() => activateStep(currentStepIndex), 650);
            } else {
              setTimeout(function() {
                loadingModal.hide();
                setTimeout(function() {
                  createObjectiveForm.submit();
                }, 300);
              }, 400);
            }
          }
        }

        setTimeout(() => activateStep(0), 300);
      }
    });
  }
});
</script>

<!-- Modal de carga objetivo -->
<div class="modal fade" id="createObjectiveLoadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center py-5">
        <div class="mb-4">
          <div class="processing-icon-container">
            <i class="bi bi-bullseye text-success processing-icon"></i>
            <div class="processing-ring"></div>
            <div class="processing-ring-2"></div>
          </div>
        </div>
        <h3 class="fw-bold mb-3">Creando tu objetivo</h3>
        <p class="text-muted mb-4">Estamos generando tu plan personalizado...</p>
        <div class="processing-steps mb-4">
          <div class="processing-step" id="objective-step-1">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span>Analizando tu capacidad de ahorro</span>
          </div>
          <div class="processing-step" id="objective-step-2">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span>Calculando plazo y rentabilidad</span>
          </div>
          <div class="processing-step" id="objective-step-3">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span>Seleccionando mejor producto</span>
          </div>
        </div>
        <div class="progress mx-auto" style="max-width: 350px; height: 6px;">
          <div class="progress-bar progress-bar-animated bg-success" id="objective-progress-bar"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Level Guide Modal -->
<%= render 'dashboard/level_guide_modal' %>

<style>
/* ========================================= */
/* ESTILOS GENERALES */
/* ========================================= */
.section-title {
  font-size: 1.25rem;
  font-weight: 700;
}

/* ========================================= */
/* PLAN FINANCIERO - LISTA DE PASOS */
/* ========================================= */
.steps-sidebar {
  position: sticky;
  top: 100px;
}

.steps-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  max-height: 600px;
  overflow-y: auto;
  padding-right: 0.5rem;
}

/* Scrollbar styling */
.steps-list::-webkit-scrollbar {
  width: 6px;
}

.steps-list::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.steps-list::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

.steps-list::-webkit-scrollbar-thumb:hover {
  background: #555;
}

.step-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  border: 2px solid #e9ecef;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
}

.step-item:hover {
  background: #f8f9fa;
  border-color: #ced4da;
  transform: translateX(2px);
}

.step-item.active {
  border-color: #0d6efd;
  background: #e7f1ff;
  box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}

.step-item.completed {
  opacity: 0.65;
  background: #f8f9fa;
}

.step-item.is-objective {
  background: #fafafa;
  border-color: #e0e0e0;
}

.step-item.is-objective .step-title {
  color: #868e96;
}

.step-item.is-next {
  border-color: #0dcaf0;
  background: #cff4fc;
  box-shadow: 0 2px 8px rgba(13, 202, 240, 0.15);
}

.step-icon {
  flex-shrink: 0;
  font-size: 1.4rem;
}

.step-content {
  flex-grow: 1;
  min-width: 0;
}

.step-title {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: #212529;
}

.step-meta {
  font-size: 0.75rem;
  color: #6c757d;
}

/* ========================================= */
/* PLAN FINANCIERO - DISPLAY */
/* ========================================= */
.step-display {
  min-height: 500px;
  padding-left: 2rem;
}

.step-display-content {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========================================= */
/* RESPONSIVE */
/* ========================================= */
@media (max-width: 991px) {
  .col-lg-8[style*="border-left"] {
    border-left: none !important;
    border-top: 1px solid #dee2e6 !important;
    padding-top: 2rem;
    margin-top: 2rem;
  }

  .step-display {
    padding-left: 0;
  }

  .steps-sidebar {
    position: static;
  }

  .steps-list {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .step-item {
    padding: 0.65rem 0.85rem;
  }

  .step-title {
    font-size: 0.85rem;
  }

  .step-icon {
    font-size: 1.2rem;
  }
}

/* ========================================= */
/* MODAL LOADING */
/* ========================================= */
.processing-icon-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.processing-icon {
  font-size: 3.5rem;
  position: relative;
  z-index: 2;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

.processing-ring,
.processing-ring-2 {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  border: 3px solid transparent;
  border-top-color: #22c55e;
  border-radius: 50%;
  animation: spin 1.5s linear infinite;
}

.processing-ring-2 {
  border-top-color: #10b981;
  animation: spin 2s linear infinite reverse;
  opacity: 0.5;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.processing-steps {
  max-width: 400px;
  margin: 0 auto;
  text-align: left;
}

.processing-step {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin-bottom: 8px;
  background: #f8f9fa;
  border-radius: 8px;
  opacity: 0.3;
  transition: opacity 0.5s ease;
}

.processing-step i {
  font-size: 1.2rem;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.processing-step.active {
  opacity: 1;
}

.processing-step.active i {
  opacity: 1;
}

.processing-step span {
  font-weight: 500;
  color: #6c757d;
}
</style>
