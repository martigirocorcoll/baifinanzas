<div class="app-container">
  <%= simple_form_for @pyg,
        url: pyg_path,
        html: { method: @pyg.new_record? ? :post : :patch } do |f| %>

    <%# Title %>
    <div class="text-center mb-4">
      <h2 style="font-size: 1.25rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.5rem;"><%= t('views.pyg_form.title') %></h2>
      <p class="text-muted" style="font-size: 0.875rem;">
        <%= t('views.pyg_form.description') %>
        <strong><%= t('views.pyg_form.note') %></strong>
      </p>
    </div>

    <%# Income section %>
    <div class="app-form__section">
      <h3 class="app-form__section-title">
        <i class="bi bi-cash-coin"></i>
        <%= t('views.pyg_form.income_section') %>
      </h3>
      <div class="app-form__group">
        <label class="app-form__label"><%= t('views.pyg_form.income_label') %></label>
        <div class="app-form__input-group">
          <%= f.input_field :ingresos_mensual,
                type: "text",
                class: "app-form__input euro-input",
                placeholder: "0",
                data: { field: "ingresos_mensual" },
                style: "text-align: right;" %>
          <span class="app-form__input-suffix">&euro;</span>
        </div>
        <p class="app-form__hint"><%= t('views.pyg_form.income_help') %></p>
      </div>
    </div>

    <%# Expenses section %>
    <div class="app-form__section app-form__section--expenses">
      <h3 class="app-form__section-title">
        <i class="bi bi-cart3"></i>
        <%= t('views.pyg_form.expenses_section') %>
      </h3>

      <% expense_fields = %w[gasto_compra alquiler_hipoteca gastos_utilities gastos_seguros
                             gastos_transporte restaurantes_y_ocio cuota_hipoteca cuota_coche
                             otras_cuotas suscripciones cuidado_personal otros_gastos] %>

      <% expense_fields.each do |field| %>
        <div class="app-form__group">
          <label class="app-form__label"><%= t("views.pyg_form.expenses.#{field}") %></label>
          <div class="app-form__input-group">
            <%= f.input_field field,
                  type: "text",
                  class: "app-form__input euro-input",
                  placeholder: "0",
                  data: { field: field },
                  style: "text-align: right;" %>
            <span class="app-form__input-suffix">&euro;</span>
          </div>
        </div>
      <% end %>
    </div>

    <%# Balance summary %>
    <div class="app-card" style="border-left: 3px solid #165668;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <p class="text-muted mb-1" style="font-size: 0.8125rem;"><%= t('views.pyg_form.balance_section') %></p>
          <p class="fw-bold mb-0" style="font-size: 0.9375rem;"><%= t('views.pyg_form.balance_description') %></p>
        </div>
        <div class="text-end">
          <p class="mb-0 fw-bold text-success" id="balance-amount" style="font-size: 1.25rem;">
            &euro;0
          </p>
          <small class="text-muted" id="balance-label"
                 data-prompt="<%= t('views.pyg_form.balance_prompt') %>"
                 data-savings="<%= t('views.pyg_form.savings_label') %>"
                 data-deficit="<%= t('views.pyg_form.deficit_label') %>"
                 data-balanced="<%= t('views.pyg_form.balanced_label') %>">
            <%= t('views.pyg_form.balance_prompt') %>
          </small>
        </div>
      </div>
    </div>

    <%# Submit %>
    <div style="margin-top: 1.5rem;">
      <%= f.button :submit, class: "btn-app btn-app--primary btn-app--block" do %>
        <i class="bi bi-arrow-right-circle"></i>
        <%= @pyg.new_record? ? t('views.pyg_form.submit_new') : t('views.pyg_form.submit_update') %>
      <% end %>
    </div>

  <% end %>
</div>

<script>
function initPygForm() {
  const euroInputs = document.querySelectorAll('.euro-input');
  const balanceAmount = document.getElementById('balance-amount');
  const balanceLabel = document.getElementById('balance-label');
  const ingresosInput = document.querySelector('[data-field="ingresos_mensual"]');

  if (!balanceAmount || !balanceLabel || !ingresosInput) return;

  // Get translated labels from data attributes
  const labels = {
    prompt: balanceLabel.dataset.prompt,
    savings: balanceLabel.dataset.savings,
    deficit: balanceLabel.dataset.deficit,
    balanced: balanceLabel.dataset.balanced
  };

  function formatNumber(value) {
    if (!value || value === '0') return '0';
    let num = value.replace(/[^\d,]/g, '');
    let parts = num.split(',');
    let integerPart = parts[0];
    let decimalPart = parts[1] || '';
    integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return decimalPart ? `${integerPart},${decimalPart}` : integerPart;
  }

  function parseEuroNumber(value) {
    if (!value || value === '0' || value === '') return 0;
    const num = parseFloat(value.replace(/\./g, '').replace(',', '.'));
    return isNaN(num) ? 0 : num;
  }

  function unformatNumber(value) {
    if (!value || value === '0') return '0';
    return value.replace(/\./g, '').replace(',', '.');
  }

  function updateBalance() {
    const ingresos = parseEuroNumber(ingresosInput.value);
    const expenseFields = [
      'gasto_compra', 'alquiler_hipoteca', 'gastos_utilities', 'gastos_seguros',
      'gastos_transporte', 'restaurantes_y_ocio', 'cuota_hipoteca', 'cuota_coche',
      'otras_cuotas', 'suscripciones', 'cuidado_personal', 'otros_gastos'
    ];

    let totalGastos = 0;
    expenseFields.forEach(fieldName => {
      const input = document.querySelector(`[data-field="${fieldName}"]`);
      if (input) totalGastos += parseEuroNumber(input.value);
    });

    const diferencia = ingresos - totalGastos;
    const formattedAmount = new Intl.NumberFormat('es-ES', {
      style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 2
    }).format(Math.abs(diferencia));

    balanceAmount.textContent = formattedAmount;

    if (diferencia > 0) {
      balanceAmount.className = 'mb-0 fw-bold text-success';
      balanceAmount.style.fontSize = '1.25rem';
      balanceLabel.textContent = labels.savings;
    } else if (diferencia < 0) {
      balanceAmount.className = 'mb-0 fw-bold text-danger';
      balanceAmount.style.fontSize = '1.25rem';
      balanceLabel.textContent = labels.deficit;
    } else {
      balanceAmount.className = 'mb-0 fw-bold text-muted';
      balanceAmount.style.fontSize = '1.25rem';
      balanceLabel.textContent = labels.balanced;
    }
  }

  euroInputs.forEach(input => {
    if (input.dataset.bound) return;
    input.dataset.bound = '1';
    if (input.value && input.value !== '0') input.value = formatNumber(input.value);

    input.addEventListener('input', function(e) {
      let cursorPosition = this.selectionStart;
      let oldLength = this.value.length;
      this.value = this.value.replace(/[^\d,]/g, '');
      let parts = this.value.split(',');
      if (parts.length > 2) this.value = parts[0] + ',' + parts.slice(1).join('');
      this.value = formatNumber(this.value);
      let newLength = this.value.length;
      cursorPosition = cursorPosition + (newLength - oldLength);
      this.setSelectionRange(cursorPosition, cursorPosition);
      updateBalance();
    });

    input.addEventListener('blur', function() {
      if (!this.value || this.value === '') this.value = '0';
      updateBalance();
    });
  });

  updateBalance();

  const form = document.querySelector('form');
  if (form && !form.dataset.bound) {
    form.dataset.bound = '1';
    form.addEventListener('submit', function(e) {
      document.querySelectorAll('.euro-input').forEach(input => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = input.name;
        hiddenInput.value = unformatNumber(input.value);
        input.disabled = true;
        this.appendChild(hiddenInput);
      });
    });
  }
}
document.addEventListener('turbo:load', initPygForm);
if (document.readyState !== 'loading') { initPygForm(); } else { document.addEventListener('DOMContentLoaded', initPygForm); }
</script>

<style>
  .euro-input { -moz-appearance: textfield; }
  .euro-input::-webkit-outer-spin-button,
  .euro-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>
