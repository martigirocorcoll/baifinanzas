<% content_for :title, "Admin - Gestión de Influencers" %>

<div class="container my-5">
  <% if notice.present? %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill"></i>
      <%= notice %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
      <i class="bi bi-people-fill text-primary"></i>
      Gestión de Influencers
    </h1>
    <%= link_to new_influencer_path, class: "btn btn-success btn-lg" do %>
      <i class="bi bi-plus-circle"></i> Crear Nuevo Influencer
    <% end %>
  </div>

  <% if @influencers.any? %>
    <% default_influencer = @influencers.find { |i| i.default? } %>
    <% if default_influencer %>
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle-fill"></i>
        <strong>Influencer por defecto:</strong> <%= default_influencer.name %>
        <br>
        <small class="text-muted">Los usuarios que se registren sin código de referido serán asignados automáticamente a este influencer.</small>
      </div>
    <% else %>
      <div class="alert alert-warning mb-4">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>No hay influencer por defecto.</strong>
        Los usuarios sin código de referido no tendrán enlaces de afiliado.
        <br>
        <small class="text-muted">Haz clic en la estrella ⭐ de un influencer para marcarlo como predeterminado.</small>
      </div>
    <% end %>
  <% end %>

  <% if @influencers.empty? %>
    <div class="card text-center py-5">
      <div class="card-body">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h3 class="mt-3">No hay influencers todavía</h3>
        <p class="text-muted">Crea tu primer influencer para empezar</p>
        <%= link_to new_influencer_path, class: "btn btn-primary mt-3" do %>
          <i class="bi bi-plus-circle"></i> Crear Primer Influencer
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">Nombre</th>
                <th scope="col">Email</th>
                <th scope="col">Código</th>
                <th scope="col" class="text-center">Usuarios Referidos</th>
                <th scope="col" class="text-center">Enlaces Configurados</th>
                <th scope="col" class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <% @influencers.each do |influencer| %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <strong><%= influencer.name %></strong>
                      <% if influencer.default? %>
                        <span class="badge bg-success">
                          <i class="bi bi-star-fill"></i> Por defecto
                        </span>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <i class="bi bi-envelope text-muted"></i>
                    <%= influencer.email %>
                  </td>
                  <td>
                    <code class="bg-light px-2 py-1 rounded"><%= influencer.code %></code>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-primary rounded-pill">
                      <%= influencer.users.count %>
                    </span>
                  </td>
                  <td class="text-center">
                    <% configured_links = [
                      influencer.ac_compte,
                      influencer.ac_cdiposit,
                      influencer.ac_curt,
                      influencer.ac_llarg,
                      influencer.ac_deute,
                      influencer.ac_jubil,
                      influencer.ac_fiscal
                    ].compact.count %>
                    <span class="badge <%= configured_links > 0 ? 'bg-success' : 'bg-warning' %> rounded-pill">
                      <%= configured_links %>/7
                    </span>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm" role="group">
                      <%= button_to toggle_default_influencer_path(influencer),
                          method: :post,
                          class: "btn #{influencer.default? ? 'btn-warning' : 'btn-outline-success'}",
                          title: influencer.default? ? "Quitar como defecto" : "Establecer como defecto",
                          form: { style: 'display: inline;', data: { turbo: false } } do %>
                        <i class="bi bi-star<%= influencer.default? ? '-fill' : '' %>"></i>
                      <% end %>
                      <%= link_to influencer, class: "btn btn-outline-primary", title: "Ver Dashboard" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                      <%= link_to edit_influencer_path(influencer), class: "btn btn-outline-secondary", title: "Editar" do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <%= link_to influencer,
                          method: :delete,
                          data: { turbo_method: :delete, turbo_confirm: "¿Estás seguro? Esto eliminará el influencer y desvinculará sus usuarios referidos." },
                          class: "btn btn-outline-danger",
                          title: "Eliminar" do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer text-muted">
        <i class="bi bi-info-circle"></i>
        Total: <strong><%= @influencers.count %></strong> influencer<%= @influencers.count == 1 ? '' : 's' %>
      </div>
    </div>
  <% end %>
</div>
