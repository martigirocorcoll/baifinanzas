<% content_for :title, t('plan.nav_title', default: 'Plan') %>

<div class="app-container" style="padding: 1rem;">

  <%# LEVEL INDICATOR %>
  <div class="plan-level">
    <div class="plan-level__badge">
      <span class="plan-level__number"><%= @financial_level[:number] %></span>
      <span class="plan-level__of">/6</span>
    </div>
    <div class="plan-level__info">
      <h2 class="plan-level__name"><%= @financial_level[:name] %></h2>
      <p class="plan-level__desc"><%= @financial_level[:description] %></p>
    </div>
    <%= link_to level_guide_path, class: 'plan-level__help' do %>
      <i class="bi bi-question-circle"></i>
    <% end %>
  </div>

  <div class="plan-level__progress">
    <div class="plan-level__progress-fill" style="width: <%= (@financial_level[:number] / 6.0 * 100).round %>%"></div>
  </div>

  <%# CONTEXTUAL TITLE %>
  <h3 class="plan-section-title" style="margin-top: 1.5rem;">
    <%= t('plan.recommendations_title', default: 'Lo que la gente en tu nivel hace para mejorar:') %>
  </h3>

  <%# RECOMMENDATIONS LIST %>
  <div class="plan-recommendations">
    <% @recommendations.each do |rec| %>
      <div class="plan-rec-card <%= 'plan-rec-card--completed' if rec[:completed] %>">
        <% if rec[:slug].present? %>
          <%= link_to recommendation_path(rec[:slug]), class: 'plan-rec-card__link-area' do %>
            <div class="plan-rec-card__icon">
              <i class="bi <%= rec[:icon] %>"></i>
            </div>
            <div class="plan-rec-card__content">
              <h4 class="plan-rec-card__title"><%= rec[:title] %></h4>
              <p class="plan-rec-card__benefit"><%= rec[:benefit_text] %></p>
            </div>
            <i class="bi bi-chevron-right plan-rec-card__chevron"></i>
          <% end %>
        <% else %>
          <div class="plan-rec-card__link-area">
            <div class="plan-rec-card__icon">
              <i class="bi <%= rec[:icon] %>"></i>
            </div>
            <div class="plan-rec-card__content">
              <h4 class="plan-rec-card__title"><%= rec[:title] %></h4>
              <p class="plan-rec-card__benefit"><%= rec[:benefit_text] %></p>
            </div>
          </div>
        <% end %>
        <%= button_to rec[:completed] ? uncomplete_action_path : complete_action_path,
            method: :post,
            params: { action_type: 'recommendation', action_key: rec[:key] },
            class: "plan-rec-card__toggle #{rec[:completed] ? 'plan-rec-card__toggle--active' : ''}" do %>
          <i class="bi <%= rec[:completed] ? 'bi-check-circle-fill' : 'bi-circle' %>"></i>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# NEXT LEVEL %>
  <% if @next_level %>
    <div class="plan-next-level" style="margin-top: 1.5rem;">
      <h3 class="plan-section-title">
        <%= t('plan.next_level_title', level: @next_level[:name], default: 'Para llegar a %{level}:') %>
      </h3>
      <% @next_level[:requirements].each do |req| %>
        <div class="plan-next-level__req">
          <i class="bi <%= req[:completed] ? 'bi-check-circle-fill' : 'bi-circle' %>"
             style="color: <%= req[:completed] ? '#10b981' : '#d1d5db' %>; font-size: 1.2rem;"></i>
          <span><%= req[:text] %></span>
        </div>
      <% end %>
      <div style="margin-top: 1rem;">
        <%= link_to onboarding_step_path(step_name: 'ingresos', from: 'plan'),
            class: 'btn-app btn-app--outline btn-app--block' do %>
          <i class="bi bi-arrow-repeat me-1"></i>
          <%= t('plan.update_data', default: 'Actualizar mis datos') %>
        <% end %>
      </div>
    </div>
  <% end %>

</div>

<style>
.plan-level {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: rgba(22, 86, 104, 0.06);
  border-radius: 12px;
  border: 1px solid rgba(22, 86, 104, 0.12);
}
.plan-level__badge {
  display: flex;
  align-items: baseline;
  gap: 2px;
  flex-shrink: 0;
}
.plan-level__number {
  font-size: 2rem;
  font-weight: 700;
  color: #165668;
  line-height: 1;
}
.plan-level__of {
  font-size: 1rem;
  color: #6b7280;
  font-weight: 500;
}
.plan-level__info {
  flex: 1;
  min-width: 0;
}
.plan-level__name {
  font-size: 1rem;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0 0 4px;
}
.plan-level__desc {
  font-size: 0.8125rem;
  color: #6b7280;
  margin: 0;
  line-height: 1.4;
}
.plan-level__help {
  color: #165668;
  font-size: 1.25rem;
  flex-shrink: 0;
}
.plan-level__progress {
  height: 4px;
  background: #e5e7eb;
  border-radius: 2px;
  margin-top: 8px;
  overflow: hidden;
}
.plan-level__progress-fill {
  height: 100%;
  background: #165668;
  border-radius: 2px;
  transition: width 0.3s;
}

.plan-section-title {
  font-size: 0.9375rem;
  font-weight: 600;
  color: #1a1a1a;
  margin-bottom: 12px;
}

.plan-recommendations {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.plan-rec-card {
  display: flex;
  align-items: center;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  overflow: hidden;
}
.plan-rec-card--completed {
  opacity: 0.6;
}
.plan-rec-card__link-area {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 0;
  padding: 14px;
  padding-right: 0;
  color: inherit;
  text-decoration: none;
}
.plan-rec-card__icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: rgba(22, 86, 104, 0.08);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: #165668;
}
.plan-rec-card__content {
  flex: 1;
  min-width: 0;
}
.plan-rec-card__title {
  font-size: 0.875rem;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0 0 2px;
}
.plan-rec-card__benefit {
  font-size: 0.75rem;
  color: #6b7280;
  margin: 0;
  line-height: 1.3;
}
.plan-rec-card__chevron {
  color: #9ca3af;
  font-size: 1rem;
  flex-shrink: 0;
}
.plan-rec-card__toggle {
  background: none;
  border: none;
  border-left: 1px solid #f3f4f6;
  padding: 14px 12px;
  color: #d1d5db;
  font-size: 1.2rem;
  cursor: pointer;
  flex-shrink: 0;
  align-self: stretch;
  display: flex;
  align-items: center;
}
.plan-rec-card__toggle--active {
  color: #10b981;
}

.plan-next-level__req {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
  font-size: 0.875rem;
  color: #1a1a1a;
}
</style>
