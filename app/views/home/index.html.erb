<% content_for :title, t('home.nav_title', default: 'Inicio') %>

<% unless @profile_complete %>
  <%# ============================================ %>
  <%# NO ONBOARDING: Single CTA card %>
  <%# ============================================ %>
  <div class="app-container">
    <div class="home-onboarding-cta">
      <div class="home-onboarding-cta__icon">
        <i class="bi bi-graph-up-arrow"></i>
      </div>
      <h2 class="home-onboarding-cta__title"><%= t('home.incomplete.title', default: 'Descubre tu plan financiero') %></h2>
      <p class="home-onboarding-cta__desc"><%= t('home.incomplete.description', default: 'Responde unas preguntas sencillas y te diremos como mejorar tu situacion economica.') %></p>
      <%= link_to onboarding_step_path(step_name: 'ingresos'), class: 'btn-app btn-app--primary btn-app--lg btn-app--block' do %>
        <%= t('home.incomplete.cta', default: 'Completar mis datos') %>
        <i class="bi bi-arrow-right ms-1"></i>
      <% end %>
    </div>
  </div>

<% else %>
  <%# ============================================ %>
  <%# FULLSCREEN HOME LAYOUT %>
  <%# ============================================ %>
  <div class="home-fullscreen">
    <%# COMPACT LEVEL INDICATOR %>
    <div class="home-level-compact">
      <div class="home-level-compact__content">
        <span class="home-level-compact__pill"><%= @financial_level[:number] %>/6</span>
        <span class="home-level-compact__name"><%= @financial_level[:name] %></span>
        <%= link_to level_guide_path, class: 'home-level-compact__help' do %>
          <i class="bi bi-question-circle"></i>
        <% end %>
      </div>
      <div class="home-level-compact__progress">
        <div class="home-level-compact__progress-fill" style="width: <%= (@financial_level[:number] / 6.0 * 100).round %>%"></div>
      </div>
    </div>

    <%# UNIFIED ACTION CAROUSEL - fills remaining space %>
    <div class="home-fullscreen__carousel">
      <%= render 'home/action_carousel' %>
    </div>
  </div>
<% end %>

<script>
(function() {
  function initHomeCarousels() {
    function setupCarousel(carouselId, dotsId) {
      var carousel = document.getElementById(carouselId);
      var dotsContainer = document.getElementById(dotsId);
      if (!carousel || !dotsContainer) return;

      var cards = carousel.querySelectorAll('.carousel__card');
      var dots = dotsContainer.querySelectorAll('.carousel__dot');
      if (cards.length === 0) return;

      // Auto-scroll to first uncompleted
      var firstIdx = parseInt(carousel.dataset.firstUncompleted) || 0;
      if (firstIdx > 0 && firstIdx < cards.length) {
        requestAnimationFrame(function() {
          var target = cards[firstIdx];
          carousel.scrollTo({ left: target.offsetLeft - carousel.offsetLeft, behavior: 'smooth' });
        });
      }

      if (dots.length > 0) {
        dots[0].classList.add('carousel__dot--active');
      }

      var observerKey = '_observer_' + carouselId;
      if (window[observerKey]) { window[observerKey].disconnect(); }

      if ('IntersectionObserver' in window) {
        var observer = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            if (entry.isIntersecting) {
              var idx = Array.prototype.indexOf.call(cards, entry.target);
              dots.forEach(function(d, i) {
                d.classList.toggle('carousel__dot--active', i === idx);
              });
            }
          });
        }, { root: carousel, threshold: 0.5 });

        window[observerKey] = observer;
        cards.forEach(function(card) { observer.observe(card); });
      }

      dots.forEach(function(dot) {
        if (dot.dataset.bound) return;
        dot.dataset.bound = '1';
        dot.addEventListener('click', function() {
          var idx = parseInt(dot.dataset.index);
          if (cards[idx]) {
            cards[idx].scrollIntoView({ behavior: 'smooth', inline: 'start', block: 'nearest' });
          }
        });
      });
    }

    setupCarousel('actionCarousel', 'actionDots');
  }

  function initPresetChips() {
    document.querySelectorAll('.action-card-v2__preset').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var input = document.getElementById('objective_title_input');
        if (input) {
          input.value = this.dataset.presetTitle;
          input.focus();
        }
      });
    });
  }

  function initAll() { initHomeCarousels(); initPresetChips(); }
  document.addEventListener('turbo:load', initAll);
  if (document.readyState !== 'loading') { initAll(); }
  else { document.addEventListener('DOMContentLoaded', initAll); }
})();
</script>
