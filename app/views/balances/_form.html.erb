<div class="app-container">
  <%= simple_form_for @balance,
        url: balance_path,
        html: { method: @balance.new_record? ? :post : :patch } do |f| %>

    <%# Title %>
    <div class="text-center mb-4">
      <h2 style="font-size: 1.25rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.5rem;"><%= t('views.balance_form.title') %></h2>
      <p class="text-muted" style="font-size: 0.875rem;">
        <%= t('views.balance_form.description') %>
        <strong><%= t('views.balance_form.note') %></strong>
      </p>
    </div>

    <% asset_fields = %w[valor_inmuebles dinero_cuenta_corriente dinero_cuenta_ahorro_depos
                         dinero_inversiones_f dinero_planes_pensiones valor_coches_vehiculos valor_otros_activos]
       debt_fields = %w[hipoteca_inmuebles deuda_tarjeta_credito prestamos_personales prestamos_coches otras_deudas]
    %>

    <%# Assets section %>
    <div class="app-form__section">
      <h3 class="app-form__section-title">
        <i class="bi bi-wallet2"></i>
        <%= t('views.balance_form.assets_section') %>
      </h3>

      <% asset_fields.each do |field| %>
        <div class="app-form__group">
          <label class="app-form__label">
            <%= t("views.balance_form.assets.#{field}") %>
            <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.75rem;" data-bs-toggle="tooltip" title="<%= t("views.balance_form.assets.#{field}_hint") %>"></i>
          </label>
          <div class="app-form__input-group">
            <%= f.input_field field,
                  type: "text",
                  class: "app-form__input euro-input",
                  placeholder: "0",
                  data: { field: field },
                  style: "text-align: right;" %>
            <span class="app-form__input-suffix">&euro;</span>
          </div>
        </div>
      <% end %>

      <div style="background: #fff; border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem;">
        <p class="text-muted mb-1" style="font-size: 0.75rem;"><%= t('views.balance_form.total_assets') %></p>
        <p class="mb-0 fw-bold text-success" id="total-assets" style="font-size: 1.125rem;">&euro;0</p>
      </div>
    </div>

    <%# Debts section %>
    <div class="app-form__section app-form__section--expenses">
      <h3 class="app-form__section-title">
        <i class="bi bi-credit-card"></i>
        <%= t('views.balance_form.debts_section') %>
      </h3>

      <% debt_fields.each do |field| %>
        <div class="app-form__group">
          <label class="app-form__label">
            <%= t("views.balance_form.debts.#{field}") %>
            <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.75rem;" data-bs-toggle="tooltip" title="<%= t("views.balance_form.debts.#{field}_hint") %>"></i>
          </label>
          <div class="app-form__input-group">
            <%= f.input_field field,
                  type: "text",
                  class: "app-form__input euro-input",
                  placeholder: "0",
                  data: { field: field },
                  style: "text-align: right;" %>
            <span class="app-form__input-suffix">&euro;</span>
          </div>
        </div>
      <% end %>

      <div style="background: #fff; border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem;">
        <p class="text-muted mb-1" style="font-size: 0.75rem;"><%= t('views.balance_form.total_debts') %></p>
        <p class="mb-0 fw-bold text-danger" id="total-liabilities" style="font-size: 1.125rem;">&euro;0</p>
      </div>
    </div>

    <%# Net worth summary %>
    <div class="app-card" style="border-left: 3px solid #165668;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <p class="text-muted mb-1" style="font-size: 0.8125rem;"><%= t('views.balance_form.net_worth_title') %></p>
          <p class="fw-bold mb-0" style="font-size: 0.9375rem;"><%= t('views.balance_form.net_worth_formula') %></p>
        </div>
        <div class="text-end">
          <p class="mb-0 fw-bold text-success" id="net-worth-amount" style="font-size: 1.25rem;">&euro;0</p>
          <small class="text-muted" id="net-worth-label"
                 data-prompt="<%= t('views.balance_form.net_worth_prompt') %>"
                 data-positive="<%= t('views.balance_form.net_worth_positive') %>"
                 data-negative="<%= t('views.balance_form.net_worth_negative') %>"
                 data-balanced="<%= t('views.balance_form.net_worth_balanced') %>">
            <%= t('views.balance_form.net_worth_prompt') %>
          </small>
        </div>
      </div>
    </div>

    <%# Submit %>
    <div style="margin-top: 1.5rem;">
      <%= f.button :submit, class: "btn-app btn-app--primary btn-app--block" do %>
        <i class="bi bi-arrow-right-circle"></i>
        <%= @balance.new_record? ? t('views.balance_form.submit_new') : t('views.balance_form.submit_update') %>
      <% end %>
    </div>

  <% end %>
</div>

<script>
function initBalanceForm() {
  // Dispose existing tooltips before re-init
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
    var existing = bootstrap.Tooltip.getInstance(el);
    if (existing) existing.dispose();
  });

  const tooltipTriggerList = [...document.querySelectorAll('[data-bs-toggle="tooltip"]')];
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

  const euroInputs = document.querySelectorAll('.euro-input');
  const totalAssetsEl = document.getElementById('total-assets');
  const totalLiabilitiesEl = document.getElementById('total-liabilities');
  const netWorthAmountEl = document.getElementById('net-worth-amount');
  const netWorthLabelEl = document.getElementById('net-worth-label');

  if (!netWorthAmountEl || !netWorthLabelEl) return;

  const labels = {
    prompt: netWorthLabelEl.dataset.prompt,
    positive: netWorthLabelEl.dataset.positive,
    negative: netWorthLabelEl.dataset.negative,
    balanced: netWorthLabelEl.dataset.balanced
  };

  function formatNumber(value) {
    if (!value || value === '0') return '0';
    let num = value.replace(/[^\d,]/g, '');
    let parts = num.split(',');
    let integerPart = parts[0];
    let decimalPart = parts[1] || '';
    integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return decimalPart ? `${integerPart},${decimalPart}` : integerPart;
  }

  function parseEuroNumber(value) {
    if (!value || value === '0' || value === '') return 0;
    const num = parseFloat(value.replace(/\./g, '').replace(',', '.'));
    return isNaN(num) ? 0 : num;
  }

  function unformatNumber(value) {
    if (!value || value === '0') return '0';
    return value.replace(/\./g, '').replace(',', '.');
  }

  function updateBalances() {
    const assetFields = [
      'valor_inmuebles', 'dinero_cuenta_corriente', 'dinero_cuenta_ahorro_depos',
      'dinero_inversiones_f', 'dinero_planes_pensiones', 'valor_coches_vehiculos',
      'valor_otros_activos'
    ];
    const liabilityFields = [
      'hipoteca_inmuebles', 'deuda_tarjeta_credito', 'prestamos_personales',
      'prestamos_coches', 'otras_deudas'
    ];

    let totalAssets = 0;
    assetFields.forEach(fieldName => {
      const input = document.querySelector(`[data-field="${fieldName}"]`);
      if (input) totalAssets += parseEuroNumber(input.value);
    });

    let totalLiabilities = 0;
    liabilityFields.forEach(fieldName => {
      const input = document.querySelector(`[data-field="${fieldName}"]`);
      if (input) totalLiabilities += parseEuroNumber(input.value);
    });

    const netWorth = totalAssets - totalLiabilities;
    const formatCurrency = (amount) => new Intl.NumberFormat('es-ES', {
      style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 2
    }).format(Math.abs(amount));

    totalAssetsEl.textContent = formatCurrency(totalAssets);
    totalLiabilitiesEl.textContent = formatCurrency(totalLiabilities);
    netWorthAmountEl.textContent = formatCurrency(netWorth);

    if (netWorth > 0) {
      netWorthAmountEl.className = 'mb-0 fw-bold text-success';
      netWorthAmountEl.style.fontSize = '1.25rem';
      netWorthLabelEl.textContent = labels.positive;
    } else if (netWorth < 0) {
      netWorthAmountEl.className = 'mb-0 fw-bold text-danger';
      netWorthAmountEl.style.fontSize = '1.25rem';
      netWorthLabelEl.textContent = labels.negative;
    } else {
      netWorthAmountEl.className = 'mb-0 fw-bold text-muted';
      netWorthAmountEl.style.fontSize = '1.25rem';
      netWorthLabelEl.textContent = labels.balanced;
    }
  }

  euroInputs.forEach(input => {
    if (input.dataset.bound) return;
    input.dataset.bound = '1';
    if (input.value && input.value !== '0') input.value = formatNumber(input.value);

    input.addEventListener('input', function(e) {
      let cursorPosition = this.selectionStart;
      let oldLength = this.value.length;
      this.value = this.value.replace(/[^\d,]/g, '');
      let parts = this.value.split(',');
      if (parts.length > 2) this.value = parts[0] + ',' + parts.slice(1).join('');
      this.value = formatNumber(this.value);
      let newLength = this.value.length;
      cursorPosition = cursorPosition + (newLength - oldLength);
      this.setSelectionRange(cursorPosition, cursorPosition);
      updateBalances();
    });

    input.addEventListener('blur', function() {
      if (!this.value || this.value === '') this.value = '0';
      updateBalances();
    });
  });

  updateBalances();

  const form = document.querySelector('form');
  if (form && !form.dataset.bound) {
    form.dataset.bound = '1';
    form.addEventListener('submit', function(e) {
      document.querySelectorAll('.euro-input').forEach(input => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = input.name;
        hiddenInput.value = unformatNumber(input.value);
        input.disabled = true;
        this.appendChild(hiddenInput);
      });
    });
  }
}
document.addEventListener('turbo:load', initBalanceForm);
if (document.readyState !== 'loading') { initBalanceForm(); } else { document.addEventListener('DOMContentLoaded', initBalanceForm); }
</script>

<style>
  .euro-input { -moz-appearance: textfield; }
  .euro-input::-webkit-outer-spin-button,
  .euro-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>
